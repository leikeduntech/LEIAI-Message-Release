'use strict';function _0x1382(_0x23c959,_0x117345){const _0x3d3acd=_0x3d3a();return _0x1382=function(_0x1382dd,_0x4d41e6){_0x1382dd=_0x1382dd-0xc8;let _0x543a7e=_0x3d3acd[_0x1382dd];return _0x543a7e;},_0x1382(_0x23c959,_0x117345);}const _0x153e30=_0x1382;function _0x3d3a(){const _0x3224c7=['createHash','digest','12255qaNfll','payWeChatNotifyUrl','mpay','__metadata','get','object','findOne','now','notify','TRANSACTION.SUCCESS','payHupi','createRandomNonceStr','resource','appid','defineProperty','message','trade_status','money','payMpayReturnUrl','HttpStatus','payEpayNotifyUrl','payMpayApiQueryUrl','PayService','getConfigs','notify_url','WxPay','payMpayNotifyUrl','param','importDynamic','payPlatform','crypto','log','trade_state','3870uzbpNz','wechat','affected','key','payEpayApiPayUrl','payEpay','sort','@nestjs/typeorm','612603TZcQZt','text','wx-native','act','h5_info','__decorate','校验签名通过','attach','17742219eVXAaT','return_url','goodsId','userBalanceService','5RSSYbQ','notifyHupi','sign','payWeChat','payMpay','post','update','failed','toString','join','../order/order.entity','data','order','payMpaySecret','payWeChatPrivateKey','支付请求失败!','queryWeChat','globalConfigService','toFixed','clientip','unsupported\x20pay\x20type','payWeChatPublicKey','version','transactions_h5','__param','pay','native','payEpaySecret','length','keys','out_trade_order','default','device','queryMpay','14217790MsuVob','payEpayReturnUrl','getOpenIdByUserId','套餐不存在!','trade_order_id','md5','payWeChatH5Name','name','epay\x20--->\x20res:\x20','订单不存在!','hupi','192.168.1.100','status:\x20','payWeChatAppId','UserBalanceService','title','__esModule','payWeChatMchId','out_trade_no','用户openId:\x20','transactions_native','payHupiReturnUrl','queryEpay','type','total_fee','198eDfbcm','@nestjs/common','addBalanceToOrder','decorate','2944252mPYINC','payer','epay','wxpay','TRADE_SUCCESS','MD5','wechatpay-node-v3','event_type','pid','../user/user.service','微信支付通知params:\x20','errRaw','payHupiNotifyUrl','OrderEntity','payHupiSecret','微信H5支付失败！','payEpayPid','SUCCESS','支付请求失败:\x20','https://api.xunhupay.com/payment/query.html','function','notifyMpay','本次支付类型:\x20','Wap','metadata','payHupiAppId','sign_type','../../common/utils','nonce_str','transactions_jsapi','../globalConfig/globalConfig.service','response','error:\x20','BAD_REQUEST','decipher_gcm','typeorm','total','InjectRepository','498ZJzmcR','15015doOmpw','Repository','success','hash','cramiPackageEntity','notifyWeChat','校验签名','userService','../crami/cramiPackage.entity','383064MveAMi','HttpException','orderEntity','time','1.1','notifyEpay'];_0x3d3a=function(){return _0x3224c7;};return _0x3d3a();}(function(_0x235149,_0x48f063){const _0x2d91c7=_0x1382,_0x3e3680=_0x235149();while(!![]){try{const _0x1b5cd0=parseInt(_0x2d91c7(0xce))/0x1+-parseInt(_0x2d91c7(0x13f))/0x2*(parseInt(_0x2d91c7(0x151))/0x3)+parseInt(_0x2d91c7(0x119))/0x4*(parseInt(_0x2d91c7(0xda))/0x5)+-parseInt(_0x2d91c7(0x172))/0x6*(-parseInt(_0x2d91c7(0x140))/0x7)+-parseInt(_0x2d91c7(0x149))/0x8*(parseInt(_0x2d91c7(0x115))/0x9)+-parseInt(_0x2d91c7(0xfc))/0xa+parseInt(_0x2d91c7(0xd6))/0xb;if(_0x1b5cd0===_0x48f063)break;else _0x3e3680['push'](_0x3e3680['shift']());}catch(_0x48a0aa){_0x3e3680['push'](_0x3e3680['shift']());}}}(_0x3d3a,0xd030e));var __decorate=this&&this[_0x153e30(0xd3)]||function(_0x48b0c5,_0x4b47b0,_0x59911e,_0x4ff7bb){const _0x3949d0=_0x153e30;var _0x59ad1a=arguments['length'],_0x1103d6=_0x59ad1a<0x3?_0x4b47b0:_0x4ff7bb===null?_0x4ff7bb=Object['getOwnPropertyDescriptor'](_0x4b47b0,_0x59911e):_0x4ff7bb,_0x142417;if(typeof Reflect==='object'&&typeof Reflect[_0x3949d0(0x118)]===_0x3949d0(0x12d))_0x1103d6=Reflect[_0x3949d0(0x118)](_0x48b0c5,_0x4b47b0,_0x59911e,_0x4ff7bb);else{for(var _0x5d25c9=_0x48b0c5[_0x3949d0(0xf6)]-0x1;_0x5d25c9>=0x0;_0x5d25c9--)if(_0x142417=_0x48b0c5[_0x5d25c9])_0x1103d6=(_0x59ad1a<0x3?_0x142417(_0x1103d6):_0x59ad1a>0x3?_0x142417(_0x4b47b0,_0x59911e,_0x1103d6):_0x142417(_0x4b47b0,_0x59911e))||_0x1103d6;}return _0x59ad1a>0x3&&_0x1103d6&&Object['defineProperty'](_0x4b47b0,_0x59911e,_0x1103d6),_0x1103d6;},__metadata=this&&this[_0x153e30(0x154)]||function(_0xeabe0b,_0xcb451b){const _0x45e554=_0x153e30;if(typeof Reflect==='object'&&typeof Reflect[_0x45e554(0x131)]==='function')return Reflect[_0x45e554(0x131)](_0xeabe0b,_0xcb451b);},__param=this&&this[_0x153e30(0xf2)]||function(_0x548a53,_0x562284){return function(_0x487a4c,_0x3f5afc){_0x562284(_0x487a4c,_0x3f5afc,_0x548a53);};};Object[_0x153e30(0x15f)](exports,_0x153e30(0x10c),{'value':!![]}),exports[_0x153e30(0x167)]=void 0x0;const typeorm_1=require(_0x153e30(0xcd)),typeorm_2=require(_0x153e30(0x13c)),common_1=require(_0x153e30(0x116)),crypto=require(_0x153e30(0x16f)),axios_1=require('axios'),order_entity_1=require(_0x153e30(0xe4)),cramiPackage_entity_1=require(_0x153e30(0x148)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x153e30(0x137)),utils_1=require(_0x153e30(0x134)),user_service_1=require(_0x153e30(0x122));let PayService=class PayService{constructor(_0x42f410,_0x5833be,_0xc878ec,_0x248682,_0x28f80f){const _0x316603=_0x153e30;this[_0x316603(0x144)]=_0x42f410,this['orderEntity']=_0x5833be,this[_0x316603(0xd9)]=_0xc878ec,this[_0x316603(0xeb)]=_0x248682,this[_0x316603(0x147)]=_0x28f80f;}async['onModuleInit'](){const _0x2b94d8=_0x153e30,_0x100402=await(0x0,utils_1[_0x2b94d8(0x16d)])(_0x2b94d8(0x11f));this['WxPay']=(_0x100402===null||_0x100402===void 0x0?void 0x0:_0x100402['default'])?_0x100402[_0x2b94d8(0xf9)]:_0x100402;}async[_0x153e30(0x159)](_0x4e81e0){const _0x3ff6b2=_0x153e30;if(_0x4e81e0['param']=='epay')return this[_0x3ff6b2(0x14e)](_0x4e81e0);if(_0x4e81e0[_0x3ff6b2(0xd5)]==_0x3ff6b2(0x106))return this[_0x3ff6b2(0xdb)](_0x4e81e0);if(typeof _0x4e81e0[_0x3ff6b2(0x15d)]==_0x3ff6b2(0x156))return this['notifyWeChat'](_0x4e81e0);return this[_0x3ff6b2(0x12e)](_0x4e81e0);}async[_0x153e30(0xf3)](_0x1337db,_0x1f1a98,_0x18c95b=_0x153e30(0x11c)){const _0x12a1f0=_0x153e30,_0x135d9d=await this[_0x12a1f0(0x14b)][_0x12a1f0(0x157)]({'where':{'userId':_0x1337db,'orderId':_0x1f1a98}});if(!_0x135d9d)throw new common_1['HttpException'](_0x12a1f0(0x105),common_1[_0x12a1f0(0x164)][_0x12a1f0(0x13a)]);const _0x406f28=await this[_0x12a1f0(0x144)][_0x12a1f0(0x157)]({'where':{'id':_0x135d9d[_0x12a1f0(0xd8)]}});if(!_0x406f28)throw new common_1['HttpException'](_0x12a1f0(0xff),common_1[_0x12a1f0(0x164)][_0x12a1f0(0x13a)]);console['log'](_0x12a1f0(0x12f),_0x135d9d[_0x12a1f0(0x16e)]);try{if(_0x135d9d[_0x12a1f0(0x16e)]==_0x12a1f0(0x173))return this['payWeChat'](_0x1337db,_0x1f1a98,_0x18c95b);if(_0x135d9d[_0x12a1f0(0x16e)]=='epay')return this[_0x12a1f0(0xcb)](_0x1337db,_0x1f1a98,_0x18c95b);if(_0x135d9d[_0x12a1f0(0x16e)]==_0x12a1f0(0x153))return this[_0x12a1f0(0xde)](_0x1337db,_0x1f1a98,_0x18c95b);if(_0x135d9d[_0x12a1f0(0x16e)]=='hupi')return this[_0x12a1f0(0x15b)](_0x1337db,_0x1f1a98,_0x18c95b);}catch(_0xab1873){console[_0x12a1f0(0x170)](_0x12a1f0(0x12b),_0xab1873);throw new common_1['HttpException'](_0x12a1f0(0xe9),common_1[_0x12a1f0(0x164)][_0x12a1f0(0x13a)]);}}async['query'](_0x4c3ea7){const _0xda4dfc=_0x153e30,_0x113197=await this[_0xda4dfc(0x14b)][_0xda4dfc(0x157)]({'where':{'orderId':_0x4c3ea7}});if(!_0x113197)throw new common_1[(_0xda4dfc(0x14a))](_0xda4dfc(0x105),common_1[_0xda4dfc(0x164)]['BAD_REQUEST']);return _0x113197;}async[_0x153e30(0xdb)](_0x5b1ce8){const _0x51bcb7=_0x153e30,_0x5c4b4c=await this[_0x51bcb7(0xeb)][_0x51bcb7(0x168)]([_0x51bcb7(0x127)]),_0x4d2828=_0x5b1ce8[_0x51bcb7(0x143)];delete _0x5b1ce8[_0x51bcb7(0x143)];if(this[_0x51bcb7(0xdc)](_0x5b1ce8,_0x5c4b4c)!=_0x4d2828)return _0x51bcb7(0xe1);const _0x9812c5=await this[_0x51bcb7(0x14b)][_0x51bcb7(0x157)]({'where':{'orderId':_0x5b1ce8[_0x51bcb7(0x100)],'status':0x0}});if(!_0x9812c5)return _0x51bcb7(0xe1);await this['userBalanceService'][_0x51bcb7(0x117)](_0x9812c5);const _0x27d2bc=await this[_0x51bcb7(0x14b)][_0x51bcb7(0xe0)]({'orderId':_0x5b1ce8[_0x51bcb7(0x100)]},{'status':0x1,'paydAt':new Date()});if(_0x27d2bc[_0x51bcb7(0xc8)]!=0x1)return _0x51bcb7(0xe1);return _0x51bcb7(0x142);}async[_0x153e30(0x15b)](_0xf48332,_0x21cf8e,_0x29c678=_0x153e30(0x11c)){const _0x55beb0=_0x153e30,_0x49e15b=await this[_0x55beb0(0x14b)][_0x55beb0(0x157)]({'where':{'userId':_0xf48332,'orderId':_0x21cf8e}});if(!_0x49e15b)throw new common_1['HttpException'](_0x55beb0(0x105),common_1[_0x55beb0(0x164)][_0x55beb0(0x13a)]);const _0x153b60=await this[_0x55beb0(0x144)]['findOne']({'where':{'id':_0x49e15b[_0x55beb0(0xd8)]}});if(!_0x153b60)throw new common_1[(_0x55beb0(0x14a))](_0x55beb0(0xff),common_1[_0x55beb0(0x164)][_0x55beb0(0x13a)]);const {payHupiAppId:_0x2c3fcf,payHupiSecret:_0x388205,payHupiNotifyUrl:_0x8ff6e3,payHupiReturnUrl:_0x3abcaa}=await this[_0x55beb0(0xeb)][_0x55beb0(0x168)]([_0x55beb0(0x132),_0x55beb0(0x127),_0x55beb0(0x125),_0x55beb0(0x111)]),_0x1da78d={};_0x1da78d[_0x55beb0(0xf0)]='1.1',_0x1da78d[_0x55beb0(0x15e)]=_0x2c3fcf,_0x1da78d[_0x55beb0(0x14c)]=(Date[_0x55beb0(0x158)]()/0x3e8)[_0x55beb0(0xec)](0x0),_0x1da78d[_0x55beb0(0x135)]=(0x0,utils_1[_0x55beb0(0x15c)])(0x20),_0x1da78d['trade_order_id']=_0x21cf8e,_0x1da78d[_0x55beb0(0x10b)]=_0x153b60['name'],_0x1da78d[_0x55beb0(0x114)]=_0x49e15b[_0x55beb0(0x13d)],_0x1da78d[_0x55beb0(0x169)]=_0x8ff6e3,_0x1da78d[_0x55beb0(0xd7)]=_0x3abcaa,_0x1da78d['attach']=_0x55beb0(0x106),_0x1da78d['hash']=this[_0x55beb0(0xdc)](_0x1da78d,_0x388205);const {data:{errcode:_0x5742af,errmsg:_0x1887ac,url_qrcode:_0x55125e,url:_0x1728c8}}=await axios_1[_0x55beb0(0xf9)]['post']('https://api.xunhupay.com/payment/do.html',_0x1da78d);if(_0x5742af!=0x0)throw new common_1[(_0x55beb0(0x14a))](_0x1887ac,common_1['HttpStatus']['BAD_REQUEST']);return{'url_qrcode':_0x55125e,'url':_0x1728c8};}async['queryHupi'](_0x78fdc1){const _0x18fc0c=_0x153e30,{payHupiAppId:_0x1c5c63,payHupiSecret:_0x59ca9b}=await this[_0x18fc0c(0xeb)]['getConfigs']([_0x18fc0c(0x132),_0x18fc0c(0x127)]),_0x16e3b1={};_0x16e3b1[_0x18fc0c(0xf0)]=_0x18fc0c(0x14d),_0x16e3b1[_0x18fc0c(0x15e)]=_0x1c5c63,_0x16e3b1[_0x18fc0c(0x14c)]=(Date[_0x18fc0c(0x158)]()/0x3e8)[_0x18fc0c(0xec)](0x0),_0x16e3b1[_0x18fc0c(0x135)]=(0x0,utils_1['createRandomNonceStr'])(0x20),_0x16e3b1[_0x18fc0c(0xf8)]=_0x78fdc1,_0x16e3b1[_0x18fc0c(0x143)]=this[_0x18fc0c(0xdc)](_0x16e3b1,_0x59ca9b);const {data:{errcode:_0x316a5d,errmsg:_0x983890,data:_0x18d77a}}=await axios_1['default'][_0x18fc0c(0xdf)](_0x18fc0c(0x12c),_0x16e3b1);if(_0x316a5d!=0x0)throw new common_1['HttpException'](_0x983890,common_1[_0x18fc0c(0x164)][_0x18fc0c(0x13a)]);return _0x18d77a;}async[_0x153e30(0x14e)](_0x44c0b2){const _0x5e36c7=_0x153e30,_0x371e84=_0x44c0b2[_0x5e36c7(0xdc)];delete _0x44c0b2[_0x5e36c7(0xdc)],delete _0x44c0b2[_0x5e36c7(0x133)];const _0x4c2c47=await this['globalConfigService'][_0x5e36c7(0x168)]([_0x5e36c7(0xf5)]);if(this['sign'](_0x44c0b2,_0x4c2c47)!=_0x371e84)return _0x5e36c7(0xe1);console[_0x5e36c7(0x170)](_0x5e36c7(0xd4));const _0x20539e=await this['orderEntity']['findOne']({'where':{'orderId':_0x44c0b2[_0x5e36c7(0x10e)],'status':0x0}});if(!_0x20539e)return _0x5e36c7(0xe1);const _0x49586b=_0x44c0b2[_0x5e36c7(0x161)]==_0x5e36c7(0x11d)?0x1:0x2,_0xa97302=await this[_0x5e36c7(0x14b)][_0x5e36c7(0xe0)]({'orderId':_0x44c0b2[_0x5e36c7(0x10e)]},{'status':_0x49586b,'paydAt':new Date()});_0x49586b===0x1&&await this[_0x5e36c7(0xd9)][_0x5e36c7(0x117)](_0x20539e);if(_0xa97302[_0x5e36c7(0xc8)]!=0x1)return _0x5e36c7(0xe1);return _0x5e36c7(0x142);}async[_0x153e30(0xcb)](_0x4a52be,_0x15c647,_0x4e5a0d='alipay'){const _0x84ee8b=_0x153e30,_0x383128=await this['orderEntity'][_0x84ee8b(0x157)]({'where':{'userId':_0x4a52be,'orderId':_0x15c647}});if(!_0x383128)throw new common_1['HttpException'](_0x84ee8b(0x105),common_1['HttpStatus']['BAD_REQUEST']);const _0xfc2706=await this[_0x84ee8b(0x144)]['findOne']({'where':{'id':_0x383128[_0x84ee8b(0xd8)]}});if(!_0xfc2706)throw new common_1[(_0x84ee8b(0x14a))]('套餐不存在!',common_1[_0x84ee8b(0x164)][_0x84ee8b(0x13a)]);const {payEpayPid:_0x2f767d,payEpaySecret:_0xf51fbd,payEpayNotifyUrl:_0x44d0c6,payEpayReturnUrl:_0x2cafad,payEpayApiPayUrl:_0x5a1bec}=await this[_0x84ee8b(0xeb)][_0x84ee8b(0x168)](['payEpayPid',_0x84ee8b(0xf5),_0x84ee8b(0x165),_0x84ee8b(0xfd),_0x84ee8b(0xca)]);let _0x49e210;_0x2f767d[_0x84ee8b(0xf6)]<=0x10?_0x49e210=Number(_0x2f767d):_0x49e210=BigInt(_0x2f767d);const _0x1605d4={};_0x1605d4['pid']=_0x49e210,_0x1605d4[_0x84ee8b(0x113)]=_0x4e5a0d,_0x1605d4[_0x84ee8b(0x10e)]=_0x15c647,_0x1605d4[_0x84ee8b(0x103)]=_0xfc2706[_0x84ee8b(0x103)],_0x1605d4[_0x84ee8b(0x162)]=_0x383128[_0x84ee8b(0x13d)],_0x1605d4[_0x84ee8b(0xed)]=_0x84ee8b(0x107),_0x1605d4[_0x84ee8b(0xfa)]='pc',_0x1605d4[_0x84ee8b(0x169)]=_0x44d0c6,_0x1605d4['return_url']=_0x2cafad,_0x1605d4[_0x84ee8b(0x16c)]=_0x84ee8b(0x11b),_0x1605d4[_0x84ee8b(0xdc)]=this[_0x84ee8b(0xdc)](_0x1605d4,_0xf51fbd),_0x1605d4[_0x84ee8b(0x133)]=_0x84ee8b(0x11e);const _0x1ff3c8=new URLSearchParams(_0x1605d4)[_0x84ee8b(0xe2)](),_0x44fd9c=_0x5a1bec+'?'+_0x1ff3c8;if(_0x5a1bec['includes']('submit.php'))return{'url_qrcode':null,'redirectUrl':_0x44fd9c,'channel':_0x4e5a0d,'isRedirect':!![]};else{const _0x249555=await axios_1[_0x84ee8b(0xf9)][_0x84ee8b(0x155)](_0x5a1bec,{'params':_0x1605d4});console[_0x84ee8b(0x170)](_0x84ee8b(0x104),_0x249555[_0x84ee8b(0xe5)]);const {data:{code:_0x2a1099,msg:_0x48c402,qrcode:_0x3f19c5}}=_0x249555;if(_0x2a1099!=0x1)throw new common_1[(_0x84ee8b(0x14a))](_0x48c402,common_1[_0x84ee8b(0x164)][_0x84ee8b(0x13a)]);return{'url_qrcode':_0x3f19c5,'redirectUrl':null,'channel':_0x4e5a0d,'isRedirect':![]};}}async[_0x153e30(0x112)](_0x1e7704){const _0x32ca76=_0x153e30,{payEpayPid:_0x365b65,payEpaySecret:_0x3015b8,payEpayApiQueryUrl:_0x2a0cff}=await this['globalConfigService'][_0x32ca76(0x168)]([_0x32ca76(0x129),_0x32ca76(0xf5),'payEpayApiQueryUrl']),_0x36762b={};_0x36762b[_0x32ca76(0xd1)]=_0x32ca76(0xe6),_0x36762b[_0x32ca76(0x10e)]=_0x1e7704,_0x36762b[_0x32ca76(0x121)]=_0x365b65,_0x36762b[_0x32ca76(0xc9)]=_0x3015b8;const {data:{code:_0x6a488d,msg:_0x2cb220,data:_0x38085d}}=await axios_1[_0x32ca76(0xf9)][_0x32ca76(0x155)](_0x2a0cff,{'params':_0x36762b});if(_0x6a488d!=0x1)throw new common_1[(_0x32ca76(0x14a))](_0x2cb220,common_1[_0x32ca76(0x164)]['BAD_REQUEST']);return _0x38085d;}async[_0x153e30(0x12e)](_0x16e719){const _0x45777d=_0x153e30,_0x1630f6=_0x16e719[_0x45777d(0xdc)];delete _0x16e719[_0x45777d(0xdc)],delete _0x16e719[_0x45777d(0x133)];const _0x57c9e1=await this[_0x45777d(0xeb)][_0x45777d(0x168)]([_0x45777d(0xe7)]);console[_0x45777d(0x170)](_0x45777d(0x146));if(this[_0x45777d(0xdc)](_0x16e719,_0x57c9e1)!=_0x1630f6)return'failed';console[_0x45777d(0x170)](_0x45777d(0xd4));const _0x2a07dd=await this[_0x45777d(0x14b)]['findOne']({'where':{'orderId':_0x16e719[_0x45777d(0x10e)],'status':0x0}});if(!_0x2a07dd)return'failed';const _0x1848f8=_0x16e719['trade_status']=='TRADE_SUCCESS'?0x1:0x2;console[_0x45777d(0x170)](_0x45777d(0x108),_0x1848f8);const _0x3e45bd=await this[_0x45777d(0x14b)][_0x45777d(0xe0)]({'orderId':_0x16e719['out_trade_no']},{'status':_0x1848f8,'paydAt':new Date()});_0x1848f8===0x1&&await this['userBalanceService'][_0x45777d(0x117)](_0x2a07dd);if(_0x3e45bd[_0x45777d(0xc8)]!=0x1)return _0x45777d(0xe1);return _0x45777d(0x142);}async[_0x153e30(0xde)](_0x3d4c1f,_0x1809bc,_0x1c3c80='wxpay'){const _0x38abc4=_0x153e30,_0x4fe039=await this[_0x38abc4(0x14b)][_0x38abc4(0x157)]({'where':{'userId':_0x3d4c1f,'orderId':_0x1809bc}});if(!_0x4fe039)throw new common_1[(_0x38abc4(0x14a))](_0x38abc4(0x105),common_1['HttpStatus']['BAD_REQUEST']);const _0x47f71d=await this[_0x38abc4(0x144)][_0x38abc4(0x157)]({'where':{'id':_0x4fe039[_0x38abc4(0xd8)]}});if(!_0x47f71d)throw new common_1['HttpException']('套餐不存在!',common_1[_0x38abc4(0x164)][_0x38abc4(0x13a)]);const {payMpayPid:_0x67af96,payMpaySecret:_0x5236ef,payMpayNotifyUrl:_0x184853,payMpayReturnUrl:_0x4378bd,payMpayApiPayUrl:_0x4c0784}=await this[_0x38abc4(0xeb)][_0x38abc4(0x168)](['payMpayPid',_0x38abc4(0xe7),_0x38abc4(0x16b),_0x38abc4(0x163),'payMpayApiPayUrl']),_0x4ee240={};_0x4ee240['pid']=Number(_0x67af96),_0x4ee240['type']=_0x1c3c80,_0x4ee240[_0x38abc4(0x10e)]=_0x1809bc,_0x4ee240['name']=_0x47f71d[_0x38abc4(0x103)],_0x4ee240[_0x38abc4(0x162)]=_0x4fe039[_0x38abc4(0x13d)],_0x4ee240[_0x38abc4(0x169)]=_0x184853,_0x4ee240[_0x38abc4(0xd7)]=_0x4378bd,_0x4ee240['sign']=this['sign'](_0x4ee240,_0x5236ef),_0x4ee240[_0x38abc4(0x133)]=_0x38abc4(0x11e);const _0x3d5bbc=new URLSearchParams(_0x4ee240)['toString'](),_0x50f3d5=_0x4c0784+'?'+_0x3d5bbc;return{'url_qrcode':null,'redirectUrl':_0x50f3d5,'channel':_0x1c3c80,'isRedirect':!![]};const _0x34d9b7=await axios_1[_0x38abc4(0xf9)][_0x38abc4(0x155)](_0x4c0784,{'params':_0x4ee240});}async[_0x153e30(0xfb)](_0x186189){const _0xbb0ba3=_0x153e30,{payMpayApiQueryUrl:_0x2c9cb4}=await this['globalConfigService']['getConfigs'](['payMpayPid',_0xbb0ba3(0xe7),_0xbb0ba3(0x166)]),_0x5199fb={};_0x5199fb[_0xbb0ba3(0x113)]=0x2,_0x5199fb['order_no']=_0x186189;const {data:{code:_0x3cf3d2,msg:_0x50e4cf,data:_0x2455bc}}=await axios_1['default'][_0xbb0ba3(0x155)](_0x2c9cb4,{'params':_0x5199fb});if(_0x3cf3d2!=0x1)throw new common_1[(_0xbb0ba3(0x14a))](_0x50e4cf,common_1[_0xbb0ba3(0x164)][_0xbb0ba3(0x13a)]);return _0x2455bc;}async[_0x153e30(0x145)](_0xa9880d){const _0x4a0c12=_0x153e30;console['log'](_0x4a0c12(0x123),_0xa9880d);const {payWeChatAppId:_0x41ea97,payWeChatMchId:_0x39fa9f,payWeChatSecret:_0x2954fa,payWeChatPublicKey:_0x3def71,payWeChatPrivateKey:_0xd3f45b}=await this[_0x4a0c12(0xeb)][_0x4a0c12(0x168)]([_0x4a0c12(0x109),_0x4a0c12(0x10d),'payWeChatSecret',_0x4a0c12(0xef),'payWeChatPrivateKey']),_0xef361f=new this[(_0x4a0c12(0x16a))]({'appid':_0x41ea97,'mchid':_0x39fa9f,'publicKey':_0x3def71,'privateKey':_0xd3f45b});try{if(_0xa9880d[_0x4a0c12(0x120)]==_0x4a0c12(0x15a)){const {ciphertext:_0x5190f9,associated_data:_0x491a91,nonce:_0x511c05}=_0xa9880d[_0x4a0c12(0x15d)],_0x15f082=_0xef361f[_0x4a0c12(0x13b)](_0x5190f9,_0x491a91,_0x511c05,_0x2954fa),_0x1c6d0a=await this[_0x4a0c12(0x14b)][_0x4a0c12(0x157)]({'where':{'orderId':_0x15f082['out_trade_no'],'status':0x0}});if(!_0x1c6d0a)return'failed';const _0x4e60cd=_0x15f082[_0x4a0c12(0x171)]==_0x4a0c12(0x12a)?0x1:0x2,_0x246e19=await this[_0x4a0c12(0x14b)][_0x4a0c12(0xe0)]({'orderId':_0x15f082[_0x4a0c12(0x10e)]},{'status':_0x4e60cd,'paydAt':new Date()});_0x4e60cd===0x1&&await this['userBalanceService'][_0x4a0c12(0x117)](_0x1c6d0a);if(_0x246e19[_0x4a0c12(0xc8)]!=0x1)return'failed';}return _0x4a0c12(0x142);}catch(_0x15fe60){return console['log'](_0x4a0c12(0x139),_0x15fe60),console[_0x4a0c12(0x170)]('支付通知验证失败:\x20',_0x15fe60),'failed';}}async[_0x153e30(0xdd)](_0x245cfc,_0x5351dc,_0x3b17b8=_0x153e30(0xf4)){const _0x33bcc7=_0x153e30;var _0x47980e,_0x5d17a6,_0xc19afe;console['log']('payType:\x20',_0x3b17b8);const _0x5798a8=await this[_0x33bcc7(0x14b)]['findOne']({'where':{'userId':_0x245cfc,'orderId':_0x5351dc}});if(!_0x5798a8)throw new common_1['HttpException'](_0x33bcc7(0x105),common_1[_0x33bcc7(0x164)][_0x33bcc7(0x13a)]);const _0x51ef63=await this[_0x33bcc7(0x144)][_0x33bcc7(0x157)]({'where':{'id':_0x5798a8[_0x33bcc7(0xd8)]}});if(!_0x51ef63)throw new common_1[(_0x33bcc7(0x14a))](_0x33bcc7(0xff),common_1[_0x33bcc7(0x164)][_0x33bcc7(0x13a)]);const {payWeChatAppId:_0x5f1d36,payWeChatMchId:_0xfe497b,payWeChatPublicKey:_0x165c9c,payWeChatPrivateKey:_0x15ea4e,payWeChatNotifyUrl:_0x5b4e17,payWeChatH5Name:_0x5617d3,payWeChatH5Url:_0x32afea}=await this['globalConfigService'][_0x33bcc7(0x168)]([_0x33bcc7(0x109),_0x33bcc7(0x10d),'payWeChatPublicKey',_0x33bcc7(0xe8),_0x33bcc7(0x152),_0x33bcc7(0x102),'payWeChatH5Url']),_0x1864b4=new this[(_0x33bcc7(0x16a))]({'appid':_0x5f1d36,'mchid':_0xfe497b,'publicKey':_0x165c9c,'privateKey':_0x15ea4e}),_0x1afe20={'appid':_0x5f1d36,'mchid':_0xfe497b,'description':_0x51ef63[_0x33bcc7(0x103)],'out_trade_no':_0x5351dc,'notify_url':_0x5b4e17,'amount':{'total':Number(_0x5798a8[_0x33bcc7(0x13d)]*0x64)},'scene_info':{'payer_client_ip':_0x33bcc7(0x107)}};console[_0x33bcc7(0x170)]('wechat-pay:\x20',_0x1afe20);if(_0x3b17b8=='h5'){_0x1afe20['scene_info'][_0x33bcc7(0xd2)]={'type':_0x33bcc7(0x130),'app_name':_0x5617d3,'app_url':_0x32afea};const _0x3e1282=await _0x1864b4[_0x33bcc7(0xf1)](_0x1afe20);if(_0x3e1282['status']===0x193){const _0x2538cf=(_0xc19afe=(_0x5d17a6=(_0x47980e=_0x3e1282===null||_0x3e1282===void 0x0?void 0x0:_0x3e1282[_0x33bcc7(0x124)])===null||_0x47980e===void 0x0?void 0x0:_0x47980e[_0x33bcc7(0x138)])===null||_0x5d17a6===void 0x0?void 0x0:_0x5d17a6[_0x33bcc7(0xcf)])===null||_0xc19afe===void 0x0?void 0x0:_0xc19afe[_0x33bcc7(0x160)];throw new common_1[(_0x33bcc7(0x14a))]((_0x3e1282===null||_0x3e1282===void 0x0?void 0x0:_0x3e1282[_0x33bcc7(0x160)])||_0x33bcc7(0x128),common_1[_0x33bcc7(0x164)][_0x33bcc7(0x13a)]);}const {h5_url:_0x124c58}=_0x3e1282;return{'url':_0x124c58};}if(_0x3b17b8=='jsapi'){const _0x21cada=await this['userService'][_0x33bcc7(0xfe)](_0x245cfc);console[_0x33bcc7(0x170)](_0x33bcc7(0x10f),_0x21cada),_0x1afe20[_0x33bcc7(0x11a)]={'openid':_0x21cada};const _0x329f44=await _0x1864b4[_0x33bcc7(0x136)](_0x1afe20);return console[_0x33bcc7(0x170)]('jsapi支付结果返回值:\x20',_0x329f44),_0x329f44;}if(_0x3b17b8=='native'){const _0x32980c=await _0x1864b4[_0x33bcc7(0x110)](_0x1afe20),{code_url:_0x459b3b}=_0x32980c;return!_0x459b3b&&console[_0x33bcc7(0x170)](_0x33bcc7(0xd0),_0x32980c),{'url_qrcode':_0x459b3b,'isRedirect':![]};}throw new common_1[(_0x33bcc7(0x14a))](_0x33bcc7(0xee),common_1['HttpStatus'][_0x33bcc7(0x13a)]);}async[_0x153e30(0xea)](_0xb0f54a){const _0x35d290=_0x153e30,{payWeChatAppId:_0x121228,payWeChatMchId:_0x109164,payWeChatPublicKey:_0x3271f2,payWeChatPrivateKey:_0x50c7c0,payWeChatNotifyUrl:_0x2c6286,payWeChatH5Name:_0xf3eb4e,payWeChatH5Url:_0x4e2875}=await this[_0x35d290(0xeb)]['getConfigs']([_0x35d290(0x109),_0x35d290(0x10d),'payWeChatPublicKey',_0x35d290(0xe8)]),_0x45fd41=new this[(_0x35d290(0x16a))]({'appid':_0x121228,'mchid':_0x109164,'publicKey':_0x3271f2,'privateKey':_0x50c7c0}),_0x41cfb2=await _0x45fd41['query']({'out_trade_no':_0xb0f54a});return _0x41cfb2;}[_0x153e30(0xdc)](_0x4d2d66,_0x351fd2){const _0x57e93e=_0x153e30,_0x11f083=Object[_0x57e93e(0xf7)](_0x4d2d66)[_0x57e93e(0xcc)]()['map'](_0x5af48a=>_0x5af48a+'='+_0x4d2d66[_0x5af48a])[_0x57e93e(0xe3)]('&')+_0x351fd2;return crypto[_0x57e93e(0x14f)](_0x57e93e(0x101))['update'](_0x11f083)[_0x57e93e(0x150)]('hex');}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x153e30(0x13e)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x1,(0x0,typeorm_1[_0x153e30(0x13e)])(order_entity_1[_0x153e30(0x126)])),__metadata('design:paramtypes',[typeorm_2[_0x153e30(0x141)],typeorm_2[_0x153e30(0x141)],userBalance_service_1[_0x153e30(0x10a)],globalConfig_service_1['GlobalConfigService'],user_service_1['UserService']])],PayService),exports[_0x153e30(0x167)]=PayService;