'use strict';const _0x1528f8=_0x1c8b;(function(_0xfba792,_0x49875d){const _0x554104=_0x1c8b,_0x3e0bc5=_0xfba792();while(!![]){try{const _0x22e360=-parseInt(_0x554104(0x18c))/0x1+parseInt(_0x554104(0x169))/0x2+-parseInt(_0x554104(0x1d6))/0x3+parseInt(_0x554104(0x1da))/0x4+parseInt(_0x554104(0x178))/0x5+-parseInt(_0x554104(0x177))/0x6*(parseInt(_0x554104(0x187))/0x7)+parseInt(_0x554104(0x1c3))/0x8;if(_0x22e360===_0x49875d)break;else _0x3e0bc5['push'](_0x3e0bc5['shift']());}catch(_0x5d103e){_0x3e0bc5['push'](_0x3e0bc5['shift']());}}}(_0x44fb,0x9a66c));function _0x44fb(){const _0x11fbf1=['getDate','countChats','defineProperty','PAINT_TYPE','getChatStatistic','chatLog.type\x20=\x20:type','__decorate','countDrawsByTimeRange','midjourney.createdAt\x20<\x20:tomorrow','countDraws','user.createdAt\x20>=\x20:today','countMjDrawsByTimeRange','getBaseStatistic','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','design:paramtypes','countNewOrdersToday','获取百度统计数据失败','countUsers','baiduSiteId','data','midjourneyEntity','../../common/constants/balance.constant','andWhere','decorate','chatLog.createdAt\x20<\x20:tomorrow','date','chatlog.createdAt\x20>=\x20:startDate','Repository','chatLogEntity','chatlog.type\x20=\x20:type','ChatLogEntity','baiduToken','HttpException','../midjourney/midjourney.entity','configEntity','length','order','OrderEntity','@nestjs/common','find','getOwnPropertyDescriptor','请先配置百度统计siteId','chatlog','getBaiduVisit','../chatLog/chatLog.entity','@nestjs/typeorm','16029368OPACjl','function','ConfigEntity','getBaiduStatistics','push','user.createdAt\x20<\x20:tomorrow','MidjourneyEntity','请先配置百度统计accessToken','midjourney','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','orderEntity','midjourney.status\x20=\x20:status','countNewUsersToday','map','Injectable','userEntity','InjectRepository','CHAT_TYPE','object','2140515nIcWjh','value','getCount','getTime','968660eOPIhX','createQueryBuilder','&method=','where','groupBy','M.DD','typeorm','456044FVKgEH','select','configVal','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','&site_id=','now','__param','countNewChatsToday','setHours','countOrders','countNewDrawsToday','configKey','BAD_REQUEST','DeductionKey','3113430kfdcee','2899255mmeKCS','default','countChatsByTimeRange','MidjourneyStatusEnum','overview/getTimeTrendRpt','YYYYMMDD','DRAWED','metadata','formatDate','count','__metadata','../globalConfig/config.entity','setDate','../order/order.entity','../user/user.entity','7PhXKCR','&end_date=','HttpStatus','百度授权码过期','orderBy','1188871uGfXhm','user','result','getRawMany','order.createdAt\x20>=\x20:today','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','axios','&metrics=','StatisticService'];_0x44fb=function(){return _0x11fbf1;};return _0x44fb();}var __decorate=this&&this[_0x1528f8(0x19b)]||function(_0x5dba06,_0x497c26,_0x1639ae,_0x6c1bfe){const _0x463aa0=_0x1528f8;var _0x11348f=arguments[_0x463aa0(0x1b8)],_0x14aea0=_0x11348f<0x3?_0x497c26:_0x6c1bfe===null?_0x6c1bfe=Object[_0x463aa0(0x1bd)](_0x497c26,_0x1639ae):_0x6c1bfe,_0x61c741;if(typeof Reflect===_0x463aa0(0x1d5)&&typeof Reflect[_0x463aa0(0x1ac)]==='function')_0x14aea0=Reflect['decorate'](_0x5dba06,_0x497c26,_0x1639ae,_0x6c1bfe);else{for(var _0x5e5cc4=_0x5dba06[_0x463aa0(0x1b8)]-0x1;_0x5e5cc4>=0x0;_0x5e5cc4--)if(_0x61c741=_0x5dba06[_0x5e5cc4])_0x14aea0=(_0x11348f<0x3?_0x61c741(_0x14aea0):_0x11348f>0x3?_0x61c741(_0x497c26,_0x1639ae,_0x14aea0):_0x61c741(_0x497c26,_0x1639ae))||_0x14aea0;}return _0x11348f>0x3&&_0x14aea0&&Object[_0x463aa0(0x197)](_0x497c26,_0x1639ae,_0x14aea0),_0x14aea0;},__metadata=this&&this[_0x1528f8(0x182)]||function(_0x33b4f6,_0x4edda6){const _0x3b43b6=_0x1528f8;if(typeof Reflect===_0x3b43b6(0x1d5)&&typeof Reflect[_0x3b43b6(0x17f)]===_0x3b43b6(0x1c4))return Reflect['metadata'](_0x33b4f6,_0x4edda6);},__param=this&&this[_0x1528f8(0x16f)]||function(_0x4993ff,_0x57f102){return function(_0x13aef3,_0x1f7ffd){_0x57f102(_0x13aef3,_0x1f7ffd,_0x4993ff);};};Object[_0x1528f8(0x197)](exports,'__esModule',{'value':!![]}),exports[_0x1528f8(0x194)]=void 0x0;const common_1=require(_0x1528f8(0x1bb)),typeorm_1=require(_0x1528f8(0x1c2)),user_entity_1=require(_0x1528f8(0x186)),typeorm_2=require(_0x1528f8(0x1e0)),chatLog_entity_1=require(_0x1528f8(0x1c1)),balance_constant_1=require(_0x1528f8(0x1aa)),date_1=require('../../common/utils/date'),axios_1=require(_0x1528f8(0x192)),config_entity_1=require(_0x1528f8(0x183)),order_entity_1=require(_0x1528f8(0x185)),midjourney_entity_1=require(_0x1528f8(0x1b6)),midjourney_constant_1=require('../../common/constants/midjourney.constant');function _0x1c8b(_0x1dd6ba,_0x5b7bcf){const _0x44fb70=_0x44fb();return _0x1c8b=function(_0x1c8be0,_0x2447f0){_0x1c8be0=_0x1c8be0-0x169;let _0x3f8e59=_0x44fb70[_0x1c8be0];return _0x3f8e59;},_0x1c8b(_0x1dd6ba,_0x5b7bcf);}let StatisticService=class StatisticService{constructor(_0x2a46c9,_0x451e38,_0x4b864f,_0x36a308,_0x5b4cdb){const _0x3c79c6=_0x1528f8;this[_0x3c79c6(0x1d2)]=_0x2a46c9,this['chatLogEntity']=_0x451e38,this[_0x3c79c6(0x1b7)]=_0x4b864f,this[_0x3c79c6(0x1cd)]=_0x36a308,this['midjourneyEntity']=_0x5b4cdb;}async[_0x1528f8(0x1a1)](){const _0x45f88c=_0x1528f8,_0xa920b4=await this[_0x45f88c(0x1a6)](),_0x1c573f=await this[_0x45f88c(0x1cf)](),_0x82a589=await this['countChats'](),_0x5a8830=await this['countNewChatsToday'](),_0x2ad2ad=await this[_0x45f88c(0x19e)](),_0x810ea0=await this[_0x45f88c(0x173)](),_0x1e7e57=await this['countNewMidhourneysToday'](),_0x23726d=await this[_0x45f88c(0x172)](),_0x15f05d=await this[_0x45f88c(0x1a4)]();return{'userCount':_0xa920b4,'newUserCount':_0x1c573f,'chatCount':_0x82a589,'newChatCount':_0x5a8830,'drawCount':_0x2ad2ad,'newDrawCount':_0x1e7e57+_0x810ea0,'orderCount':_0x23726d,'newOrderCount':_0x15f05d};}async[_0x1528f8(0x199)]({days:days=0x7}){const _0x1ebab4=_0x1528f8,_0x35ceef=await this[_0x1ebab4(0x17a)](days),_0x3e094a=await this[_0x1ebab4(0x19c)](days),_0x2c42e1=await this[_0x1ebab4(0x1a0)](days);return{'date':_0x35ceef[_0x1ebab4(0x1d0)](_0x25c426=>_0x25c426[_0x1ebab4(0x1ae)]),'chat':_0x35ceef[_0x1ebab4(0x1d0)](_0x499c96=>_0x499c96[_0x1ebab4(0x1d7)]),'draw':_0x3e094a[_0x1ebab4(0x1d0)]((_0x5d3d9a,_0x3d24b0)=>{const _0x331efc=_0x1ebab4;return _0x5d3d9a[_0x331efc(0x1d7)]+_0x2c42e1[_0x3d24b0][_0x331efc(0x1d7)];})};}async[_0x1528f8(0x1c0)]({days:days=0x7}){const _0x2e20b7=_0x1528f8,_0x113258=await this[_0x2e20b7(0x1c6)](days);return _0x113258;}async[_0x1528f8(0x1a6)](){const _0x280c6c=_0x1528f8,_0x343a4d=await this[_0x280c6c(0x1d2)]['count']();return _0x343a4d;}async[_0x1528f8(0x1cf)](){const _0x2f9c6b=_0x1528f8,_0x594490=new Date();_0x594490[_0x2f9c6b(0x171)](0x0,0x0,0x0,0x0);const _0x1a2ab6=new Date(_0x594490[_0x2f9c6b(0x1d9)]()+0x18*0x3c*0x3c*0x3e8),_0x2269e1=this[_0x2f9c6b(0x1d2)][_0x2f9c6b(0x1db)](_0x2f9c6b(0x18d)),_0x50b143=await _0x2269e1['where'](_0x2f9c6b(0x19f),{'today':_0x594490})[_0x2f9c6b(0x1ab)](_0x2f9c6b(0x1c8),{'tomorrow':_0x1a2ab6})[_0x2f9c6b(0x1d8)]();return _0x50b143;}async[_0x1528f8(0x196)](){const _0x3083f7=_0x1528f8,_0x4dafec=await this[_0x3083f7(0x1b1)][_0x3083f7(0x181)]({'where':{'type':balance_constant_1[_0x3083f7(0x176)][_0x3083f7(0x1d4)]}});return _0x4dafec;}async[_0x1528f8(0x170)](){const _0x8c1369=_0x1528f8,_0x21de44=new Date();_0x21de44['setHours'](0x0,0x0,0x0,0x0);const _0x5c743e=new Date(_0x21de44[_0x8c1369(0x1d9)]()+0x18*0x3c*0x3c*0x3e8),_0x389c12=this[_0x8c1369(0x1b1)]['createQueryBuilder']('chatLog'),_0x285ebe=await _0x389c12[_0x8c1369(0x1dd)](_0x8c1369(0x19a),{'type':balance_constant_1['DeductionKey'][_0x8c1369(0x1d4)]})[_0x8c1369(0x1ab)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x21de44})[_0x8c1369(0x1ab)](_0x8c1369(0x1ad),{'tomorrow':_0x5c743e})[_0x8c1369(0x1d8)]();return _0x285ebe;}async[_0x1528f8(0x19e)](){const _0x56c9b4=_0x1528f8,_0x6c9b98=await this['chatLogEntity'][_0x56c9b4(0x181)]({'where':{'type':balance_constant_1['DeductionKey'][_0x56c9b4(0x198)]}});return _0x6c9b98;}async[_0x1528f8(0x173)](){const _0x46fc4a=_0x1528f8,_0x5e0f16=new Date();_0x5e0f16['setHours'](0x0,0x0,0x0,0x0);const _0x598657=new Date(_0x5e0f16[_0x46fc4a(0x1d9)]()+0x18*0x3c*0x3c*0x3e8),_0x1c284a=this[_0x46fc4a(0x1b1)]['createQueryBuilder']('chatLog'),_0x3bcdbd=await _0x1c284a[_0x46fc4a(0x1dd)](_0x46fc4a(0x19a),{'type':balance_constant_1[_0x46fc4a(0x176)][_0x46fc4a(0x198)]})[_0x46fc4a(0x1ab)]('chatLog.createdAt\x20>=\x20:today',{'today':_0x5e0f16})[_0x46fc4a(0x1ab)](_0x46fc4a(0x1ad),{'tomorrow':_0x598657})['getCount']();return _0x3bcdbd;}async['countNewMidhourneysToday'](){const _0x5014af=_0x1528f8,_0x154711=new Date();_0x154711[_0x5014af(0x171)](0x0,0x0,0x0,0x0);const _0x4da991=new Date(_0x154711[_0x5014af(0x1d9)]()+0x18*0x3c*0x3c*0x3e8),_0x12904e=this[_0x5014af(0x1a9)][_0x5014af(0x1db)]('midjourney'),_0x4f10e8=await _0x12904e['where']('midjourney.createdAt\x20>=\x20:today',{'today':_0x154711})[_0x5014af(0x1ab)](_0x5014af(0x19d),{'tomorrow':_0x4da991})[_0x5014af(0x1d8)]();return _0x4f10e8;}async[_0x1528f8(0x17a)](_0x5683df){const _0x3bd109=_0x1528f8;var _0x570dbe,_0x6961e5;const _0x3a2d58=new Date();_0x3a2d58[_0x3bd109(0x171)](0x0,0x0,0x0,0x0);const _0x5745e9=new Date(_0x3a2d58[_0x3bd109(0x1d9)]()-(_0x5683df-0x1)*0x18*0x3c*0x3c*0x3e8),_0x8aebaa=this[_0x3bd109(0x1b1)][_0x3bd109(0x1db)]('chatlog'),_0x360c22=await _0x8aebaa['select'](_0x3bd109(0x1cc))[_0x3bd109(0x1dd)]('chatlog.type\x20=\x20:type',{'type':balance_constant_1['DeductionKey'][_0x3bd109(0x1d4)]})[_0x3bd109(0x1ab)](_0x3bd109(0x1af),{'startDate':_0x5745e9})[_0x3bd109(0x1de)](_0x3bd109(0x1ae))[_0x3bd109(0x18b)]('date')['getRawMany'](),_0x5eac44=[],_0x1f51ac=_0x5745e9;for(let _0x2f94e3=0x0;_0x2f94e3<_0x5683df;_0x2f94e3++){const _0x422ca2=(0x0,date_1[_0x3bd109(0x180)])(new Date(_0x1f51ac),_0x3bd109(0x1df)),_0x4a8a42=(_0x6961e5=(_0x570dbe=_0x360c22['find'](_0x3bacd0=>(0x0,date_1['formatDate'])(new Date(_0x3bacd0[_0x3bd109(0x1ae)]),'M.DD')===_0x422ca2))===null||_0x570dbe===void 0x0?void 0x0:_0x570dbe[_0x3bd109(0x181)])!==null&&_0x6961e5!==void 0x0?_0x6961e5:0x0;_0x4a8a42>0x0?_0x5eac44['push']({'date':_0x422ca2,'value':Number(_0x4a8a42)}):_0x5eac44['push']({'date':_0x422ca2,'value':0x0}),_0x1f51ac['setDate'](_0x1f51ac['getDate']()+0x1);}return _0x5eac44;}async['countDrawsByTimeRange'](_0x3daa40){const _0x5881cd=_0x1528f8;var _0x3fe158,_0x147bd7;const _0x2da446=new Date();_0x2da446[_0x5881cd(0x171)](0x0,0x0,0x0,0x0);const _0x20e2b5=new Date(_0x2da446[_0x5881cd(0x1d9)]()-(_0x3daa40-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2f02ce=this[_0x5881cd(0x1b1)][_0x5881cd(0x1db)](_0x5881cd(0x1bf)),_0x2abb8f=await _0x2f02ce[_0x5881cd(0x16a)](_0x5881cd(0x1cc))[_0x5881cd(0x1dd)](_0x5881cd(0x1b2),{'type':balance_constant_1[_0x5881cd(0x176)][_0x5881cd(0x198)]})[_0x5881cd(0x1ab)](_0x5881cd(0x1af),{'startDate':_0x20e2b5})[_0x5881cd(0x1de)](_0x5881cd(0x1ae))[_0x5881cd(0x18b)]('date')[_0x5881cd(0x18f)](),_0x5fec83=[],_0x38fe01=_0x20e2b5;for(let _0x564c34=0x0;_0x564c34<_0x3daa40;_0x564c34++){const _0x374fd0=(0x0,date_1['formatDate'])(new Date(_0x38fe01),'M.DD'),_0x4616e4=(_0x147bd7=(_0x3fe158=_0x2abb8f[_0x5881cd(0x1bc)](_0x2e3147=>(0x0,date_1[_0x5881cd(0x180)])(new Date(_0x2e3147[_0x5881cd(0x1ae)]),'M.DD')===_0x374fd0))===null||_0x3fe158===void 0x0?void 0x0:_0x3fe158[_0x5881cd(0x181)])!==null&&_0x147bd7!==void 0x0?_0x147bd7:0x0;_0x4616e4>0x0?_0x5fec83['push']({'date':_0x374fd0,'value':Number(_0x4616e4)}):_0x5fec83['push']({'date':_0x374fd0,'value':0x0}),_0x38fe01[_0x5881cd(0x184)](_0x38fe01[_0x5881cd(0x195)]()+0x1);}return _0x5fec83;}async[_0x1528f8(0x1a0)](_0x545500){const _0x499930=_0x1528f8;var _0x2dc562,_0x330008;const _0x469f36=new Date();_0x469f36[_0x499930(0x171)](0x0,0x0,0x0,0x0);const _0x5dd20b=new Date(_0x469f36[_0x499930(0x1d9)]()-(_0x545500-0x1)*0x18*0x3c*0x3c*0x3e8),_0x344c65=this[_0x499930(0x1a9)]['createQueryBuilder'](_0x499930(0x1cb)),_0x4a31c8=await _0x344c65[_0x499930(0x16a)](_0x499930(0x191))['where'](_0x499930(0x1ce),{'status':midjourney_constant_1[_0x499930(0x17b)][_0x499930(0x17e)]})[_0x499930(0x1ab)]('midjourney.createdAt\x20>=\x20:startDate',{'startDate':_0x5dd20b})[_0x499930(0x1de)](_0x499930(0x1ae))[_0x499930(0x18b)]('date')['getRawMany'](),_0x37899d=[],_0x5ae970=_0x5dd20b;for(let _0x284afa=0x0;_0x284afa<_0x545500;_0x284afa++){const _0x13d69c=(0x0,date_1[_0x499930(0x180)])(new Date(_0x5ae970),_0x499930(0x1df)),_0x343085=(_0x330008=(_0x2dc562=_0x4a31c8[_0x499930(0x1bc)](_0x50aad0=>(0x0,date_1[_0x499930(0x180)])(new Date(_0x50aad0[_0x499930(0x1ae)]),_0x499930(0x1df))===_0x13d69c))===null||_0x2dc562===void 0x0?void 0x0:_0x2dc562['count'])!==null&&_0x330008!==void 0x0?_0x330008:0x0;_0x343085>0x0?_0x37899d[_0x499930(0x1c7)]({'date':_0x13d69c,'value':Number(_0x343085)}):_0x37899d['push']({'date':_0x13d69c,'value':0x0}),_0x5ae970[_0x499930(0x184)](_0x5ae970[_0x499930(0x195)]()+0x1);}return _0x37899d;}async[_0x1528f8(0x1c6)](_0x27335b){const _0x695065=_0x1528f8;var _0x49ef1e,_0x6258c9;const _0x5b6c87=(0x0,date_1['formatDate'])(new Date(),'YYYYMMDD'),_0x5d4fd5=(0x0,date_1[_0x695065(0x180)])(new Date(Date[_0x695065(0x16e)]()-Number(_0x27335b-0x1)*0x18*0x3c*0x3c*0x3e8),_0x695065(0x17d)),_0xe1cee7=_0x695065(0x16c),_0x2faede=_0x695065(0x17c),_0x594269=await this[_0x695065(0x1b7)][_0x695065(0x1bc)]({'where':{'configKey':(0x0,typeorm_2['In'])(['baiduToken',_0x695065(0x1a7)])}}),_0x3e7f8d=(_0x49ef1e=_0x594269[_0x695065(0x1bc)](_0x2cdd1e=>_0x2cdd1e[_0x695065(0x174)]===_0x695065(0x1a7)))===null||_0x49ef1e===void 0x0?void 0x0:_0x49ef1e[_0x695065(0x16b)],_0x30e933=(_0x6258c9=_0x594269[_0x695065(0x1bc)](_0x1da514=>_0x1da514['configKey']===_0x695065(0x1b4)))===null||_0x6258c9===void 0x0?void 0x0:_0x6258c9[_0x695065(0x16b)];if(!_0x3e7f8d||!_0x30e933)return[];if(!_0x3e7f8d)throw new common_1[(_0x695065(0x1b5))](_0x695065(0x1be),common_1[_0x695065(0x189)][_0x695065(0x175)]);if(!_0x30e933)throw new common_1['HttpException'](_0x695065(0x1ca),common_1[_0x695065(0x189)][_0x695065(0x175)]);const _0x1b624c=_0x695065(0x1a2)+_0x30e933+_0x695065(0x16d)+_0x3e7f8d+_0x695065(0x1dc)+_0x2faede+'&start_date='+_0x5d4fd5+_0x695065(0x188)+_0x5b6c87+_0x695065(0x193)+_0xe1cee7,_0x58d30c=await axios_1[_0x695065(0x179)]['get'](_0x1b624c),{error_code:_0x479eff,message:_0x36ef24}=_0x58d30c[_0x695065(0x1a8)];if(_0x479eff===0x6f)throw new common_1['HttpException'](_0x36ef24||_0x695065(0x18a),common_1[_0x695065(0x189)][_0x695065(0x175)]);if(_0x479eff&&_0x479eff!==0xc8)throw new common_1[(_0x695065(0x1b5))](_0x36ef24||_0x695065(0x1a5),common_1[_0x695065(0x189)]['BAD_REQUEST']);return _0x58d30c[_0x695065(0x1a8)][_0x695065(0x18e)];}async[_0x1528f8(0x172)](){const _0x89451=_0x1528f8,_0xd70003=await this[_0x89451(0x1cd)]['count']();return _0xd70003;}async[_0x1528f8(0x1a4)](){const _0x20042b=_0x1528f8,_0x1f131b=new Date();_0x1f131b['setHours'](0x0,0x0,0x0,0x0);const _0x164408=new Date(_0x1f131b[_0x20042b(0x1d9)]()+0x18*0x3c*0x3c*0x3e8),_0x3c67f9=this[_0x20042b(0x1cd)][_0x20042b(0x1db)](_0x20042b(0x1b9)),_0x2573af=await _0x3c67f9[_0x20042b(0x1dd)](_0x20042b(0x190),{'today':_0x1f131b})['andWhere']('order.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x164408})[_0x20042b(0x1d8)]();return _0x2573af;}};StatisticService=__decorate([(0x0,common_1[_0x1528f8(0x1d1)])(),__param(0x0,(0x0,typeorm_1[_0x1528f8(0x1d3)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x1528f8(0x1d3)])(chatLog_entity_1[_0x1528f8(0x1b3)])),__param(0x2,(0x0,typeorm_1[_0x1528f8(0x1d3)])(config_entity_1[_0x1528f8(0x1c5)])),__param(0x3,(0x0,typeorm_1[_0x1528f8(0x1d3)])(order_entity_1[_0x1528f8(0x1ba)])),__param(0x4,(0x0,typeorm_1[_0x1528f8(0x1d3)])(midjourney_entity_1[_0x1528f8(0x1c9)])),__metadata(_0x1528f8(0x1a3),[typeorm_2[_0x1528f8(0x1b0)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x1528f8(0x1b0)],typeorm_2[_0x1528f8(0x1b0)]])],StatisticService),exports['StatisticService']=StatisticService;