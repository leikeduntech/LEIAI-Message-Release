'use strict';const _0x10b03d=_0x4dc6;(function(_0x3c0ab1,_0x7e354a){const _0x4b9e8e=_0x4dc6,_0x580da9=_0x3c0ab1();while(!![]){try{const _0x291d6a=parseInt(_0x4b9e8e(0x148))/0x1*(-parseInt(_0x4b9e8e(0x15e))/0x2)+parseInt(_0x4b9e8e(0x14a))/0x3+parseInt(_0x4b9e8e(0x172))/0x4+-parseInt(_0x4b9e8e(0x176))/0x5+-parseInt(_0x4b9e8e(0x15b))/0x6+parseInt(_0x4b9e8e(0x17a))/0x7*(-parseInt(_0x4b9e8e(0x150))/0x8)+-parseInt(_0x4b9e8e(0x13a))/0x9*(-parseInt(_0x4b9e8e(0x177))/0xa);if(_0x291d6a===_0x7e354a)break;else _0x580da9['push'](_0x580da9['shift']());}catch(_0x3f3d2f){_0x580da9['push'](_0x580da9['shift']());}}}(_0x5aa2,0xdac32));function _0x4dc6(_0x15b7f1,_0x53f067){const _0x5aa2aa=_0x5aa2();return _0x4dc6=function(_0x4dc691,_0x2aa036){_0x4dc691=_0x4dc691-0x138;let _0x3870c0=_0x5aa2aa[_0x4dc691];return _0x3870c0;},_0x4dc6(_0x15b7f1,_0x53f067);}function _0x5aa2(){const _0x444a2d=['REGENERATE','3653510aCfiUO','260KPDIbT','../../common/utils','mjDraw','163443gvMsal','decorate','mjTimeoutMs','422001BrdeNy','DRAW','UserBalanceService','BAD_REQUEST','GENERATE','clean','InjectQueue','addMjDrawQueue','userBalanceService','../globalConfig/globalConfig.service','getDrawActionDetail','design:paramtypes','__esModule','defineProperty','2219EGGujQ','mjDrawQueue','4257645NxUnMs','UPSCALE','checkLimit','../userBalance/userBalance.service','add','getOwnPropertyDescriptor','240PuYOoP','@nestjs/bull','validateBalance','cleanQueue','MJDRAW','服务启动时清除所有之前未执行完毕的队列任务！','deductFromBalance','function','Logger','metadata','user','1263120LPuoNM','push','MidjourneyService','796SyBqeT','QueueService','midjourneyService','jobIds','__param','GlobalConfigService','assign','active','debug','addDrawQueue','__metadata','缺少必要参数！','checkIsUpscale','length','MidjourneyActionEnum','onApplicationBootstrap','HttpStatus','VARIATION','object','getConfigs','3130300FYhXLU','HttpException','globalConfigService'];_0x5aa2=function(){return _0x444a2d;};return _0x5aa2();}var __decorate=this&&this['__decorate']||function(_0x194f80,_0x2322fe,_0x3b2ae9,_0x2316b9){const _0xf5356b=_0x4dc6;var _0x5f34d2=arguments[_0xf5356b(0x16b)],_0x5bee00=_0x5f34d2<0x3?_0x2322fe:_0x2316b9===null?_0x2316b9=Object[_0xf5356b(0x14f)](_0x2322fe,_0x3b2ae9):_0x2316b9,_0x2f2f1f;if(typeof Reflect==='object'&&typeof Reflect[_0xf5356b(0x138)]===_0xf5356b(0x157))_0x5bee00=Reflect['decorate'](_0x194f80,_0x2322fe,_0x3b2ae9,_0x2316b9);else{for(var _0x427095=_0x194f80[_0xf5356b(0x16b)]-0x1;_0x427095>=0x0;_0x427095--)if(_0x2f2f1f=_0x194f80[_0x427095])_0x5bee00=(_0x5f34d2<0x3?_0x2f2f1f(_0x5bee00):_0x5f34d2>0x3?_0x2f2f1f(_0x2322fe,_0x3b2ae9,_0x5bee00):_0x2f2f1f(_0x2322fe,_0x3b2ae9))||_0x5bee00;}return _0x5f34d2>0x3&&_0x5bee00&&Object[_0xf5356b(0x147)](_0x2322fe,_0x3b2ae9,_0x5bee00),_0x5bee00;},__metadata=this&&this[_0x10b03d(0x168)]||function(_0x6ffae6,_0x241dd4){const _0x14df6d=_0x10b03d;if(typeof Reflect===_0x14df6d(0x170)&&typeof Reflect[_0x14df6d(0x159)]==='function')return Reflect['metadata'](_0x6ffae6,_0x241dd4);},__param=this&&this[_0x10b03d(0x162)]||function(_0x163b13,_0x190577){return function(_0x48cb2f,_0x3da6f6){_0x190577(_0x48cb2f,_0x3da6f6,_0x163b13);};};Object[_0x10b03d(0x147)](exports,_0x10b03d(0x146),{'value':!![]}),exports[_0x10b03d(0x15f)]=void 0x0;const common_1=require('@nestjs/common'),bull_1=require(_0x10b03d(0x151)),utils_1=require(_0x10b03d(0x178)),midjourney_service_1=require('../midjourney/midjourney.service'),midjourney_constant_1=require('../../common/constants/midjourney.constant'),userBalance_service_1=require(_0x10b03d(0x14d)),globalConfig_service_1=require(_0x10b03d(0x143));let QueueService=class QueueService{constructor(_0x583f5c,_0x5927f5,_0x10c1df,_0x1199ba){const _0x1a58e4=_0x10b03d;this[_0x1a58e4(0x149)]=_0x583f5c,this[_0x1a58e4(0x160)]=_0x5927f5,this[_0x1a58e4(0x142)]=_0x10c1df,this[_0x1a58e4(0x174)]=_0x1199ba,this['jobIds']=[];}async[_0x10b03d(0x16d)](){const _0x4ca01d=_0x10b03d;common_1[_0x4ca01d(0x158)][_0x4ca01d(0x166)](_0x4ca01d(0x155),_0x4ca01d(0x15f)),await this[_0x4ca01d(0x149)][_0x4ca01d(0x13f)](0x0,_0x4ca01d(0x165)),await this[_0x4ca01d(0x160)][_0x4ca01d(0x153)]();}async[_0x10b03d(0x141)](_0x42e20f,_0x32af03){const _0x2e5183=_0x10b03d,{prompt:_0x301ac4,imgUrl:_0x396f9d,extraParam:_0x31923b,orderId:_0x4ec517,action:action=0x1,drawId:_0x2ebb61}=_0x42e20f;await this[_0x2e5183(0x160)][_0x2e5183(0x14c)](_0x32af03),await this[_0x2e5183(0x142)][_0x2e5183(0x152)](_0x32af03['user']['id'],'mjDraw',action===0x2?0x1:0x4);if(action===midjourney_constant_1[_0x2e5183(0x16c)][_0x2e5183(0x13b)]||action===midjourney_constant_1[_0x2e5183(0x16c)][_0x2e5183(0x13e)]){const _0x544b49=''+(0x0,utils_1['createRandomUid'])(),_0x3646ec=Object['assign'](Object['assign']({},_0x42e20f),{'userId':_0x32af03[_0x2e5183(0x15a)]['id'],'randomDrawId':_0x544b49}),_0x239b39=await this[_0x2e5183(0x160)][_0x2e5183(0x167)](_0x3646ec),_0x2202d1=await this[_0x2e5183(0x174)][_0x2e5183(0x171)]([_0x2e5183(0x139)])||0x30d40,_0x3e0832=await this[_0x2e5183(0x149)]['add'](_0x2e5183(0x179),{'id':_0x239b39['id'],'action':_0x396f9d?0x4:0x1,'userId':_0x32af03[_0x2e5183(0x15a)]['id']},{'delay':0x3e8,'timeout':+_0x2202d1});return this[_0x2e5183(0x161)]['push'](_0x3e0832['id']),await this[_0x2e5183(0x142)][_0x2e5183(0x156)](_0x32af03[_0x2e5183(0x15a)]['id'],_0x2e5183(0x179),0x4,0x4),!![];}if(!_0x2ebb61||!_0x4ec517)throw new common_1[(_0x2e5183(0x173))](_0x2e5183(0x169),common_1[_0x2e5183(0x16e)][_0x2e5183(0x13d)]);if(action===midjourney_constant_1['MidjourneyActionEnum'][_0x2e5183(0x14b)]){const _0x16f04d=await this[_0x2e5183(0x160)][_0x2e5183(0x144)](action,_0x2ebb61,_0x4ec517),{custom_id:_0x564d21}=_0x16f04d;await this[_0x2e5183(0x160)][_0x2e5183(0x16a)](_0x564d21);const _0x41b019=Object[_0x2e5183(0x164)](Object[_0x2e5183(0x164)](Object[_0x2e5183(0x164)]({},_0x42e20f),{'userId':_0x32af03[_0x2e5183(0x15a)]['id']}),_0x16f04d),_0x4dd583=await this[_0x2e5183(0x160)]['addDrawQueue'](_0x41b019),_0x4975d2=await this[_0x2e5183(0x174)][_0x2e5183(0x171)]([_0x2e5183(0x139)])||0x30d40,_0x20008d=await this['mjDrawQueue']['add'](_0x2e5183(0x179),{'id':_0x4dd583['id'],'action':action,'userId':_0x32af03[_0x2e5183(0x15a)]['id']},{'delay':0x3e8,'timeout':+_0x4975d2});await this[_0x2e5183(0x142)]['deductFromBalance'](_0x32af03['user']['id'],_0x2e5183(0x179),0x1,0x1),this['jobIds'][_0x2e5183(0x15c)](_0x20008d['id']);return;}if(action===midjourney_constant_1[_0x2e5183(0x16c)][_0x2e5183(0x16f)]){const _0x19e3e1=await this[_0x2e5183(0x160)][_0x2e5183(0x144)](action,_0x2ebb61,_0x4ec517),_0x1594f6=Object[_0x2e5183(0x164)](Object[_0x2e5183(0x164)](Object[_0x2e5183(0x164)]({},_0x42e20f),{'userId':_0x32af03['user']['id']}),_0x19e3e1),_0x4d0080=await this[_0x2e5183(0x160)][_0x2e5183(0x167)](_0x1594f6),_0x1e58e4=await this[_0x2e5183(0x174)]['getConfigs']([_0x2e5183(0x139)])||0x30d40,_0x45ef78=await this[_0x2e5183(0x149)]['add'](_0x2e5183(0x179),{'id':_0x4d0080['id'],'action':action,'userId':_0x32af03[_0x2e5183(0x15a)]['id']},{'delay':0x3e8,'timeout':+_0x1e58e4});this[_0x2e5183(0x161)]['push'](_0x45ef78['id']),await this[_0x2e5183(0x142)][_0x2e5183(0x156)](_0x32af03[_0x2e5183(0x15a)]['id'],_0x2e5183(0x179),0x4,0x4);return;}if(action===midjourney_constant_1[_0x2e5183(0x16c)][_0x2e5183(0x175)]){const _0x299909=await this[_0x2e5183(0x160)]['getDrawActionDetail'](action,_0x2ebb61,_0x4ec517),_0x5efdf3=Object['assign'](Object['assign'](Object[_0x2e5183(0x164)]({},_0x42e20f),{'userId':_0x32af03['user']['id']}),_0x299909),_0x1a7603=await this[_0x2e5183(0x160)][_0x2e5183(0x167)](_0x5efdf3),_0x26f8a9=await this['globalConfigService'][_0x2e5183(0x171)]([_0x2e5183(0x139)])||0x30d40,_0x1a7bbc=await this[_0x2e5183(0x149)][_0x2e5183(0x14e)](_0x2e5183(0x179),{'id':_0x1a7603['id'],'action':action,'userId':_0x32af03['user']['id']},{'delay':0x3e8,'timeout':+_0x26f8a9});this[_0x2e5183(0x161)][_0x2e5183(0x15c)](_0x1a7bbc['id']),await this['userBalanceService'][_0x2e5183(0x156)](_0x32af03[_0x2e5183(0x15a)]['id'],_0x2e5183(0x179),0x4,0x4);return;}if(action===midjourney_constant_1['MidjourneyActionEnum']['VARY']){const _0x525cc0=await this[_0x2e5183(0x160)]['getDrawActionDetail'](action,_0x2ebb61,_0x4ec517),_0x5b6c9d=Object[_0x2e5183(0x164)](Object[_0x2e5183(0x164)](Object[_0x2e5183(0x164)]({},_0x42e20f),{'userId':_0x32af03['user']['id']}),_0x525cc0),_0xb97435=await this['midjourneyService'][_0x2e5183(0x167)](_0x5b6c9d),_0x3611d5=await this[_0x2e5183(0x174)][_0x2e5183(0x171)]([_0x2e5183(0x139)])||0x30d40,_0x292fd2=await this[_0x2e5183(0x149)][_0x2e5183(0x14e)]('mjDraw',{'id':_0xb97435['id'],'action':action,'userId':_0x32af03[_0x2e5183(0x15a)]['id']},{'delay':0x3e8,'timeout':+_0x3611d5});this[_0x2e5183(0x161)]['push'](_0x292fd2['id']),await this['userBalanceService'][_0x2e5183(0x156)](_0x32af03[_0x2e5183(0x15a)]['id'],_0x2e5183(0x179),0x4,0x4);return;}if(action===midjourney_constant_1[_0x2e5183(0x16c)]['ZOOM']){const _0xa43fd9=await this['midjourneyService']['getDrawActionDetail'](action,_0x2ebb61,_0x4ec517),_0x5e6875=Object[_0x2e5183(0x164)](Object[_0x2e5183(0x164)](Object[_0x2e5183(0x164)]({},_0x42e20f),{'userId':_0x32af03[_0x2e5183(0x15a)]['id']}),_0xa43fd9),_0x3ecf8d=await this['midjourneyService'][_0x2e5183(0x167)](_0x5e6875),_0x27242a=await this[_0x2e5183(0x174)]['getConfigs']([_0x2e5183(0x139)])||0x30d40,_0x59012c=await this[_0x2e5183(0x149)]['add'](_0x2e5183(0x179),{'id':_0x3ecf8d['id'],'action':action,'userId':_0x32af03[_0x2e5183(0x15a)]['id']},{'delay':0x3e8,'timeout':+_0x27242a});this[_0x2e5183(0x161)][_0x2e5183(0x15c)](_0x59012c['id']),await this[_0x2e5183(0x142)][_0x2e5183(0x156)](_0x32af03[_0x2e5183(0x15a)]['id'],_0x2e5183(0x179),0x4,0x4);return;}}async['getQueue'](){return{'jobIds':this['jobIds']};}};QueueService=__decorate([__param(0x0,(0x0,bull_1[_0x10b03d(0x140)])(_0x10b03d(0x154))),__metadata(_0x10b03d(0x145),[Object,midjourney_service_1[_0x10b03d(0x15d)],userBalance_service_1[_0x10b03d(0x13c)],globalConfig_service_1[_0x10b03d(0x163)]])],QueueService),exports[_0x10b03d(0x15f)]=QueueService;