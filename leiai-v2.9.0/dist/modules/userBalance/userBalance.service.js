'use strict';const _0x4bdf9d=_0x62e7;(function(_0x1331b4,_0x3b2c4e){const _0x4b82f8=_0x62e7,_0x119de8=_0x1331b4();while(!![]){try{const _0x15ef82=parseInt(_0x4b82f8(0x1db))/0x1*(parseInt(_0x4b82f8(0x24d))/0x2)+-parseInt(_0x4b82f8(0x1f7))/0x3*(-parseInt(_0x4b82f8(0x1d9))/0x4)+-parseInt(_0x4b82f8(0x1e3))/0x5+parseInt(_0x4b82f8(0x250))/0x6*(parseInt(_0x4b82f8(0x262))/0x7)+parseInt(_0x4b82f8(0x214))/0x8*(parseInt(_0x4b82f8(0x258))/0x9)+parseInt(_0x4b82f8(0x245))/0xa*(-parseInt(_0x4b82f8(0x229))/0xb)+-parseInt(_0x4b82f8(0x1ca))/0xc;if(_0x15ef82===_0x3b2c4e)break;else _0x119de8['push'](_0x119de8['shift']());}catch(_0xd773ae){_0x119de8['push'](_0x119de8['shift']());}}}(_0x31cb,0xd3fc0));var __decorate=this&&this[_0x4bdf9d(0x224)]||function(_0x1f9ab6,_0x198a49,_0x55b6d3,_0x31ef04){const _0x546235=_0x4bdf9d;var _0x327fbd=arguments[_0x546235(0x206)],_0x10a49f=_0x327fbd<0x3?_0x198a49:_0x31ef04===null?_0x31ef04=Object[_0x546235(0x210)](_0x198a49,_0x55b6d3):_0x31ef04,_0x313541;if(typeof Reflect===_0x546235(0x26d)&&typeof Reflect[_0x546235(0x1d6)]===_0x546235(0x203))_0x10a49f=Reflect[_0x546235(0x1d6)](_0x1f9ab6,_0x198a49,_0x55b6d3,_0x31ef04);else{for(var _0x2d8df2=_0x1f9ab6[_0x546235(0x206)]-0x1;_0x2d8df2>=0x0;_0x2d8df2--)if(_0x313541=_0x1f9ab6[_0x2d8df2])_0x10a49f=(_0x327fbd<0x3?_0x313541(_0x10a49f):_0x327fbd>0x3?_0x313541(_0x198a49,_0x55b6d3,_0x10a49f):_0x313541(_0x198a49,_0x55b6d3))||_0x10a49f;}return _0x327fbd>0x3&&_0x10a49f&&Object[_0x546235(0x1e7)](_0x198a49,_0x55b6d3,_0x10a49f),_0x10a49f;},__metadata=this&&this[_0x4bdf9d(0x232)]||function(_0x1fa72e,_0x5030ca){const _0x8c8e7e=_0x4bdf9d;if(typeof Reflect===_0x8c8e7e(0x26d)&&typeof Reflect[_0x8c8e7e(0x24c)]===_0x8c8e7e(0x203))return Reflect[_0x8c8e7e(0x24c)](_0x1fa72e,_0x5030ca);},__param=this&&this[_0x4bdf9d(0x25f)]||function(_0x2f0ef8,_0x2f0db8){return function(_0x29dac9,_0x1e4981){_0x2f0db8(_0x29dac9,_0x1e4981,_0x2f0ef8);};};function _0x62e7(_0x40842b,_0x4e299c){const _0x31cb8c=_0x31cb();return _0x62e7=function(_0x62e747,_0x544110){_0x62e747=_0x62e747-0x1c4;let _0x1c26d9=_0x31cb8c[_0x62e747];return _0x1c26d9;},_0x62e7(_0x40842b,_0x4e299c);}Object['defineProperty'](exports,_0x4bdf9d(0x1ef),{'value':!![]}),exports[_0x4bdf9d(0x22b)]=void 0x0;const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),typeorm_1=require(_0x4bdf9d(0x246)),balance_entity_1=require(_0x4bdf9d(0x1cd)),common_1=require(_0x4bdf9d(0x1f1)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x4bdf9d(0x22c)),accountLog_entity_1=require('./accountLog.entity'),utils_1=require('../../common/utils'),config_entity_1=require(_0x4bdf9d(0x240)),cramiPackage_entity_1=require(_0x4bdf9d(0x217)),userBalance_entity_1=require(_0x4bdf9d(0x1e2)),date_1=require('../../common/utils/date'),user_entity_1=require('../user/user.entity'),salesUsers_entity_1=require(_0x4bdf9d(0x238)),sales_service_1=require('../sales/sales.service'),whiteList_entity_1=require(_0x4bdf9d(0x26f));let UserBalanceService=class UserBalanceService{constructor(_0x35c610,_0x12cb25,_0x10ebe1,_0x3791d2,_0xf13504,_0x1c3d04,_0x94da7d,_0x234739,_0x5e58ce,_0x3b365a){const _0x547c7d=_0x4bdf9d;this[_0x547c7d(0x21c)]=_0x35c610,this[_0x547c7d(0x215)]=_0x12cb25,this['accountLogEntity']=_0x10ebe1,this[_0x547c7d(0x26a)]=_0x3791d2,this[_0x547c7d(0x1da)]=_0xf13504,this[_0x547c7d(0x1fe)]=_0x1c3d04,this[_0x547c7d(0x201)]=_0x94da7d,this[_0x547c7d(0x1f4)]=_0x234739,this['salesService']=_0x5e58ce,this['globalConfigService']=_0x3b365a;}async['addBalanceToNewUser'](_0x3fbd96,_0x33b00b){const _0xe346dd=_0x4bdf9d;try{const _0x5f4b14=await this[_0xe346dd(0x1da)][_0xe346dd(0x266)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0xe346dd(0x260),_0xe346dd(0x1ea),_0xe346dd(0x253),_0xe346dd(0x257),_0xe346dd(0x25a),_0xe346dd(0x1c9),'firstRregisterSendModel3Count','firstRregisterSendModel4Count',_0xe346dd(0x26e),_0xe346dd(0x259),_0xe346dd(0x1d2),_0xe346dd(0x256),_0xe346dd(0x252),_0xe346dd(0x1d7),_0xe346dd(0x21a),_0xe346dd(0x255)])}}),_0x379a95=_0x5f4b14[_0xe346dd(0x227)]((_0x1600fc,_0x18128e)=>{const _0x325472=_0xe346dd,_0x3cbdeb=Number(_0x18128e['configVal']),_0x575232=Number[_0x325472(0x21b)](_0x3cbdeb)&&_0x3cbdeb>0x0?_0x3cbdeb:0x0;return _0x1600fc[_0x18128e[_0x325472(0x1fb)]]=_0x575232,_0x1600fc;},{});let _0x3ca98=0x0,_0x3a5d0f=0x0,_0x197906=0x0;_0x379a95[_0xe346dd(0x260)]===0x1&&(_0x3ca98=_0x3ca98+_0x379a95[_0xe346dd(0x1ea)],_0x3a5d0f=_0x3a5d0f+_0x379a95[_0xe346dd(0x253)],_0x197906=_0x197906+_0x379a95[_0xe346dd(0x257)]),_0x379a95[_0xe346dd(0x260)]===0x1&&_0x379a95[_0xe346dd(0x25a)]===0x1&&_0x3fbd96<=_0x379a95[_0xe346dd(0x1c9)]&&(_0x3ca98=_0x3ca98+_0x379a95[_0xe346dd(0x1e1)],_0x3a5d0f=_0x3a5d0f+_0x379a95[_0xe346dd(0x1fc)],_0x197906=_0x197906+_0x379a95[_0xe346dd(0x26e)]),await this[_0xe346dd(0x264)]({'userId':_0x3fbd96,'rechargeType':balance_constant_1[_0xe346dd(0x1e4)][_0xe346dd(0x268)],'model3Count':_0x3ca98,'drawMjCount':_0x197906,'model4Count':_0x3a5d0f}),_0x33b00b&&(Number(_0x379a95[_0xe346dd(0x259)])===0x1&&(_0x3ca98=_0x3ca98+Number(_0x379a95[_0xe346dd(0x1d7)]),_0x3a5d0f=_0x3a5d0f+Number(_0x379a95[_0xe346dd(0x255)]),_0x197906=_0x197906+Number(_0x379a95[_0xe346dd(0x21a)]),await this['saveRecordRechargeLog']({'userId':_0x3fbd96,'rechargeType':balance_constant_1[_0xe346dd(0x1e4)][_0xe346dd(0x1d3)],'model3Count':_0x379a95['invitedGuestSendModel3Count'],'model4Count':_0x379a95[_0xe346dd(0x255)],'drawMjCount':_0x379a95[_0xe346dd(0x21a)]}),await this[_0xe346dd(0x1c6)](_0x33b00b,{'model3Count':_0x379a95['inviteGiveSendModel3Count'],'model4Count':_0x379a95['inviteGiveSendModel4Count'],'drawMjCount':_0x379a95[_0xe346dd(0x252)]}),await this['saveRecordRechargeLog']({'userId':_0x33b00b,'rechargeType':balance_constant_1[_0xe346dd(0x1e4)][_0xe346dd(0x247)],'model3Count':_0x379a95[_0xe346dd(0x1d2)],'model4Count':_0x379a95[_0xe346dd(0x256)],'drawMjCount':_0x379a95[_0xe346dd(0x252)]}))),await this[_0xe346dd(0x215)][_0xe346dd(0x230)]({'userId':_0x3fbd96,'model3Count':_0x3ca98,'model4Count':_0x3a5d0f,'drawMjCount':_0x197906,'useTokens':0x0});}catch(_0x42f605){console[_0xe346dd(0x1cc)](_0xe346dd(0x267),_0x42f605);throw new common_1['HttpException'](_0xe346dd(0x213),common_1[_0xe346dd(0x1dd)]['BAD_REQUEST']);}}async[_0x4bdf9d(0x208)](_0x38e8ad,_0x2f9170,_0xda14bb){const _0x24d9f8=_0x4bdf9d;let _0x4f4147=await this['userBalanceEntity'][_0x24d9f8(0x1ed)]({'where':{'userId':_0x38e8ad}});!_0x4f4147&&(_0x4f4147=await this[_0x24d9f8(0x1e0)](_0x38e8ad));const _0x2ee161=await this['configEntity']['findOne']({'where':{'configKey':_0x24d9f8(0x223)}}),_0xd94a96=_0x2ee161?_0x2ee161[_0x24d9f8(0x1e8)]:_0x24d9f8(0x200),_0x1a7d67=_0x2f9170===_0x24d9f8(0x1c5)?_0x24d9f8(0x1f5):_0x2f9170===_0x24d9f8(0x225)?'memberModel4Count':_0x2f9170===_0x24d9f8(0x1c4)?_0x24d9f8(0x202):null,_0xcf3a18=_0x2f9170===_0x24d9f8(0x1c5)?'model3Count':_0x2f9170===_0x24d9f8(0x225)?_0x24d9f8(0x26c):_0x2f9170===_0x24d9f8(0x1c4)?_0x24d9f8(0x1fd):null;if(_0x4f4147['packageId']&&_0x4f4147[_0x1a7d67]<_0xda14bb){if(_0x4f4147[_0xcf3a18]<_0xda14bb)throw new common_1['HttpException']('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0xd94a96+_0x24d9f8(0x248),common_1[_0x24d9f8(0x1dd)][_0x24d9f8(0x20e)]);}if(!_0x4f4147[_0x24d9f8(0x1e5)]&&_0x4f4147[_0xcf3a18]<_0xda14bb)throw new common_1['HttpException'](_0x24d9f8(0x209)+_0xd94a96+_0x24d9f8(0x248),common_1[_0x24d9f8(0x1dd)][_0x24d9f8(0x20e)]);return _0x4f4147;}async[_0x4bdf9d(0x1f3)](_0x34ec9d,_0x325702,_0x1f3fc3,_0x315dec=0x0){const _0x560697=_0x4bdf9d,_0x55ba58=await this[_0x560697(0x215)]['findOne']({'where':{'userId':_0x34ec9d}});if(!_0x55ba58)throw new common_1[(_0x560697(0x239))](_0x560697(0x261),common_1[_0x560697(0x1dd)][_0x560697(0x251)]);const _0x833626=_0x325702===_0x560697(0x1c5)?_0x560697(0x1f5):_0x325702===_0x560697(0x225)?'memberModel4Count':_0x325702===_0x560697(0x1c4)?_0x560697(0x202):null,_0x52db64=_0x325702==='model3'?'model3Count':_0x325702===_0x560697(0x225)?_0x560697(0x26c):_0x325702===_0x560697(0x1c4)?_0x560697(0x1fd):null,_0x36a24e=_0x55ba58[_0x560697(0x1e5)]&&_0x55ba58[_0x833626]<_0x1f3fc3?_0x52db64:_0x55ba58[_0x560697(0x1e5)]?_0x833626:_0x52db64;let _0x4c6922=null;_0x36a24e[_0x560697(0x205)](_0x560697(0x234))&&(_0x4c6922=_0x560697(0x263));_0x36a24e[_0x560697(0x205)](_0x560697(0x204))&&(_0x4c6922=_0x560697(0x1eb));_0x36a24e[_0x560697(0x205)](_0x560697(0x216))&&(_0x4c6922='useDrawMjToken');const _0x4d724e={[_0x36a24e]:_0x55ba58[_0x36a24e]-_0x1f3fc3<0x0?0x0:_0x55ba58[_0x36a24e]-_0x1f3fc3,[_0x4c6922]:_0x55ba58[_0x4c6922]+_0x315dec};_0x4c6922==='useModel3Token'&&(_0x4d724e[_0x560697(0x20d)]=_0x55ba58[_0x560697(0x20d)]+0x1),_0x4c6922===_0x560697(0x1eb)&&(_0x4d724e[_0x560697(0x1f0)]=_0x55ba58[_0x560697(0x1f0)]+0x1);const _0x1cfbb8=await this[_0x560697(0x215)][_0x560697(0x1d8)]({'userId':_0x34ec9d},_0x4d724e);if(_0x1cfbb8[_0x560697(0x25d)]===0x0)throw new common_1[(_0x560697(0x239))]('消费余额失败！',common_1[_0x560697(0x1dd)][_0x560697(0x251)]);}async['queryUserBalance'](_0x4b469d){const _0x4cabfd=_0x4bdf9d;try{const _0x51a832=await this[_0x4cabfd(0x215)][_0x4cabfd(0x1ed)]({'where':{'userId':_0x4b469d},'select':[_0x4cabfd(0x1e5),_0x4cabfd(0x243),_0x4cabfd(0x26c),_0x4cabfd(0x1fd),'memberModel3Count','memberModel4Count','memberDrawMjCount',_0x4cabfd(0x20d),'useModel4Count',_0x4cabfd(0x263),_0x4cabfd(0x1eb),_0x4cabfd(0x1f6),_0x4cabfd(0x23e)]});if(!_0x51a832){const _0x2d840f=await this['createBaseUserBalance'](_0x4b469d);if(_0x2d840f)return await this['queryUserBalance'](_0x4b469d);else throw new common_1[(_0x4cabfd(0x239))]('查询当前用户余额失败！',common_1['HttpStatus'][_0x4cabfd(0x251)]);}return _0x51a832['sumModel3Count']=_0x51a832[_0x4cabfd(0x1e5)]?_0x51a832[_0x4cabfd(0x243)]+_0x51a832['memberModel3Count']:_0x51a832['model3Count'],_0x51a832[_0x4cabfd(0x212)]=_0x51a832[_0x4cabfd(0x1e5)]?_0x51a832[_0x4cabfd(0x26c)]+_0x51a832[_0x4cabfd(0x235)]:_0x51a832[_0x4cabfd(0x26c)],_0x51a832[_0x4cabfd(0x1e6)]=_0x51a832['packageId']?_0x51a832[_0x4cabfd(0x1fd)]+_0x51a832[_0x4cabfd(0x202)]:_0x51a832[_0x4cabfd(0x1fd)],_0x51a832['expirationTime']=_0x51a832[_0x4cabfd(0x23e)]?(0x0,date_1[_0x4cabfd(0x265)])(_0x51a832[_0x4cabfd(0x23e)],_0x4cabfd(0x254)):null,_0x51a832;}catch(_0x429d82){console[_0x4cabfd(0x1cc)](_0x4cabfd(0x267),_0x429d82);}}async[_0x4bdf9d(0x264)](_0x2061b2){const _0x429cbe=_0x4bdf9d,{userId:_0x4731ee,rechargeType:_0x4f995a,model3Count:_0x29867d,model4Count:_0x5effc7,drawMjCount:_0x9dd025,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x2061b2;if(!_0x4731ee)throw new common_1['HttpException']('当前用户不存在,记录充值日志异常',common_1[_0x429cbe(0x1dd)][_0x429cbe(0x251)]);const _0x47b564=(0x0,utils_1[_0x429cbe(0x233)])();return await this[_0x429cbe(0x236)]['save']({'userId':_0x4731ee,'rechargeType':_0x4f995a,'model3Count':_0x29867d,'model4Count':_0x5effc7,'drawMjCount':_0x9dd025,'days':days,'extent':extent,'uid':_0x47b564,'pkgName':pkgName});}async[_0x4bdf9d(0x1e0)](_0x5b7a0d,_0x3ea347={}){const _0x431ecc=_0x4bdf9d,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3ea347,_0x3afd70=await this[_0x431ecc(0x215)][_0x431ecc(0x1ed)]({'where':{'userId':_0x5b7a0d}});if(_0x3afd70)throw new common_1[(_0x431ecc(0x239))](_0x431ecc(0x24a),common_1[_0x431ecc(0x1dd)]['BAD_REQUEST']);return await this['userBalanceEntity'][_0x431ecc(0x230)]({'userId':_0x5b7a0d,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async['addBalanceToUser'](_0x560d9e,_0x439b12,_0x2f4445=-0x1){const _0x138d99=_0x4bdf9d;try{const _0x3b3221=await this[_0x138d99(0x215)][_0x138d99(0x1ed)]({'where':{'userId':_0x560d9e}})||await this['createBaseUserBalance'](_0x560d9e);if(!_0x3b3221)throw new common_1[(_0x138d99(0x239))](_0x138d99(0x25b),common_1['HttpStatus'][_0x138d99(0x251)]);const {model3Count:_0x1616f8,model4Count:_0x592371,drawMjCount:_0x2c4edb,memberModel3Count:_0x1ec987,memberModel4Count:_0x3c1a5d,memberDrawMjCount:_0x59c58c}=_0x3b3221;let _0x212973={};if(_0x2f4445>0x0){const {packageId:_0xa8b857}=_0x439b12;if(!_0xa8b857)throw new common_1[(_0x138d99(0x239))](_0x138d99(0x21e),common_1['HttpStatus'][_0x138d99(0x251)]);const _0x5b8461=await this[_0x138d99(0x26a)]['findOne']({'where':{'id':_0xa8b857}});if(!_0x5b8461)throw new common_1['HttpException'](_0x138d99(0x26b),common_1[_0x138d99(0x1dd)][_0x138d99(0x251)]);const {weight:_0x3f2873}=_0x5b8461;if(!_0x3b3221[_0x138d99(0x1e5)])_0x212973={'memberModel3Count':_0x1616f8+_0x439b12[_0x138d99(0x243)],'memberModel4Count':_0x592371+_0x439b12['model4Count'],'memberDrawMjCount':_0x2c4edb+_0x439b12['drawMjCount'],'expirationTime':(0x0,date_1[_0x138d99(0x23d)])()[_0x138d99(0x20c)](_0x2f4445>0x0?_0x2f4445:0x0,_0x138d99(0x1fa))[_0x138d99(0x22f)](_0x138d99(0x22e)),'packageId':_0xa8b857};else{const _0x162f15=await this[_0x138d99(0x26a)]['findOne']({'where':{'id':_0x3b3221[_0x138d99(0x1e5)]}});_0x3f2873>=_0x162f15[_0x138d99(0x221)]&&(_0x212973={'memberModel3Count':_0x1ec987+_0x439b12['model3Count'],'memberModel4Count':_0x3c1a5d+_0x439b12[_0x138d99(0x26c)],'memberDrawMjCount':_0x59c58c+_0x439b12[_0x138d99(0x1fd)],'expirationTime':(0x0,date_1[_0x138d99(0x23d)])(_0x3b3221[_0x138d99(0x23e)])[_0x138d99(0x20c)](_0x2f4445>0x0?_0x2f4445:0x0,_0x138d99(0x1fa))[_0x138d99(0x22f)](_0x138d99(0x22e)),'packageId':_0xa8b857}),_0x3f2873<_0x162f15[_0x138d99(0x221)]&&(_0x212973={'memberModel3Count':_0x1ec987+_0x439b12[_0x138d99(0x243)],'memberModel4Count':_0x3c1a5d+_0x439b12[_0x138d99(0x26c)],'memberDrawMjCount':_0x59c58c+_0x439b12[_0x138d99(0x1fd)]});}}_0x2f4445<=0x0&&(_0x212973={'model3Count':_0x1616f8+_0x439b12['model3Count'],'model4Count':_0x592371+_0x439b12[_0x138d99(0x26c)],'drawMjCount':_0x2c4edb+_0x439b12[_0x138d99(0x1fd)]});const _0x4a61df=await this['userBalanceEntity']['update']({'userId':_0x560d9e},_0x212973);if(_0x4a61df[_0x138d99(0x25d)]===0x0)throw new common_1['HttpException'](_0x560d9e+_0x138d99(0x219),common_1[_0x138d99(0x1dd)][_0x138d99(0x251)]);}catch(_0x149b10){console['log']('error:\x20',_0x149b10);throw new common_1['HttpException'](_0x138d99(0x1c7),common_1[_0x138d99(0x1dd)][_0x138d99(0x251)]);}}async['addBalanceToOrder'](_0x21620b){const _0x29f081=_0x4bdf9d;console[_0x29f081(0x1cc)](_0x29f081(0x226),_0x21620b);try{const {userId:_0x42ac1d,goodsId:_0x3488ed}=_0x21620b,_0x1ddf11=await this[_0x29f081(0x26a)]['findOne']({'where':{'id':_0x21620b['goodsId'],'status':0x1}});if(!_0x1ddf11)throw new common_1[(_0x29f081(0x239))](_0x29f081(0x1ce),common_1[_0x29f081(0x1dd)][_0x29f081(0x251)]);const {model3Count:_0x503da2,model4Count:_0x25d172,drawMjCount:_0x376c52,days:_0x2f198c,name:_0x2fc01f}=_0x1ddf11,_0x2b9df8={'model3Count':_0x503da2,'model4Count':_0x25d172,'drawMjCount':_0x376c52,'days':_0x2f198c,'packageId':_0x21620b[_0x29f081(0x23c)]};await this[_0x29f081(0x1c6)](_0x42ac1d,_0x2b9df8,_0x2f198c),await this[_0x29f081(0x264)]({'userId':_0x42ac1d,'rechargeType':balance_constant_1['RechargeType']['SCAN_PAY'],'model3Count':_0x503da2,'model4Count':_0x25d172,'drawMjCount':_0x376c52,'pkgName':_0x2fc01f,'days':_0x2f198c});const _0x5b07e4=await this[_0x29f081(0x1fe)][_0x29f081(0x1ed)]({'where':{'id':_0x42ac1d}}),{invitedBy:_0x5d300a}=_0x5b07e4;if(_0x5d300a){const _0x42454d=await this[_0x29f081(0x1fe)][_0x29f081(0x1ed)]({'where':{'inviteCode':_0x5d300a}}),_0x35a1f8=await this[_0x29f081(0x201)]['findOne']({'where':{'userId':_0x42454d['id']}});if(!_0x42454d)return;const {id:_0x234e40}=_0x42454d,{performanceRatio:_0x4e62eb}=_0x35a1f8,_0x4198c6={'inviterUserId':_0x234e40,'inviteeUserId':_0x42ac1d,'orderId':_0x21620b['id'],'orderPrice':_0x21620b[_0x29f081(0x1de)],'commissionPercentage':_0x4e62eb,'commissionAmount':(_0x21620b[_0x29f081(0x1de)]*_0x4e62eb/0x64)[_0x29f081(0x269)](0x2)};await this['salesService'][_0x29f081(0x1c8)](_0x4198c6),await this[_0x29f081(0x25e)]['saveCommissionAmount'](_0x234e40,_0x4198c6['commissionAmount']);}}catch(_0x75185c){console[_0x29f081(0x1cc)](_0x29f081(0x267),_0x75185c);throw new common_1['HttpException'](_0x29f081(0x237),common_1[_0x29f081(0x1dd)]['BAD_REQUEST']);}}async['getRechargeLog'](_0x52f482,_0x38c9b5){const _0xe431c7=_0x4bdf9d,{page:page=0x1,size:size=0x14}=_0x38c9b5,{id:_0x25ba32}=_0x52f482[_0xe431c7(0x1ec)],[_0x5d0b51,_0x28d045]=await this[_0xe431c7(0x236)][_0xe431c7(0x220)]({'where':{'userId':_0x25ba32},'order':{'id':_0xe431c7(0x1f2)},'skip':(page-0x1)*size,'take':size});return _0x5d0b51['forEach'](_0x17acfa=>{const _0x1f0c8b=_0xe431c7;_0x17acfa['expireDateCn']=_0x17acfa[_0x1f0c8b(0x1cf)]>0x0?_0x17acfa[_0x1f0c8b(0x1cf)]+'天':'永久';}),{'rows':(0x0,date_1[_0xe431c7(0x1d5)])(_0x5d0b51),'count':_0x28d045};}async['getAccountLog'](_0x5ea578,_0x55b35a){const _0x211c66=_0x4bdf9d;try{const {page:page=0x1,size:size=0xa,userId:_0x58052a,rechargeType:_0x1fa1f9,packageId:_0x51f33f}=_0x55b35a,{role:_0x377f0d}=_0x5ea578[_0x211c66(0x1ec)],_0x1fe2ad={};_0x1fa1f9&&(_0x1fe2ad[_0x211c66(0x1f9)]=_0x1fa1f9),_0x58052a&&(_0x1fe2ad[_0x211c66(0x1cb)]=_0x58052a),_0x51f33f&&(_0x1fe2ad[_0x211c66(0x1e5)]={'$like':'%'+_0x51f33f+'%'});const [_0x5aa62e,_0x1b0c8e]=await this[_0x211c66(0x236)]['findAndCount']({'where':_0x1fe2ad,'order':{'id':_0x211c66(0x1f2)},'skip':(page-0x1)*size,'take':size}),_0x2d97b1=_0x5aa62e[_0x211c66(0x24b)](_0x83cf8f=>_0x83cf8f['userId']),_0x1709ab=await this[_0x211c66(0x1fe)][_0x211c66(0x266)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2d97b1)}});return _0x5aa62e['forEach'](_0x4e2737=>{const _0x4cd1f3=_0x211c66,_0x46a6ed=_0x1709ab[_0x4cd1f3(0x266)](_0x2856fd=>_0x2856fd['id']===_0x4e2737[_0x4cd1f3(0x1cb)]);_0x4e2737['username']=_0x46a6ed[_0x4cd1f3(0x242)],_0x4e2737['email']=_0x46a6ed[_0x4cd1f3(0x218)],_0x4e2737['phone']=_0x46a6ed['phone'],_0x4e2737['status']=_0x46a6ed['status'],_0x4e2737[_0x4cd1f3(0x23f)]=_0x46a6ed[_0x4cd1f3(0x23f)];}),_0x377f0d!==_0x211c66(0x20a)&&_0x5aa62e[_0x211c66(0x1d4)](_0x3b0ff9=>{const _0x12c993=_0x211c66;_0x3b0ff9[_0x12c993(0x218)]=_0x3b0ff9[_0x12c993(0x218)]?(0x0,utils_1['hideString'])(_0x3b0ff9[_0x12c993(0x218)]):'',_0x3b0ff9[_0x12c993(0x20f)]=_0x3b0ff9['phone']?(0x0,utils_1['hideString'])(_0x3b0ff9[_0x12c993(0x20f)]):'';}),{'rows':_0x5aa62e,'count':_0x1b0c8e};}catch(_0x511d33){console['log']('error:\x20',_0x511d33);throw new common_1[(_0x211c66(0x239))](_0x211c66(0x24f),common_1[_0x211c66(0x1dd)]['BAD_REQUEST']);}}async[_0x4bdf9d(0x211)](_0x435d24){const _0x42502f=_0x4bdf9d;return await this[_0x42502f(0x215)][_0x42502f(0x266)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x435d24)}});}async[_0x4bdf9d(0x22a)](_0x299ead,_0xc1e4e1){const _0x29e852=_0x4bdf9d;await this['addBalanceToUser'](_0x299ead,{'model3Count':0x0,'model4Count':0x0,'drawMjCount':_0xc1e4e1}),await this[_0x29e852(0x264)]({'userId':_0x299ead,'rechargeType':balance_constant_1[_0x29e852(0x1e4)]['DRAW_FAIL_REFUND'],'model3Count':0x0,'model4Count':0x0,'drawMjCount':_0xc1e4e1}),common_1[_0x29e852(0x228)]['debug']('用户'+_0x299ead+_0x29e852(0x1df)+_0xc1e4e1,_0x29e852(0x24e));}async[_0x4bdf9d(0x1d0)](){const _0x5853d1=_0x4bdf9d,_0x1af44c=await this[_0x5853d1(0x1fe)][_0x5853d1(0x266)]();if(!_0x1af44c[_0x5853d1(0x206)])return;const _0x25ce81=await this['globalConfigService'][_0x5853d1(0x22d)]([_0x5853d1(0x241)]);if(!_0x25ce81)await this[_0x5853d1(0x222)]['setConfig']({'settings':[{'configKey':_0x5853d1(0x241),'configVal':'1'}]});else throw new common_1['HttpException'](_0x5853d1(0x1f8),common_1[_0x5853d1(0x1dd)]['BAD_REQUEST']);_0x1af44c['forEach'](_0x250b7a=>{const _0x5338f8=_0x5853d1,{id:_0x682e67}=_0x250b7a;this[_0x5338f8(0x21c)][_0x5338f8(0x1ed)]({'where':{'userId':_0x682e67}})[_0x5338f8(0x1e9)](_0x4aed02=>{const _0x3e50d1=_0x5338f8;if(!_0x4aed02)return;this[_0x3e50d1(0x23b)](_0x682e67,_0x4aed02);});});}async['writeOldBalanceToNewTable'](_0x36b836,_0x5f409e){const _0x261a16=_0x4bdf9d,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x5f409e,_0x5d580e=await this[_0x261a16(0x1f4)]['findOne']({'where':{'userId':_0x36b836}}),_0x211a01={'userId':_0x36b836,'model3Count':Number(usesLeft),'model4Count':(_0x5d580e===null||_0x5d580e===void 0x0?void 0x0:_0x5d580e['count'])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x5d580e===null||_0x5d580e===void 0x0?void 0x0:_0x5d580e[_0x261a16(0x244)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0xe24901=await this['userBalanceEntity']['findOne']({'where':{'userId':_0x36b836}});_0xe24901?common_1[_0x261a16(0x228)]['debug']('用户'+_0x36b836+_0x261a16(0x249),_0x261a16(0x24e)):this[_0x261a16(0x215)][_0x261a16(0x230)](_0x211a01)[_0x261a16(0x1e9)](_0x5dcdb6=>{const _0x34cb5d=_0x261a16;common_1['Logger']['debug']('用户'+_0x36b836+_0x34cb5d(0x21f),_0x34cb5d(0x24e));})['catch'](_0x59efd6=>{const _0x21e920=_0x261a16;console[_0x21e920(0x1cc)]('error:\x20',_0x59efd6),common_1['Logger']['debug']('用户'+_0x36b836+_0x21e920(0x25c),_0x21e920(0x24e));});}};UserBalanceService=__decorate([(0x0,common_1[_0x4bdf9d(0x1ee)])(),__param(0x0,(0x0,typeorm_1[_0x4bdf9d(0x231)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1[_0x4bdf9d(0x231)])(userBalance_entity_1['UserBalanceEntity'])),__param(0x2,(0x0,typeorm_1[_0x4bdf9d(0x231)])(accountLog_entity_1[_0x4bdf9d(0x1ff)])),__param(0x3,(0x0,typeorm_1[_0x4bdf9d(0x231)])(cramiPackage_entity_1[_0x4bdf9d(0x207)])),__param(0x4,(0x0,typeorm_1[_0x4bdf9d(0x231)])(config_entity_1['ConfigEntity'])),__param(0x5,(0x0,typeorm_1[_0x4bdf9d(0x231)])(user_entity_1['UserEntity'])),__param(0x6,(0x0,typeorm_1[_0x4bdf9d(0x231)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x4bdf9d(0x1dc)])),__metadata(_0x4bdf9d(0x1d1),[typeorm_2[_0x4bdf9d(0x21d)],typeorm_2['Repository'],typeorm_2[_0x4bdf9d(0x21d)],typeorm_2[_0x4bdf9d(0x21d)],typeorm_2['Repository'],typeorm_2['Repository'],typeorm_2[_0x4bdf9d(0x21d)],typeorm_2[_0x4bdf9d(0x21d)],sales_service_1[_0x4bdf9d(0x20b)],globalConfig_service_1[_0x4bdf9d(0x23a)]])],UserBalanceService),exports[_0x4bdf9d(0x22b)]=UserBalanceService;function _0x31cb(){const _0x4a088f=['registerSendStatus','缺失当前用户账户记录！','69979nzJmWx','useModel3Token','saveRecordRechargeLog','formatDate','find','error:\x20','REG_GIFT','toFixed','cramiPackageEntity','当前套餐不存在！','model4Count','object','firstRregisterSendDrawMjCount','../chatgpt/whiteList.entity','mjDraw','model3','addBalanceToUser','用户充值失败！','createSalesRecords','firstRegisterSendRank','13124772umsopM','userId','log','./balance.entity','非法操作、当前充值套餐暂不存在！','days','upgradeBalance','design:paramtypes','inviteGiveSendModel3Count','INVITE_GIFT','forEach','formatCreateOrUpdateDate','decorate','invitedGuestSendModel3Count','update','32tzvsij','configEntity','4LNYYGA','WhiteListEntity','HttpStatus','total','绘画失败退款--------》','createBaseUserBalance','firstRregisterSendModel3Count','./userBalance.entity','3429055ONNFwU','RechargeType','packageId','sumDrawMjCount','defineProperty','configVal','then','registerSendModel3Count','useModel4Token','user','findOne','Injectable','__esModule','useModel4Count','@nestjs/common','DESC','deductFromBalance','whiteListEntity','memberModel3Count','useDrawMjToken','548187xYoEgO','您已经升级过了、请勿重复操作！','rechargeType','day','configKey','firstRregisterSendModel4Count','drawMjCount','userEntity','AccountLogEntity','---','salesUsersEntity','memberDrawMjCount','function','odel4','includes','length','CramiPackageEntity','validateBalance','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','super','SalesService','add','useModel3Count','PAYMENT_REQUIRED','phone','getOwnPropertyDescriptor','queryUserBalanceByIds','sumModel4Count','注册赠送失败,请联系管理员！','7624rWiifq','userBalanceEntity','MjCount','../crami/cramiPackage.entity','email','充值失败','invitedGuestSendDrawMjCount','isInteger','balanceEntity','Repository','缺失当前套餐ID、充值失败！','旧账户信息迁移成功','findAndCount','weight','globalConfigService','vxNumber','__decorate','model4','充值的工单信息:','reduce','Logger','11yBzRls','refundMjBalance','UserBalanceService','../../common/constants/balance.constant','getConfigs','YYYY-MM-DD\x20HH:mm:ss','format','save','InjectRepository','__metadata','createRandomUid','odel3','memberModel4Count','accountLogEntity','充值失败！','../sales/salesUsers.entity','HttpException','GlobalConfigService','writeOldBalanceToNewTable','goodsId','default','expirationTime','avatar','../globalConfig/config.entity','upgradeStatus','username','model3Count','useCount','10231750tnKHXR','@nestjs/typeorm','REFER_GIFT','>\x20或购买专属套餐\x20！','账户信息已经存在、迁移无效','当前用户无需创建账户信息！','map','metadata','67926DCvErJ','BalanceService','查询用户账户失败！','558wsHvMN','BAD_REQUEST','inviteGiveSendDrawMjCount','registerSendModel4Count','YYYY-MM-DD','invitedGuestSendModel4Count','inviteGiveSendModel4Count','registerSendDrawMjCount','10800pjQhFT','inviteSendStatus','firstRegisterSendStatus','查询用户账户信息失败！','旧账户信息迁移失败','affected','salesService','__param'];_0x31cb=function(){return _0x4a088f;};return _0x31cb();}