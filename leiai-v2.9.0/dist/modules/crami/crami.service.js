'use strict';const _0x1fd2f8=_0x4aea;(function(_0x4afe5f,_0x5462bc){const _0x53eefa=_0x4aea,_0x568427=_0x4afe5f();while(!![]){try{const _0x2aa266=-parseInt(_0x53eefa(0x1f7))/0x1+parseInt(_0x53eefa(0x1e6))/0x2+parseInt(_0x53eefa(0x23b))/0x3*(parseInt(_0x53eefa(0x22d))/0x4)+parseInt(_0x53eefa(0x1f8))/0x5*(parseInt(_0x53eefa(0x1ea))/0x6)+parseInt(_0x53eefa(0x1f6))/0x7+parseInt(_0x53eefa(0x1e5))/0x8*(-parseInt(_0x53eefa(0x204))/0x9)+parseInt(_0x53eefa(0x1fb))/0xa*(-parseInt(_0x53eefa(0x22b))/0xb);if(_0x2aa266===_0x5462bc)break;else _0x568427['push'](_0x568427['shift']());}catch(_0x45af83){_0x568427['push'](_0x568427['shift']());}}}(_0x2896,0x5b836));function _0x4aea(_0x3f2e9d,_0x2ab691){const _0x28967f=_0x2896();return _0x4aea=function(_0x4aea94,_0x4541de){_0x4aea94=_0x4aea94-0x1db;let _0x5480e1=_0x28967f[_0x4aea94];return _0x5480e1;},_0x4aea(_0x3f2e9d,_0x2ab691);}var __decorate=this&&this[_0x1fd2f8(0x1e8)]||function(_0x39bd25,_0x53e083,_0x10307b,_0xf15279){const _0x3aa39e=_0x1fd2f8;var _0x49e939=arguments[_0x3aa39e(0x225)],_0x4bf45e=_0x49e939<0x3?_0x53e083:_0xf15279===null?_0xf15279=Object[_0x3aa39e(0x21c)](_0x53e083,_0x10307b):_0xf15279,_0x49f5d3;if(typeof Reflect===_0x3aa39e(0x237)&&typeof Reflect[_0x3aa39e(0x1f5)]===_0x3aa39e(0x1fd))_0x4bf45e=Reflect[_0x3aa39e(0x1f5)](_0x39bd25,_0x53e083,_0x10307b,_0xf15279);else{for(var _0x7d83d6=_0x39bd25[_0x3aa39e(0x225)]-0x1;_0x7d83d6>=0x0;_0x7d83d6--)if(_0x49f5d3=_0x39bd25[_0x7d83d6])_0x4bf45e=(_0x49e939<0x3?_0x49f5d3(_0x4bf45e):_0x49e939>0x3?_0x49f5d3(_0x53e083,_0x10307b,_0x4bf45e):_0x49f5d3(_0x53e083,_0x10307b))||_0x4bf45e;}return _0x49e939>0x3&&_0x4bf45e&&Object[_0x3aa39e(0x21e)](_0x53e083,_0x10307b,_0x4bf45e),_0x4bf45e;},__metadata=this&&this[_0x1fd2f8(0x20f)]||function(_0x27dd77,_0x434810){const _0xc1bc3a=_0x1fd2f8;if(typeof Reflect===_0xc1bc3a(0x237)&&typeof Reflect['metadata']===_0xc1bc3a(0x1fd))return Reflect[_0xc1bc3a(0x221)](_0x27dd77,_0x434810);},__param=this&&this[_0x1fd2f8(0x1e0)]||function(_0x5cef79,_0x475a2e){return function(_0x42c64c,_0x45dc58){_0x475a2e(_0x42c64c,_0x45dc58,_0x5cef79);};};function _0x2896(){const _0x4a0ef0=['createPackage','queryAllPackage','role','queryAllCrami','username','super','MoreThan','design:paramtypes','forEach','decorate','4874968cyXLwa','43299oSufKk','20pQyqMV','当前套餐不存在、请确认您选择的套餐是否存在！','../userBalance/userBalance.service','2924990CBqHLK','user','function','create','Not','generateCramiCode','count','name','更新套餐失败、请重试！','1620ELhlDj','saveRecordRechargeLog','BAD_REQUEST','createCrami','delete','../user/user.entity','log','当前套餐下存在卡密、请先删除卡密后才可删除套餐！','packageName','find','当前卡密不存在、请确认您要删除的卡密是否存在！','__metadata','maskCrami','updatePackage','HttpException','HttpStatus','email','自定义卡密必须至少一项余额不为0️零！','findOne','packageId','code','当前卡密已被使用、已使用的卡密禁止删除！','UserBalanceService','userEntity','getOwnPropertyDescriptor','push','defineProperty','userBalanceService','affected','metadata','cramiEntity','更新套餐成功！','delPackage','length','CramiService','UserEntity','save','删除卡密成功！','useCrami','77xtbWYv','error:\x20','71596qRVoFs','map','__esModule','findAndCount','RechargeType','generateCrami','addBalanceToUser','./cramiPackage.entity','当前卡密已被使用、请确认您输入的卡密是否正确！','使用卡密成功','object','assign','@nestjs/typeorm','Repository','69DMdFgx','../../common/constants/balance.constant','typeorm','cramiPackageEntity','../../common/utils','./crami.entity','status','__param','DESC','InjectRepository','update','Like','24GuOaST','1388354UVlMzh','maskEmail','__decorate','当前卡密不存在、请确认您输入的卡密是否正确！','995838zzQUyr','PACKAGE_GIFT'];_0x2896=function(){return _0x4a0ef0;};return _0x2896();}Object[_0x1fd2f8(0x21e)](exports,_0x1fd2f8(0x22f),{'value':!![]}),exports[_0x1fd2f8(0x226)]=void 0x0;const common_1=require('@nestjs/common'),crami_entity_1=require(_0x1fd2f8(0x1de)),typeorm_1=require(_0x1fd2f8(0x239)),typeorm_2=require(_0x1fd2f8(0x1db)),cramiPackage_entity_1=require(_0x1fd2f8(0x234)),utils_1=require(_0x1fd2f8(0x1dd)),user_entity_1=require(_0x1fd2f8(0x209)),userBalance_service_1=require(_0x1fd2f8(0x1fa)),balance_constant_1=require(_0x1fd2f8(0x23c));let CramiService=class CramiService{constructor(_0x114bc1,_0x15a7b0,_0x55ea2e,_0x30f166){const _0x509b07=_0x1fd2f8;this['cramiEntity']=_0x114bc1,this[_0x509b07(0x1dc)]=_0x15a7b0,this[_0x509b07(0x21b)]=_0x55ea2e,this[_0x509b07(0x21f)]=_0x30f166;}async['queryOnePackage'](_0xddc14b){const _0x59cc25=_0x1fd2f8;return await this[_0x59cc25(0x1dc)][_0x59cc25(0x216)]({'where':{'id':_0xddc14b}});}async[_0x1fd2f8(0x1ed)](_0x5ea12b){const _0x962696=_0x1fd2f8;try{const {page:page=0x1,size:size=0xa,name:_0x257df2,status:_0x4a6dc9,type:_0x383bcc}=_0x5ea12b,_0x2bb690={};_0x257df2&&Object[_0x962696(0x238)](_0x2bb690,{'name':(0x0,typeorm_2[_0x962696(0x1e4)])('%'+_0x257df2+'%')}),_0x4a6dc9&&Object[_0x962696(0x238)](_0x2bb690,{'status':_0x4a6dc9});_0x383bcc&&(_0x383bcc>0x0?Object['assign'](_0x2bb690,{'days':(0x0,typeorm_2[_0x962696(0x1f2)])(0x0)}):Object[_0x962696(0x238)](_0x2bb690,{'days':(0x0,typeorm_2['LessThanOrEqual'])(0x0)}));const [_0x269b16,_0x5f302c]=await this[_0x962696(0x1dc)][_0x962696(0x230)]({'skip':(page-0x1)*size,'take':size,'where':_0x2bb690,'order':{'order':_0x962696(0x1e1)}});return{'rows':_0x269b16,'count':_0x5f302c};}catch(_0x1d20c9){console[_0x962696(0x20a)]('error:\x20',_0x1d20c9);}}async[_0x1fd2f8(0x1ec)](_0x2f2263){const _0x536647=_0x1fd2f8,{name:_0xec8a0f,weight:_0x2f7725}=_0x2f2263,_0x501a19=await this[_0x536647(0x1dc)][_0x536647(0x216)]({'where':[{'name':_0xec8a0f},{'weight':_0x2f7725}]});if(_0x501a19)throw new common_1['HttpException']('套餐名称或套餐等级重复、请检查！',common_1[_0x536647(0x213)]['BAD_REQUEST']);try{return await this['cramiPackageEntity'][_0x536647(0x228)](_0x2f2263);}catch(_0x4fa4b3){console[_0x536647(0x20a)](_0x536647(0x22c),_0x4fa4b3);throw new common_1[(_0x536647(0x212))](_0x4fa4b3,common_1[_0x536647(0x213)]['BAD_REQUEST']);}}async[_0x1fd2f8(0x211)](_0x359acc){const _0x34a744=_0x1fd2f8,{id:_0x4e77bd,name:_0x1312f5,weight:_0x5bb722}=_0x359acc,_0x42c189=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x4e77bd}});if(!_0x42c189)throw new common_1['HttpException']('当前套餐不存在、请检查你的输入参数！',common_1[_0x34a744(0x213)][_0x34a744(0x206)]);const _0x49cd6b=await this[_0x34a744(0x1dc)][_0x34a744(0x201)]({'where':[{'name':_0x1312f5,'id':(0x0,typeorm_2[_0x34a744(0x1ff)])(_0x4e77bd)},{'weight':_0x5bb722,'id':(0x0,typeorm_2[_0x34a744(0x1ff)])(_0x4e77bd)}]});if(_0x49cd6b)throw new common_1['HttpException']('套餐名称或套餐等级重复、请检查！',common_1[_0x34a744(0x213)][_0x34a744(0x206)]);const _0x511ef2=await this['cramiPackageEntity']['update']({'id':_0x4e77bd},_0x359acc);if(_0x511ef2[_0x34a744(0x220)]>0x0)return _0x34a744(0x223);else throw new common_1[(_0x34a744(0x212))](_0x34a744(0x203),common_1[_0x34a744(0x213)][_0x34a744(0x206)]);}async[_0x1fd2f8(0x224)](_0x13cfd2){const _0x37421a=_0x1fd2f8,{id:_0x344296}=_0x13cfd2,_0x7214f1=await this['cramiEntity'][_0x37421a(0x201)]({'where':{'packageId':_0x344296}});if(_0x7214f1)throw new common_1[(_0x37421a(0x212))](_0x37421a(0x20b),common_1['HttpStatus'][_0x37421a(0x206)]);return await this['cramiPackageEntity'][_0x37421a(0x208)]({'id':_0x344296});}async[_0x1fd2f8(0x207)](_0x12d0e3){const _0x31c3f8=_0x1fd2f8,{packageId:_0x1b1824,count:count=0x1}=_0x12d0e3;if(_0x1b1824){const _0x54eac8=await this['cramiPackageEntity'][_0x31c3f8(0x216)]({'where':{'id':_0x1b1824}});if(!_0x54eac8)throw new common_1[(_0x31c3f8(0x212))](_0x31c3f8(0x1f9),common_1[_0x31c3f8(0x213)][_0x31c3f8(0x206)]);const {days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x54eac8,_0x526f32={'packageId':_0x1b1824,'days':days,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x31c3f8(0x232)](_0x526f32,count);}if(!_0x1b1824){const {model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x12d0e3;if([model3Count,model4Count,drawMjCount]['every'](_0x3197eb=>!_0x3197eb))throw new common_1['HttpException'](_0x31c3f8(0x215),common_1[_0x31c3f8(0x213)][_0x31c3f8(0x206)]);const _0x39d3f5={'days':-0x1,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount};return await this[_0x31c3f8(0x232)](_0x39d3f5,count);}}async[_0x1fd2f8(0x232)](_0x4ded79,_0x1054ef){const _0x2be9c0=_0x1fd2f8,_0x5315a1=[];for(let _0x167c15=0x0;_0x167c15<_0x1054ef;_0x167c15++){const _0x5a823e=(0x0,utils_1[_0x2be9c0(0x200)])(),_0x1ac305=this[_0x2be9c0(0x222)][_0x2be9c0(0x1fe)](Object[_0x2be9c0(0x238)](Object[_0x2be9c0(0x238)]({},_0x4ded79),{'code':_0x5a823e}));_0x5315a1[_0x2be9c0(0x21d)](_0x1ac305);}return await this[_0x2be9c0(0x222)]['save'](_0x5315a1);}async[_0x1fd2f8(0x22a)](_0x3af006,_0x110e54){const _0x759e19=_0x1fd2f8,{id:_0xfbd7fc}=_0x3af006[_0x759e19(0x1fc)],_0x72f56e=await this[_0x759e19(0x222)]['findOne']({'where':{'code':_0x110e54['code']}});if(!_0x72f56e)throw new common_1[(_0x759e19(0x212))](_0x759e19(0x1e9),common_1[_0x759e19(0x213)][_0x759e19(0x206)]);const {status:_0x37728e,days:days=-0x1,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0,packageId:_0x4d2cd8}=_0x72f56e;if(_0x37728e===0x1)throw new common_1[(_0x759e19(0x212))](_0x759e19(0x235),common_1[_0x759e19(0x213)]['BAD_REQUEST']);const _0x8c838b={'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'packageId':_0x4d2cd8};return await this['userBalanceService'][_0x759e19(0x233)](_0xfbd7fc,Object[_0x759e19(0x238)]({},_0x8c838b),days),await this[_0x759e19(0x21f)][_0x759e19(0x205)]({'userId':_0xfbd7fc,'rechargeType':balance_constant_1[_0x759e19(0x231)][_0x759e19(0x1eb)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'days':days}),await this[_0x759e19(0x222)][_0x759e19(0x1e3)]({'code':_0x110e54['code']},{'useId':_0xfbd7fc,'status':0x1}),_0x759e19(0x236);}async[_0x1fd2f8(0x1ef)](_0xf4efe3,_0x64c4fc){const _0x5da1a6=_0x1fd2f8,{page:page=0x1,size:size=0xa,status:_0x182ef5,useId:_0x24eb50}=_0xf4efe3,_0x23b4e8={};_0x182ef5&&Object[_0x5da1a6(0x238)](_0x23b4e8,{'status':_0x182ef5}),_0x24eb50&&Object[_0x5da1a6(0x238)](_0x23b4e8,{'useId':_0x24eb50});const [_0x133425,_0x4352fc]=await this[_0x5da1a6(0x222)][_0x5da1a6(0x230)]({'skip':(page-0x1)*size,'take':size,'order':{'createdAt':'DESC'},'where':_0x23b4e8}),_0x2210f4=_0x133425['map'](_0x4906c0=>_0x4906c0['useId']),_0x23e12c=_0x133425[_0x5da1a6(0x22e)](_0x1ebbac=>_0x1ebbac[_0x5da1a6(0x217)]),_0x5a1e87=await this[_0x5da1a6(0x21b)][_0x5da1a6(0x20d)]({'where':{'id':(0x0,typeorm_2['In'])(_0x2210f4)}}),_0x556f69=await this[_0x5da1a6(0x1dc)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x23e12c)}});return _0x133425[_0x5da1a6(0x1f4)](_0x3377a7=>{const _0x5ad201=_0x5da1a6;var _0x5a8fc9,_0x1902d1,_0x413407;_0x3377a7[_0x5ad201(0x1f0)]=(_0x5a8fc9=_0x5a1e87['find'](_0x189645=>_0x189645['id']===_0x3377a7['useId']))===null||_0x5a8fc9===void 0x0?void 0x0:_0x5a8fc9[_0x5ad201(0x1f0)],_0x3377a7[_0x5ad201(0x214)]=(_0x1902d1=_0x5a1e87['find'](_0x497d18=>_0x497d18['id']===_0x3377a7['useId']))===null||_0x1902d1===void 0x0?void 0x0:_0x1902d1[_0x5ad201(0x214)],_0x3377a7[_0x5ad201(0x20c)]=(_0x413407=_0x556f69[_0x5ad201(0x20d)](_0x2681a4=>_0x2681a4['id']===_0x3377a7[_0x5ad201(0x217)]))===null||_0x413407===void 0x0?void 0x0:_0x413407[_0x5ad201(0x202)];}),_0x64c4fc['user']['role']!==_0x5da1a6(0x1f1)&&_0x133425[_0x5da1a6(0x1f4)](_0x33a5eb=>_0x33a5eb[_0x5da1a6(0x214)]=(0x0,utils_1[_0x5da1a6(0x1e7)])(_0x33a5eb['email'])),_0x64c4fc[_0x5da1a6(0x1fc)][_0x5da1a6(0x1ee)]!==_0x5da1a6(0x1f1)&&_0x133425['forEach'](_0x25b0a0=>_0x25b0a0[_0x5da1a6(0x218)]=(0x0,utils_1[_0x5da1a6(0x210)])(_0x25b0a0[_0x5da1a6(0x218)])),{'rows':_0x133425,'count':_0x4352fc};}async['delCrami'](_0x28a2a4){const _0x453ec5=_0x1fd2f8,_0x22b277=await this['cramiEntity'][_0x453ec5(0x216)]({'where':{'id':_0x28a2a4}});if(!_0x22b277)throw new common_1['HttpException'](_0x453ec5(0x20e),common_1[_0x453ec5(0x213)][_0x453ec5(0x206)]);if(_0x22b277[_0x453ec5(0x1df)]===0x1)throw new common_1['HttpException'](_0x453ec5(0x219),common_1['HttpStatus'][_0x453ec5(0x206)]);return await this[_0x453ec5(0x222)][_0x453ec5(0x208)]({'id':_0x28a2a4});}async['batchDelCrami'](_0x4273ef){const _0x31afcb=_0x1fd2f8,{ids:_0x52a2ef}=_0x4273ef,_0x2592b5=await this[_0x31afcb(0x222)]['delete'](_0x52a2ef);if(_0x2592b5[_0x31afcb(0x220)]>0x0)return _0x31afcb(0x229);else throw new common_1[(_0x31afcb(0x212))]('删除卡密失败、请重试！',common_1['HttpStatus'][_0x31afcb(0x206)]);}};CramiService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1fd2f8(0x1e2)])(crami_entity_1['CramiEntity'])),__param(0x1,(0x0,typeorm_1[_0x1fd2f8(0x1e2)])(cramiPackage_entity_1['CramiPackageEntity'])),__param(0x2,(0x0,typeorm_1[_0x1fd2f8(0x1e2)])(user_entity_1[_0x1fd2f8(0x227)])),__metadata(_0x1fd2f8(0x1f3),[typeorm_2[_0x1fd2f8(0x23a)],typeorm_2[_0x1fd2f8(0x23a)],typeorm_2[_0x1fd2f8(0x23a)],userBalance_service_1[_0x1fd2f8(0x21a)]])],CramiService),exports[_0x1fd2f8(0x226)]=CramiService;