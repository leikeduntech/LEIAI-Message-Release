'use strict';function _0x341a(_0x1a2e12,_0x876c23){const _0x1c3e7c=_0x1c3e();return _0x341a=function(_0x341a56,_0x3416ec){_0x341a56=_0x341a56-0x8c;let _0x149a74=_0x1c3e7c[_0x341a56];return _0x149a74;},_0x341a(_0x1a2e12,_0x876c23);}const _0x38241c=_0x341a;(function(_0x2932a8,_0x2735be){const _0x2d5d3e=_0x341a,_0x416299=_0x2932a8();while(!![]){try{const _0x252257=parseInt(_0x2d5d3e(0xe2))/0x1*(-parseInt(_0x2d5d3e(0x10a))/0x2)+-parseInt(_0x2d5d3e(0xa6))/0x3*(-parseInt(_0x2d5d3e(0xfa))/0x4)+parseInt(_0x2d5d3e(0xb7))/0x5*(-parseInt(_0x2d5d3e(0xbf))/0x6)+-parseInt(_0x2d5d3e(0x106))/0x7+parseInt(_0x2d5d3e(0xb3))/0x8*(-parseInt(_0x2d5d3e(0xc9))/0x9)+parseInt(_0x2d5d3e(0xef))/0xa+-parseInt(_0x2d5d3e(0x8d))/0xb*(-parseInt(_0x2d5d3e(0xb1))/0xc);if(_0x252257===_0x2735be)break;else _0x416299['push'](_0x416299['shift']());}catch(_0x1ad2fb){_0x416299['push'](_0x416299['shift']());}}}(_0x1c3e,0x3a4b5));function _0x1c3e(){const _0x2734da=['非法操作、请联系管理员！','./../verification/verification.service','33LoJWme','internal','ttl','getConfigs','updatePassword','registerFailEmailTeamName','VerificationService','client','../redisCache/redisCache.service','registerSuccessEmaileAppend','&registerFailEmailTitle=','forEach','saveToken','reduce','@nestjs/typeorm','captcha','verificationService','set','getInfo','VerificationEnum','verifyUserRegisterByPhone','avatar','hashSync','text','InjectRepository','120fgJgib','sendPhoneCode','configVal','updatePassByOther','globalConfigService','createRandomCode','__esModule','configKey','createUserAndVerifycation','family','无权此操作！','405840GQznCH','Registration','7112WyfbZP','MailerService','address','getUserStatus','145LAIaVO','activateAccount','addBalanceToNewUser','/api/auth/registerError?message=','createRandomUid','user','verifyCaptcha','Repository','7020lRRSTW','login','queryUserInfoById',':PHONECODE:','savaLoginIp','&username=','defineProperty','旧密码错误、请检查提交','metadata','验证码类型错误','945oZTVgD','getClientIp','#fff','loginByPhone','register','redisCacheService','BAD_REQUEST','验证码已过期、请重新发送！','qureyUserInfoByInviteCode','userId','UserService','function','@nestjs/common','账户已被激活过','registerFailEmailTitle','createUser','@nestjs/jwt','HttpException','updateUserStatus','127.0.0.1','loginByOpenId','registerByPhone','sign','UserStatusEnum','onModuleInit','4195LECGoF','padStart','/api/auth/registerSuccess?id=','log','IPv4','getUserInfo','object','密码修改成功','userService','design:paramtypes','@leiai.com','decorate','messageInfo:\x20','1763660IPSeoZ','GlobalConfigService','userBalanceService','registerSuccessEmailTitle','__param','getIp','../globalConfig/globalConfig.service','getNamespace','mailerService','response','find','24968IQGxhf','秒内不得重复发送短信！','../userBalance/userBalance.service',':CAPTCHA:','bcryptjs','userDefautlAvatar','password','redirect','ACTIVE','../user/user.service','AuthService','svg-captcha','836556OrIPyc','verifyUserPassword','verifyUserCredentials','configEntity','20nYkdqL','../../common/utils','jwtService','HttpStatus','../../common/constants/user.constant','updateUserPassword','verifyCode','RedisCacheService','length'];_0x1c3e=function(){return _0x2734da;};return _0x1c3e();}var __decorate=this&&this['__decorate']||function(_0x37d097,_0x251d59,_0xf1d58a,_0x7b9575){const _0x26a3c3=_0x341a;var _0x2a807a=arguments[_0x26a3c3(0x112)],_0x39bfb5=_0x2a807a<0x3?_0x251d59:_0x7b9575===null?_0x7b9575=Object['getOwnPropertyDescriptor'](_0x251d59,_0xf1d58a):_0x7b9575,_0xaa18eb;if(typeof Reflect==='object'&&typeof Reflect[_0x26a3c3(0xed)]===_0x26a3c3(0xd4))_0x39bfb5=Reflect['decorate'](_0x37d097,_0x251d59,_0xf1d58a,_0x7b9575);else{for(var _0x42e6c8=_0x37d097[_0x26a3c3(0x112)]-0x1;_0x42e6c8>=0x0;_0x42e6c8--)if(_0xaa18eb=_0x37d097[_0x42e6c8])_0x39bfb5=(_0x2a807a<0x3?_0xaa18eb(_0x39bfb5):_0x2a807a>0x3?_0xaa18eb(_0x251d59,_0xf1d58a,_0x39bfb5):_0xaa18eb(_0x251d59,_0xf1d58a))||_0x39bfb5;}return _0x2a807a>0x3&&_0x39bfb5&&Object[_0x26a3c3(0xc5)](_0x251d59,_0xf1d58a,_0x39bfb5),_0x39bfb5;},__metadata=this&&this['__metadata']||function(_0x44f194,_0x23bc0c){const _0xbe4d63=_0x341a;if(typeof Reflect===_0xbe4d63(0xe8)&&typeof Reflect['metadata']===_0xbe4d63(0xd4))return Reflect[_0xbe4d63(0xc7)](_0x44f194,_0x23bc0c);},__param=this&&this[_0x38241c(0xf3)]||function(_0x57201a,_0x38c1d7){return function(_0x1012a3,_0x368e8c){_0x38c1d7(_0x1012a3,_0x368e8c,_0x57201a);};};Object[_0x38241c(0xc5)](exports,_0x38241c(0xac),{'value':!![]}),exports[_0x38241c(0x104)]=void 0x0;const globalConfig_service_1=require(_0x38241c(0xf5)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x38241c(0x8c)),common_1=require(_0x38241c(0xd5)),jwt_1=require(_0x38241c(0xd9)),user_service_1=require(_0x38241c(0x103)),mailer_service_1=require('../mailer/mailer.service'),user_constant_1=require(_0x38241c(0x10e)),userBalance_service_1=require(_0x38241c(0xfc)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require('typeorm'),typeorm_2=require(_0x38241c(0x9b)),utils_1=require(_0x38241c(0x10b)),os=require('os'),redisCache_service_1=require(_0x38241c(0x95)),svgCaptcha=require(_0x38241c(0x105)),bcrypt=require(_0x38241c(0xfe));let AuthService=class AuthService{constructor(_0x26d2ee,_0x2128de,_0x3ac83b,_0x21214c,_0x1f47ec,_0x31157c,_0x100d14,_0x20d758){const _0x1dabf1=_0x38241c;this['configEntity']=_0x26d2ee,this[_0x1dabf1(0xea)]=_0x2128de,this[_0x1dabf1(0x10c)]=_0x3ac83b,this[_0x1dabf1(0xf7)]=_0x21214c,this[_0x1dabf1(0x9d)]=_0x1f47ec,this[_0x1dabf1(0xf1)]=_0x31157c,this['redisCacheService']=_0x100d14,this[_0x1dabf1(0xaa)]=_0x20d758;}async[_0x38241c(0xe1)](){const _0x2d829e=_0x38241c;this[_0x2d829e(0xf4)]();}async[_0x38241c(0xcd)](_0x5da227,_0x519b72){const _0x2a213c=_0x38241c;await this[_0x2a213c(0x9d)][_0x2a213c(0xbd)](_0x5da227);const _0x5b9990=await this[_0x2a213c(0xea)][_0x2a213c(0xae)](_0x5da227,_0x519b72),{username:_0x4475cd,email:_0x3dafc8,client:_0x283d89,id:_0x2292c4}=_0x5b9990,_0x3f4346={'username':_0x4475cd,'email':_0x3dafc8,'id':_0x2292c4};return _0x283d89&&(_0x3f4346[_0x2a213c(0x94)]=_0x283d89),_0x3f4346;}async[_0x38241c(0xde)](_0x237861,_0x492358){const _0x26fc7e=_0x38241c,{username:_0x268b8c,password:_0x15fc91,phone:_0x53a89f,phoneCode:_0x3692f9,invitedBy:_0x4d25e1}=_0x237861;await this[_0x26fc7e(0xea)][_0x26fc7e(0xa1)](_0x237861);const _0x4f3b13=await this[_0x26fc7e(0xaa)][_0x26fc7e(0xf6)](),_0x4a7f0a=_0x4f3b13+_0x26fc7e(0xc2)+_0x53a89f,_0x215a8a=await this[_0x26fc7e(0xce)]['get']({'key':_0x4a7f0a});if(!_0x215a8a)throw new common_1[(_0x26fc7e(0xda))](_0x26fc7e(0xd0),common_1[_0x26fc7e(0x10d)]['BAD_REQUEST']);if(_0x3692f9!==_0x215a8a)throw new common_1[(_0x26fc7e(0xda))]('验证码填写错误、请重新输入！',common_1[_0x26fc7e(0x10d)][_0x26fc7e(0xcf)]);const _0x314728=(0x0,utils_1[_0x26fc7e(0xbb)])()+_0x26fc7e(0xec),_0xcc5e81={'username':_0x268b8c,'password':_0x15fc91,'phone':_0x53a89f,'invitedBy':_0x4d25e1,'email':_0x314728,'status':user_constant_1[_0x26fc7e(0xe0)][_0x26fc7e(0x102)]},_0x37915d=await this['globalConfigService'][_0x26fc7e(0x90)]([_0x26fc7e(0xff)]);_0xcc5e81[_0x26fc7e(0xa2)]=_0x37915d;const _0x391a03=bcrypt[_0x26fc7e(0xa3)](_0x15fc91,0xa);_0xcc5e81[_0x26fc7e(0x100)]=_0x391a03;const _0x4d0fad=await this[_0x26fc7e(0xea)][_0x26fc7e(0xd8)](_0xcc5e81);let _0x27096b;_0x4d25e1&&(_0x27096b=await this['userService']['qureyUserInfoByInviteCode'](_0x4d25e1));await this[_0x26fc7e(0xf1)][_0x26fc7e(0xb9)](_0x4d0fad['id'],_0x27096b===null||_0x27096b===void 0x0?void 0x0:_0x27096b['id']),console['log']('输入一样进入注册流程');return;}async[_0x38241c(0xc0)](_0x377499,_0x38e127){const _0x296bf2=_0x38241c,_0x26edd3=await this[_0x296bf2(0xea)][_0x296bf2(0x108)](_0x377499),{username:_0x54fa31,id:_0x4e909b,email:_0x54830b,role:_0x3b279b,openId:_0x26ee88,client:_0x464fde}=_0x26edd3,_0x43135c=(0x0,utils_1[_0x296bf2(0xca)])(_0x38e127);await this[_0x296bf2(0xea)]['savaLoginIp'](_0x4e909b,_0x43135c);const _0x4cdd1e=await this['jwtService']['sign']({'username':_0x54fa31,'id':_0x4e909b,'email':_0x54830b,'role':_0x3b279b,'openId':_0x26ee88,'client':_0x464fde});return await this[_0x296bf2(0xce)]['saveToken'](_0x4e909b,_0x4cdd1e),_0x4cdd1e;}async[_0x38241c(0xcc)](_0xf3fe5f,_0x3df3d7){const _0x5b6237=_0x38241c,_0x42bb69=await this['userService'][_0x5b6237(0x108)](_0xf3fe5f),{username:_0x177848,id:_0x7a6d92,email:_0x13f273,role:_0x4f02a8,openId:_0x29465a,client:_0x4ed5ea}=_0x42bb69,_0x1f1166=(0x0,utils_1['getClientIp'])(_0x3df3d7);await this[_0x5b6237(0xea)]['savaLoginIp'](_0x7a6d92,_0x1f1166);const {phone:_0x8f7945}=_0xf3fe5f,_0x39ae82=await this[_0x5b6237(0x10c)][_0x5b6237(0xdf)]({'username':_0x177848,'id':_0x7a6d92,'email':_0x13f273,'role':_0x4f02a8,'openId':_0x29465a,'client':_0x4ed5ea,'phone':_0x8f7945});return await this[_0x5b6237(0xce)]['saveToken'](_0x7a6d92,_0x39ae82),_0x39ae82;}async[_0x38241c(0xdd)](_0x39d479,_0x8df168){const _0x12b05b=_0x38241c,{status:_0x5a5026}=_0x39d479;if(_0x5a5026!==user_constant_1[_0x12b05b(0xe0)]['ACTIVE'])throw new common_1['HttpException'](user_constant_1['UserStatusErrMsg'][_0x5a5026],common_1[_0x12b05b(0x10d)][_0x12b05b(0xcf)]);const {username:_0x43e46c,id:_0x95f9a2,email:_0x2fc30e,role:_0xda3d47,openId:_0x57c641,client:_0x167dc7}=_0x39d479,_0x46f1a5=(0x0,utils_1['getClientIp'])(_0x8df168);await this[_0x12b05b(0xea)][_0x12b05b(0xc3)](_0x95f9a2,_0x46f1a5);const _0x1105c0=await this[_0x12b05b(0x10c)][_0x12b05b(0xdf)]({'username':_0x43e46c,'id':_0x95f9a2,'email':_0x2fc30e,'role':_0xda3d47,'openId':_0x57c641,'client':_0x167dc7});return await this[_0x12b05b(0xce)][_0x12b05b(0x99)](_0x95f9a2,_0x1105c0),_0x1105c0;}async[_0x38241c(0x9f)](_0x3c6b4a){const _0x35dbac=_0x38241c,{id:_0x5d7192}=_0x3c6b4a['user'];return await this[_0x35dbac(0xea)][_0x35dbac(0xe7)](_0x5d7192);}async[_0x38241c(0xb8)](_0x44cf58,_0x1c2333){const _0x2cd25e=_0x38241c,_0x59f361=await this[_0x2cd25e(0x109)][_0x2cd25e(0xf9)]({'where':{'configKey':(0x0,typeorm_1['In'])([_0x2cd25e(0xf2),'registerSuccessEmailTeamName',_0x2cd25e(0x96),_0x2cd25e(0xd7),_0x2cd25e(0x92)])}}),_0x1648bd=_0x59f361[_0x2cd25e(0x9a)]((_0x19003c,_0xdfec06)=>{const _0x4c213c=_0x2cd25e;return _0x19003c[_0xdfec06[_0x4c213c(0xad)]]=_0xdfec06[_0x4c213c(0xa8)],_0x19003c;},{});try{const _0x419cc1=await this['verificationService'][_0x2cd25e(0x110)](_0x44cf58,verification_constant_1[_0x2cd25e(0xa0)][_0x2cd25e(0xb2)]),{type:_0x456613,userId:_0x5c5660}=_0x419cc1;if(_0x456613!==verification_constant_1[_0x2cd25e(0xa0)][_0x2cd25e(0xb2)])throw new common_1[(_0x2cd25e(0xda))](_0x2cd25e(0xc8),common_1[_0x2cd25e(0x10d)]['BAD_REQUEST']);const _0x4d1d5a=await this[_0x2cd25e(0xea)][_0x2cd25e(0xb6)](_0x5c5660);if(_0x4d1d5a===user_constant_1[_0x2cd25e(0xe0)][_0x2cd25e(0x102)])throw new common_1[(_0x2cd25e(0xda))](_0x2cd25e(0xd6),common_1[_0x2cd25e(0x10d)][_0x2cd25e(0xcf)]);await this['userService'][_0x2cd25e(0xdb)](_0x419cc1[_0x2cd25e(0xd2)],user_constant_1['UserStatusEnum']['ACTIVE']);const _0x3b3eb0=await this['userService'][_0x2cd25e(0xc1)](_0x419cc1[_0x2cd25e(0xd2)]),{username:_0xc65b16,email:_0x2852c4,id:_0x13d93b,invitedBy:_0x2737ff}=_0x3b3eb0;let _0x5402bf;_0x2737ff&&(_0x5402bf=await this[_0x2cd25e(0xea)][_0x2cd25e(0xd1)](_0x2737ff)),await this[_0x2cd25e(0xf1)]['addBalanceToNewUser'](_0x13d93b,_0x5402bf===null||_0x5402bf===void 0x0?void 0x0:_0x5402bf['id']),_0x1c2333[_0x2cd25e(0x101)](_0x2cd25e(0xe4)+_0x13d93b['toString']()[_0x2cd25e(0xe3)](0x4,'0')+_0x2cd25e(0xc4)+_0xc65b16+'&email='+_0x2852c4+'&registerSuccessEmailTitle='+_0x1648bd['registerSuccessEmailTitle']+'&registerSuccessEmailTeamName='+_0x1648bd['registerSuccessEmailTeamName']+'&registerSuccessEmaileAppend='+_0x1648bd[_0x2cd25e(0x96)]);}catch(_0x4b705b){console[_0x2cd25e(0xe5)]('error:\x20',_0x4b705b);const _0x51f5cc=_0x4b705b[_0x2cd25e(0xf8)];_0x1c2333[_0x2cd25e(0x101)](_0x2cd25e(0xba)+_0x51f5cc+_0x2cd25e(0x97)+_0x1648bd['registerFailEmailTitle']+'&registerFailEmailTeamName='+_0x1648bd['registerFailEmailTeamName']);}}async[_0x38241c(0x91)](_0x4261bf,_0x8d7b46){const _0xec3452=_0x38241c,{id:_0x2f4645,client:_0x599ea9,role:_0x2a71ec}=_0x4261bf[_0xec3452(0xbc)];if(_0x599ea9&&Number(_0x599ea9)>0x0)throw new common_1[(_0xec3452(0xda))]('无权此操作、请联系管理员！',common_1['HttpStatus'][_0xec3452(0xcf)]);if(_0x2a71ec==='admin')throw new common_1[(_0xec3452(0xda))](_0xec3452(0x113),common_1['HttpStatus']['BAD_REQUEST']);const _0x4720c0=await this[_0xec3452(0xea)][_0xec3452(0x107)](_0x2f4645,_0x8d7b46['oldPassword']);if(!_0x4720c0)throw new common_1[(_0xec3452(0xda))](_0xec3452(0xc6),common_1[_0xec3452(0x10d)][_0xec3452(0xcf)]);return this[_0xec3452(0xea)]['updateUserPassword'](_0x2f4645,_0x8d7b46[_0xec3452(0x100)]),_0xec3452(0xe9);}async[_0x38241c(0xa9)](_0x1c2718,_0x48c637){const _0x419fbc=_0x38241c,{id:_0x3629b6,client:_0x30e60d}=_0x1c2718[_0x419fbc(0xbc)];if(!_0x30e60d)throw new common_1[(_0x419fbc(0xda))](_0x419fbc(0xb0),common_1[_0x419fbc(0x10d)][_0x419fbc(0xcf)]);return this[_0x419fbc(0xea)][_0x419fbc(0x10f)](_0x3629b6,_0x48c637[_0x419fbc(0x100)]),_0x419fbc(0xe9);}['getIp'](){const _0x118c87=_0x38241c;let _0x4d7cfa;const _0x3ed0ef=os['networkInterfaces']();Object['keys'](_0x3ed0ef)[_0x118c87(0x98)](_0x121e65=>{const _0x4df39e=_0x118c87,_0x11f1ef=_0x3ed0ef[_0x121e65];for(let _0x21a9ad=0x0;_0x21a9ad<_0x11f1ef[_0x4df39e(0x112)];_0x21a9ad++){const _0x543658=_0x11f1ef[_0x21a9ad];if(_0x543658[_0x4df39e(0xaf)]===_0x4df39e(0xe6)&&_0x543658[_0x4df39e(0xb5)]!==_0x4df39e(0xdc)&&!_0x543658[_0x4df39e(0x8e)]){_0x4d7cfa=_0x543658[_0x4df39e(0xb5)];break;}}}),this['ipAddress']=_0x4d7cfa;}async[_0x38241c(0x9c)](_0x19322d){const _0x20ba75=_0x38241c,_0x5d2e32=await this['globalConfigService'][_0x20ba75(0xf6)](),{color:color=_0x20ba75(0xcb)}=_0x19322d,_0x5a24aa=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x891e7c=_0x5a24aa[_0x20ba75(0xa4)],_0x4bb618=(0x0,utils_1[_0x20ba75(0xbb)])(),_0x5517b9=_0x5d2e32+_0x20ba75(0xfd)+_0x4bb618;return await this[_0x20ba75(0xce)][_0x20ba75(0x9e)]({'key':_0x5517b9,'val':_0x5a24aa[_0x20ba75(0xa4)]},0x5*0x3c),{'svgCode':_0x5a24aa['data'],'code':_0x4bb618};}async[_0x38241c(0xa7)](_0x4a4d01){const _0x4a0143=_0x38241c;await this[_0x4a0143(0x9d)][_0x4a0143(0xbd)](_0x4a4d01);const {phone:_0x35ee49}=_0x4a4d01,_0x4180e9=await this[_0x4a0143(0xaa)][_0x4a0143(0xf6)](),_0x483971=_0x4180e9+':PHONECODE:'+_0x35ee49,_0x57fbfb=await this[_0x4a0143(0xce)][_0x4a0143(0x8f)](_0x483971);if(_0x57fbfb&&_0x57fbfb>0x0)throw new common_1[(_0x4a0143(0xda))](_0x57fbfb+_0x4a0143(0xfb),common_1['HttpStatus'][_0x4a0143(0xcf)]);const _0x560433=(0x0,utils_1[_0x4a0143(0xab)])(),_0x42a2ed={'phone':_0x35ee49,'code':_0x560433};return console[_0x4a0143(0xe5)](_0x4a0143(0xee),_0x42a2ed),await this[_0x4a0143(0x9d)][_0x4a0143(0xa7)](_0x42a2ed),await this[_0x4a0143(0xce)][_0x4a0143(0x9e)]({'key':_0x483971,'val':_0x560433},0x1*0x3c),'验证码发送成功、请填写验证码完成注册！';}};AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_2[_0x38241c(0xa5)])(config_entity_1['ConfigEntity'])),__metadata(_0x38241c(0xeb),[typeorm_1[_0x38241c(0xbe)],user_service_1[_0x38241c(0xd3)],jwt_1['JwtService'],mailer_service_1[_0x38241c(0xb4)],verification_service_1[_0x38241c(0x93)],userBalance_service_1['UserBalanceService'],redisCache_service_1[_0x38241c(0x111)],globalConfig_service_1[_0x38241c(0xf0)]])],AuthService),exports['AuthService']=AuthService;