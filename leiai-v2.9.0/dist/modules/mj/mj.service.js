'use strict';function _0x123c(_0x579fa3,_0x3e0721){const _0x2717ff=_0x2717();return _0x123c=function(_0x123c1a,_0x50635e){_0x123c1a=_0x123c1a-0x102;let _0x25951f=_0x2717ff[_0x123c1a];return _0x25951f;},_0x123c(_0x579fa3,_0x3e0721);}function _0x2717(){const _0x3fe159=['error:\x20','url','globalConfigService','变换当前图片失败','balanceEntity','enlargeWorking','\x20请求过于频繁！','历史记录中不存在当前图片、请确认您需要变换的图片是否存在','find','admin','execute','user','message_id','extractContent','Injectable','1110475002349895680','metadata','message','deductBalance','sendSmInteractions','floor','https://discord.com/api/v9/channels/','randomId:\x20','您当前暂无MJ绘画余额！！！','getOwnPropertyDescriptor','BadwordsService','拿到了远程地址:\x20','../chatLog/chatLog.service','push','enlarge','UploadService','\x20队列+1:\x20','@nestjs/common','post','prompt','design:paramtypes','187315uabSoM','5PYbUPP','axios','\x20次开始查询[变换图片]','replace','INTERNAL_SERVER_ERROR','createRandomUid','秒请求一次、请合理使用！','当前用户','pollForResult','__param','1812042zNRFng','您的绘画描述词中含有不合规信息、请检查后重新提交！','8vUYJWQ','绘画失败','mjApplicationId','../badwords/badwords.service','sleep','放大单张图片请求失败...','Repository','mjProxy','当前图片没有绘画信息、无法放大!','mjChannelId','getConfigs','mjGuildId','当前图片已经放大过了、请勿重复放大!','log','mjDraw','MjService','BalanceEntity','查询绘制结果失败...','filter','map','uploadService','PAINT_TYPE','findOne','balance\x20-\x201','match','chatLogService','../../common/utils','set','mjservice','badwordsService','历史中存在当前图片、直接获取！','1092279447287246858','update','baiduFanyiAppId','get','axios:\x20','userId\x20=\x20:userId','936929561302675456','max','freeQueueUsers','findCurrentPromptResult','response','fanyiService','../userBalance/balance.entity','drawWorking','1650005elVyfp','createQueryBuilder','Like','findCurrentEnlargeImgResult','object','saveChatLog','绘图指令完成','getClientIp','放大custom_id:\x20','1092279447287246861','components','test','getMjDefaultParams','mjAuthorization','queryMessageList','355708UepzEO','__decorate','pollForVariationResult','prompt\x20-------->\x20\x20','variationSingleImg','1517478vQkfqc','发送绘画指令结果:\x20','1684829289827uhu2txioioynv86vtsp','InjectRepository','stringify','imagine','HttpStatus','IsNull','MJ::JOB::variation::2::fed9bb0a-905b-4775-a829-edfd3cc4d9f3','mjSessionId','pollForUpscaleResult','当前提示词已经在任务队列中了、请勿重复提交。。。','DeductionKey','/messages?limit=50','./../globalConfig/globalConfig.service','uploadFileFromUrl','HttpException','网络连接失败，请稍后再试！','includes','mjVersion','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','default','decorate','4kgJkiP','function','当前图片没有绘画信息、无法变体!','mjId','绘制图片任务异常中断\x20队列-1:\x20','sendDrawInteractions','当前用户\x20','substring','ChatLogEntity','now','放大当前图片失败','https://discord.com/api/v9/interactions','chatLogEntity','data','ChatLogService','http://172.247.48.137:8000/mj/draw','defineProperty','draw','726918SsjRtc','error','checkBadWords','balance','queueCount','__metadata','变换图片任务结束\x20队列-1:\x20','checkAuth','removeEmoji','axios\x20get:\x20','orderId','变换当前图片超时！','cosUrl:\x20','baiduFanyiSecret','查询期间出现错误：','../chatLog/chatLog.entity','findCurrentVariationImgResult','开始请求变换图片\x20队列+1:\x20','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','rateLimits','parse','2947300rWxbRL','FanyiService','__esModule','./../upload/upload.service','绘画超时，请稍后再试！','length','upscaleSingleImg','BAD_REQUEST','super','\x20次开始查询','checkRateLimit','绘制图片任务结束\x20队列-1:\x20','../../common/constants/balance.constant','使用的次数：','放大图片任务异常中断\x20队列-1:\x20'];_0x2717=function(){return _0x3fe159;};return _0x2717();}const _0x46d30f=_0x123c;(function(_0xdeb788,_0x18755e){const _0xa69ffc=_0x123c,_0x51bc32=_0xdeb788();while(!![]){try{const _0x2cb19f=parseInt(_0xa69ffc(0x106))/0x1+parseInt(_0xa69ffc(0x14f))/0x2+-parseInt(_0xa69ffc(0x17d))/0x3*(parseInt(_0xa69ffc(0x16b))/0x4)+-parseInt(_0xa69ffc(0x107))/0x5*(parseInt(_0xa69ffc(0x154))/0x6)+-parseInt(_0xa69ffc(0x140))/0x7+-parseInt(_0xa69ffc(0x113))/0x8*(-parseInt(_0xa69ffc(0x111))/0x9)+parseInt(_0xa69ffc(0x192))/0xa;if(_0x2cb19f===_0x18755e)break;else _0x51bc32['push'](_0x51bc32['shift']());}catch(_0x2c4306){_0x51bc32['push'](_0x51bc32['shift']());}}}(_0x2717,0x1fcff));var __decorate=this&&this[_0x46d30f(0x150)]||function(_0x522bbc,_0x520550,_0x49e6e9,_0x37367f){const _0x4e5ea8=_0x46d30f;var _0x127400=arguments[_0x4e5ea8(0x197)],_0x437e8c=_0x127400<0x3?_0x520550:_0x37367f===null?_0x37367f=Object[_0x4e5ea8(0x1b9)](_0x520550,_0x49e6e9):_0x37367f,_0x5c7c5b;if(typeof Reflect===_0x4e5ea8(0x144)&&typeof Reflect[_0x4e5ea8(0x16a)]===_0x4e5ea8(0x16c))_0x437e8c=Reflect['decorate'](_0x522bbc,_0x520550,_0x49e6e9,_0x37367f);else{for(var _0x1cf6b8=_0x522bbc[_0x4e5ea8(0x197)]-0x1;_0x1cf6b8>=0x0;_0x1cf6b8--)if(_0x5c7c5b=_0x522bbc[_0x1cf6b8])_0x437e8c=(_0x127400<0x3?_0x5c7c5b(_0x437e8c):_0x127400>0x3?_0x5c7c5b(_0x520550,_0x49e6e9,_0x437e8c):_0x5c7c5b(_0x520550,_0x49e6e9))||_0x437e8c;}return _0x127400>0x3&&_0x437e8c&&Object[_0x4e5ea8(0x17b)](_0x520550,_0x49e6e9,_0x437e8c),_0x437e8c;},__metadata=this&&this[_0x46d30f(0x182)]||function(_0x37392c,_0x2a9d77){const _0x23eb55=_0x46d30f;if(typeof Reflect==='object'&&typeof Reflect[_0x23eb55(0x1b1)]===_0x23eb55(0x16c))return Reflect[_0x23eb55(0x1b1)](_0x37392c,_0x2a9d77);},__param=this&&this[_0x46d30f(0x110)]||function(_0xb0bf31,_0x4a53b8){return function(_0x58734d,_0x5ec654){_0x4a53b8(_0x58734d,_0x5ec654,_0xb0bf31);};};Object[_0x46d30f(0x17b)](exports,_0x46d30f(0x194),{'value':!![]}),exports[_0x46d30f(0x122)]=void 0x0;const globalConfig_service_1=require(_0x46d30f(0x162)),upload_service_1=require(_0x46d30f(0x195)),common_1=require(_0x46d30f(0x102)),axios_1=require(_0x46d30f(0x108)),chatLog_service_1=require(_0x46d30f(0x1bc)),balance_constant_1=require(_0x46d30f(0x19e)),utils_1=require(_0x46d30f(0x12d)),chatLog_entity_1=require(_0x46d30f(0x18c)),typeorm_1=require('typeorm'),typeorm_2=require('@nestjs/typeorm'),balance_entity_1=require(_0x46d30f(0x13e)),fanyi_service_1=require('../fanyi/fanyi.service'),badwords_service_1=require(_0x46d30f(0x116));let MjService=class MjService{constructor(_0x4521f7,_0x571fbc,_0x54b4f9,_0x76a27e,_0x1c8bb0,_0x7f3006,_0x8916ee){const _0x5548e6=_0x46d30f;this[_0x5548e6(0x177)]=_0x4521f7,this[_0x5548e6(0x1a5)]=_0x571fbc,this[_0x5548e6(0x127)]=_0x54b4f9,this[_0x5548e6(0x12c)]=_0x76a27e,this['globalConfigService']=_0x1c8bb0,this['fanyiService']=_0x7f3006,this[_0x5548e6(0x130)]=_0x8916ee,this[_0x5548e6(0x190)]={},this['drawWorking']=[],this[_0x5548e6(0x1a6)]=[],this['queueCount']=0x0,this[_0x5548e6(0x13a)]={};}async[_0x46d30f(0x121)](_0x23341c){const _0x135552=_0x46d30f,{jobId:_0x44bc29,prompt:_0x59994a,startTime:_0x199250,userId:_0x42165f}=_0x23341c;return console[_0x135552(0x120)]('绘画任务开始',_0x135552(0x12f)),await new Promise(_0x34926b=>setTimeout(_0x34926b,0x1388)),{'a':0x1,'b':0x2};}async[_0x46d30f(0x17c)](_0x4a4863,_0x5b9c46){const _0x4189b3=_0x46d30f;await this[_0x4189b3(0x184)](_0x5b9c46);if(await this[_0x4189b3(0x130)][_0x4189b3(0x17f)](_0x4a4863[_0x4189b3(0x104)]))throw new common_1[(_0x4189b3(0x164))](_0x4189b3(0x112),common_1['HttpStatus'][_0x4189b3(0x199)]);const _0x58ee9d=_0x4a4863['prompt'];let _0x337c2c=_0x4a4863[_0x4189b3(0x104)];const {baiduFanyiAppId:_0x27971d,baiduFanyiSecret:_0x4ae4d5}=await this[_0x4189b3(0x1a3)][_0x4189b3(0x11d)]([_0x4189b3(0x134),_0x4189b3(0x18a)]);_0x27971d&&_0x4ae4d5&&(_0x337c2c=await this[_0x4189b3(0x13d)]['convertToEnglish'](_0x58ee9d));const _0x44dba8='['+(0x0,utils_1[_0x4189b3(0x10c)])()+']',_0x3a0c38=_0x44dba8+'\x20'+_0x337c2c;console['log'](_0x4189b3(0x1b7),_0x44dba8),console[_0x4189b3(0x120)](_0x4189b3(0x152),_0x3a0c38);const _0x558973=this[_0x4189b3(0x13f)][_0x4189b3(0x1a9)](_0x28692e=>_0x28692e[_0x4189b3(0x166)](_0x4a4863[_0x4189b3(0x104)]));if(_0x558973)throw new common_1[(_0x4189b3(0x164))](_0x4189b3(0x15f),common_1['HttpStatus']['BAD_REQUEST']);if(this[_0x4189b3(0x181)]>=0x3)throw new common_1[(_0x4189b3(0x164))](_0x4189b3(0x168),common_1['HttpStatus'][_0x4189b3(0x199)]);await this['checkRateLimit'](_0x5b9c46),this['queueCount']++,console[_0x4189b3(0x120)]('开始请求用户'+_0x5b9c46[_0x4189b3(0x1ac)]['id']+_0x4189b3(0x1c0),this[_0x4189b3(0x181)]);try{const _0x1f6d4e=await this['chatLogEntity'][_0x4189b3(0x1a9)]({'where':{'prompt':(0x0,typeorm_1[_0x4189b3(0x142)])('%'+_0x3a0c38+'%')}}),_0x5293a9=_0x1f6d4e[_0x4189b3(0x126)](_0x2ce8df=>_0x2ce8df[_0x4189b3(0x1ad)]);this[_0x4189b3(0x13f)][_0x4189b3(0x1bd)](_0x3a0c38);let _0x85b837;const _0x901c94=await this[_0x4189b3(0x170)](_0x3a0c38,_0x5293a9,_0x44dba8);_0x901c94?(console[_0x4189b3(0x120)](_0x4189b3(0x131)),_0x85b837=_0x901c94):_0x85b837=await this[_0x4189b3(0x10f)](_0x3a0c38,_0x5293a9,_0x44dba8);this[_0x4189b3(0x181)]--,this[_0x4189b3(0x181)]<0x0&&(this['queueCount']=0x0),console[_0x4189b3(0x120)](_0x4189b3(0x19d),this[_0x4189b3(0x181)]);const {id:_0x5e0a73,content:_0x13c19b,channel_id:_0x5f2539,attachments:attachments=[],timestamp:_0x1d23dc}=_0x85b837;if(!attachments[_0x4189b3(0x197)]||!attachments[0x0][_0x4189b3(0x1a2)])throw new common_1[(_0x4189b3(0x164))](_0x4189b3(0x114),common_1[_0x4189b3(0x15a)]['BAD_REQUEST']);const {filename:_0x5dafa4,url:_0x4638ec,width:_0x583ffc,height:_0x2233c6,size:_0x4a0a63}=attachments[0x0];console['log'](_0x4189b3(0x1bb),_0x4638ec);const _0x4e491a=await this['uploadService'][_0x4189b3(0x163)]({'filename':_0x5dafa4,'url':_0x4638ec});console[_0x4189b3(0x120)]('存入图片完成:\x20',_0x4e491a);const _0x379c9f={'curIp':(0x0,utils_1[_0x4189b3(0x147)])(_0x5b9c46),'userId':_0x5b9c46[_0x4189b3(0x1ac)]['id'],'type':balance_constant_1['DeductionKey'][_0x4189b3(0x128)],'prompt':_0x3a0c38,'answer':_0x4e491a,'model':'mj','extend':this[_0x4189b3(0x185)](JSON['stringify'](_0x85b837)),'message_id':_0x5e0a73,'variationId':_0x5e0a73,'upscaleId':_0x5e0a73,'group':0x1,'fileInfo':JSON[_0x4189b3(0x158)]({'width':_0x583ffc,'height':_0x2233c6,'size':_0x4a0a63,'filename':_0x5dafa4,'cosUrl':_0x4e491a})};return await this[_0x4189b3(0x12c)]['saveChatLog'](_0x379c9f),await this['deductBalance'](_0x5b9c46),this[_0x4189b3(0x13f)]=this[_0x4189b3(0x13f)]['filter'](_0x44ac12=>_0x44ac12!==_0x4a4863['prompt']),_0x4e491a;}catch(_0x272790){this[_0x4189b3(0x181)]--,this[_0x4189b3(0x181)]<0x0&&(this[_0x4189b3(0x181)]=0x0),console[_0x4189b3(0x120)](_0x4189b3(0x16f),this[_0x4189b3(0x181)]),this['drawWorking']=this[_0x4189b3(0x13f)][_0x4189b3(0x125)](_0xf2938b=>_0xf2938b!==_0x4a4863[_0x4189b3(0x104)]);throw new common_1[(_0x4189b3(0x164))](_0x272790[_0x4189b3(0x13c)],common_1[_0x4189b3(0x15a)][_0x4189b3(0x199)]);}}async[_0x46d30f(0x198)](_0x1b4dc2,_0x50e1f9){const _0x12e68e=_0x46d30f;if(this[_0x12e68e(0x181)]>=0x3)throw new common_1[(_0x12e68e(0x164))](_0x12e68e(0x168),common_1[_0x12e68e(0x15a)][_0x12e68e(0x199)]);this[_0x12e68e(0x181)]++,console[_0x12e68e(0x120)]('用户'+_0x50e1f9[_0x12e68e(0x1ac)]['id']+'开始请求放大图片\x20队列+1:\x20',this[_0x12e68e(0x181)]);const {message_id:_0x414231,orderId:_0x448acd}=_0x1b4dc2;try{const _0x27a02f=await this[_0x12e68e(0x177)][_0x12e68e(0x129)]({'where':{'message_id':_0x414231}});if(!_0x27a02f)throw new common_1[(_0x12e68e(0x164))]('历史记录中不存在当前图片、请确认您放大的图片是否存在',common_1[_0x12e68e(0x15a)]['BAD_REQUEST']);const _0x1d184b=await this[_0x12e68e(0x177)][_0x12e68e(0x129)]({'where':{'upscaleId':_0x414231,'action':'enlarge','orderId':_0x448acd}});if(_0x1d184b)throw new common_1[(_0x12e68e(0x164))](_0x12e68e(0x11f),common_1['HttpStatus'][_0x12e68e(0x199)]);const {prompt:_0x427c1b,extend:_0x2fd1f3}=_0x27a02f,_0x2ef862=JSON[_0x12e68e(0x191)](_0x2fd1f3),{components:components=[]}=_0x2ef862;if(!components[_0x12e68e(0x197)])throw new common_1[(_0x12e68e(0x164))](_0x12e68e(0x11b),common_1['HttpStatus'][_0x12e68e(0x199)]);const _0x457ee6=components[0x0]['components'][_0x448acd-0x1],{custom_id:_0x37030e}=_0x457ee6;console[_0x12e68e(0x120)](_0x12e68e(0x148),_0x37030e);const _0x1000d5={'message_id':_0x414231,'custom_id':_0x37030e,'prompt':_0x427c1b,'orderId':_0x448acd};await this[_0x12e68e(0x1b4)](_0x1000d5),console[_0x12e68e(0x120)]('发送放大指令成功');const _0x14c94f=await this['chatLogEntity']['find']({'where':{'prompt':(0x0,typeorm_1[_0x12e68e(0x142)])('%'+_0x427c1b+'%')}}),_0x55c4d4=_0x14c94f['map'](_0x53ad50=>_0x53ad50['message_id']);console[_0x12e68e(0x120)]('历史这些id已经被获取过了\x20不能拿了:\x20',_0x55c4d4);const _0x4a410a=await this[_0x12e68e(0x15e)](_0x1000d5,_0x55c4d4);this['queueCount']--,this[_0x12e68e(0x181)]<0x0&&(this['queueCount']=0x0),console['log']('放大图片任务结束\x20队列-1:\x20',this['queueCount']);const {id:_0x4d5610,content:_0x53ed9e,channel_id:_0x3acf17,attachments:attachments=[],timestamp:_0x385be8}=_0x4a410a;if(!attachments[_0x12e68e(0x197)]||!attachments[0x0][_0x12e68e(0x1a2)])throw new common_1[(_0x12e68e(0x164))](_0x12e68e(0x175),common_1[_0x12e68e(0x15a)]['BAD_REQUEST']);const {filename:_0xb3ba6f,url:_0xe3e357,width:_0xea09ac,height:_0x32f6ad,size:_0x134468}=attachments[0x0],_0x5a3bd8=await this[_0x12e68e(0x127)][_0x12e68e(0x163)]({'filename':_0xb3ba6f,'url':_0xe3e357});console[_0x12e68e(0x120)](_0x12e68e(0x189),_0x5a3bd8);const _0x36c261={'curIp':(0x0,utils_1[_0x12e68e(0x147)])(_0x50e1f9),'userId':_0x50e1f9[_0x12e68e(0x1ac)]['id'],'type':balance_constant_1[_0x12e68e(0x160)][_0x12e68e(0x128)],'prompt':_0x427c1b,'answer':_0x5a3bd8,'model':'mj','extend':this['removeEmoji'](JSON['stringify'](_0x4a410a)),'message_id':_0x414231,'upscaleId':_0x4d5610,'variationId':_0x4d5610,'action':_0x12e68e(0x1be),'orderId':_0x1000d5['orderId'],'fileInfo':JSON[_0x12e68e(0x158)]({'width':_0xea09ac,'height':_0x32f6ad,'size':_0x134468,'filename':_0xb3ba6f,'cosUrl':_0x5a3bd8})};return await this['chatLogService'][_0x12e68e(0x145)](_0x36c261),_0x5a3bd8;}catch(_0x16e4d2){console['log']('error:\x20',_0x16e4d2),this[_0x12e68e(0x181)]--,this[_0x12e68e(0x181)]<0x0&&(this[_0x12e68e(0x181)]=0x0),console['log'](_0x12e68e(0x1a0),this[_0x12e68e(0x181)]);throw new common_1['HttpException'](_0x16e4d2[_0x12e68e(0x13c)],common_1[_0x12e68e(0x15a)][_0x12e68e(0x199)]);}}async[_0x46d30f(0x153)](_0x198ae7,_0x4d6b19){const _0x59e3bc=_0x46d30f;if(this[_0x59e3bc(0x181)]>=0x3)throw new common_1[(_0x59e3bc(0x164))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1['HttpStatus'][_0x59e3bc(0x199)]);await this[_0x59e3bc(0x184)](_0x4d6b19),await this[_0x59e3bc(0x19c)](_0x4d6b19),this[_0x59e3bc(0x181)]++,console[_0x59e3bc(0x120)]('用户'+_0x4d6b19[_0x59e3bc(0x1ac)]['id']+_0x59e3bc(0x18e),this[_0x59e3bc(0x181)]);const {message_id:_0x26dcb1,orderId:_0x4ae981}=_0x198ae7;try{const _0x1ee87c=await this[_0x59e3bc(0x177)]['findOne']({'where':{'message_id':_0x26dcb1}});if(!_0x1ee87c)throw new common_1[(_0x59e3bc(0x164))](_0x59e3bc(0x1a8),common_1['HttpStatus'][_0x59e3bc(0x199)]);const {prompt:_0x411bde,extend:_0x1ba63f}=_0x1ee87c,_0x1d3b7d=JSON[_0x59e3bc(0x191)](_0x1ba63f),{components:components=[]}=_0x1d3b7d;if(!components[_0x59e3bc(0x197)])throw new common_1['HttpException'](_0x59e3bc(0x16d),common_1[_0x59e3bc(0x15a)][_0x59e3bc(0x199)]);const _0x3e5285=components[0x1][_0x59e3bc(0x14a)][_0x4ae981-0x1],{custom_id:_0x2e7823}=_0x3e5285,_0x329fdb=await this[_0x59e3bc(0x177)][_0x59e3bc(0x1a9)]({'where':{'variationId':(0x0,typeorm_1['Not'])((0x0,typeorm_1[_0x59e3bc(0x15b)])()),'prompt':(0x0,typeorm_1[_0x59e3bc(0x142)])('%'+_0x411bde+'%')}}),_0x1076c9=_0x329fdb[_0x59e3bc(0x126)](_0x3f3ca7=>_0x3f3ca7['variationId']),_0x32bb20={'message_id':_0x26dcb1,'custom_id':_0x2e7823,'prompt':_0x411bde,'orderId':_0x4ae981};await this[_0x59e3bc(0x1b4)](_0x32bb20);const _0xc392c1=await this[_0x59e3bc(0x151)](_0x32bb20,_0x1076c9);this[_0x59e3bc(0x181)]--,this['queueCount']<0x0&&(this[_0x59e3bc(0x181)]=0x0),console['log'](_0x59e3bc(0x183),this[_0x59e3bc(0x181)]);const {id:_0x5677d4,content:_0x26ba45,channel_id:_0x4776af,attachments:attachments=[],timestamp:_0x572442}=_0xc392c1;if(!attachments[_0x59e3bc(0x197)]||!attachments[0x0][_0x59e3bc(0x1a2)])throw new common_1[(_0x59e3bc(0x164))](_0x59e3bc(0x1a4),common_1['HttpStatus']['BAD_REQUEST']);const {filename:_0x23c601,url:_0x41f0e5,width:_0x127845,height:_0x1f50d6,size:_0x1325a7}=attachments[0x0],_0x1efb35=await this[_0x59e3bc(0x127)][_0x59e3bc(0x163)]({'filename':_0x23c601,'url':_0x41f0e5}),_0x1e37ba={'curIp':(0x0,utils_1[_0x59e3bc(0x147)])(_0x4d6b19),'userId':_0x4d6b19[_0x59e3bc(0x1ac)]['id'],'type':balance_constant_1[_0x59e3bc(0x160)][_0x59e3bc(0x128)],'prompt':_0x411bde,'answer':_0x1efb35,'model':'mj','group':0x1,'extend':this[_0x59e3bc(0x185)](JSON[_0x59e3bc(0x158)](_0xc392c1)),'message_id':_0x5677d4,'upscaleId':_0x5677d4,'variationId':_0x5677d4,'action':_0x59e3bc(0x1be),'orderId':_0x32bb20[_0x59e3bc(0x187)],'fileInfo':JSON[_0x59e3bc(0x158)]({'width':_0x127845,'height':_0x1f50d6,'size':_0x1325a7,'filename':_0x23c601,'cosUrl':_0x1efb35})};return await this[_0x59e3bc(0x12c)][_0x59e3bc(0x145)](_0x1e37ba),_0x1efb35;}catch(_0x21c2ba){console[_0x59e3bc(0x120)]('error:\x20',_0x21c2ba),this[_0x59e3bc(0x181)]--,this['queueCount']<0x0&&(this[_0x59e3bc(0x181)]=0x0),console[_0x59e3bc(0x120)]('变化图片任务异常中断\x20队列-1:\x20',this[_0x59e3bc(0x181)]);throw new common_1[(_0x59e3bc(0x164))](_0x21c2ba[_0x59e3bc(0x13c)],common_1['HttpStatus'][_0x59e3bc(0x199)]);}}async[_0x46d30f(0x1b4)](_0x128223){const _0x2bc966=_0x46d30f,{message_id:_0x1551c1,custom_id:_0x4af626}=_0x128223,{application_id:_0x5aa0ca,guild_id:_0x14a75b,channel_id:_0x397509,session_id:_0x2d5fca,version:_0x5683f7,id:_0x562e77,authorization:_0x2e3007,mjProxy:_0x2728ef}=await this[_0x2bc966(0x14c)](),_0x19c0c0=_0x2728ef==0x1?_0x2bc966(0x17a):_0x2bc966(0x176),_0x55a0f4={'authorization':_0x2e3007},_0x280677={'type':0x3,'guild_id':_0x14a75b,'channel_id':_0x397509,'message_flags':0x0,'message_id':_0x1551c1,'application_id':_0x5aa0ca,'session_id':_0x2d5fca,'data':{'component_type':0x2,'custom_id':_0x4af626}};try{await axios_1['default'][_0x2bc966(0x103)](_0x19c0c0,_0x280677,{'headers':_0x55a0f4}),console[_0x2bc966(0x120)]('绘图指令完成');}catch(_0x2e55d7){console[_0x2bc966(0x120)](_0x2bc966(0x1a1),_0x2e55d7);throw new common_1[(_0x2bc966(0x164))](_0x2bc966(0x118),common_1[_0x2bc966(0x15a)]['BAD_REQUEST']);}}async[_0x46d30f(0x15e)](_0x5dd8cb,_0x2f429b){const _0x2d6950=_0x46d30f,{message_id:_0x5baf56,custom_id:_0x357488,prompt:_0x3063d1,orderId:_0x7f705a}=_0x5dd8cb;let _0x227ba1=null,_0x1d6d2b=0x0;while(!_0x227ba1&&_0x1d6d2b<0xa){try{const _0x315988=Date[_0x2d6950(0x174)](),_0x3762b7=await this[_0x2d6950(0x14e)]();console[_0x2d6950(0x120)]('第\x20'+(_0x1d6d2b+0x1)+'\x20次开始查询\x20=>\x20当前查询结果：'+_0x3762b7[_0x2d6950(0x197)]);_0x3762b7&&_0x3762b7[_0x2d6950(0x197)]&&(_0x227ba1=await this[_0x2d6950(0x143)](_0x3762b7,_0x5dd8cb,_0x2f429b));const _0x4477a6=Date[_0x2d6950(0x174)]()-_0x315988,_0x15e5d4=0xbb8;await this[_0x2d6950(0x117)](Math[_0x2d6950(0x139)](_0x15e5d4-_0x4477a6,0x0)),_0x1d6d2b++;}catch(_0x3778a7){console[_0x2d6950(0x17e)](_0x2d6950(0x18b)+_0x3778a7['message']);}}return _0x227ba1;}async['pollForVariationResult'](_0x395108,_0x103487){const _0x486c27=_0x46d30f,{message_id:_0x52ed53,custom_id:_0x4b9b11,prompt:_0x2b12a9,orderId:_0x12819b}=_0x395108;console[_0x486c27(0x120)]('开始轮询单张变换图片结果');let _0x3c1ed7=null,_0x1d37a7=0x0;while(!_0x3c1ed7&&_0x1d37a7<0xa){try{console[_0x486c27(0x120)]('第\x20'+(_0x1d37a7+0x1)+_0x486c27(0x109));const _0x56b61f=Date[_0x486c27(0x174)](),_0x7bbb9b=await this[_0x486c27(0x14e)]();_0x7bbb9b&&_0x7bbb9b[_0x486c27(0x197)]&&(_0x3c1ed7=await this[_0x486c27(0x18d)](_0x7bbb9b,_0x395108,_0x103487));const _0x4b3799=Date['now']()-_0x56b61f,_0x5443a5=0x1f40;await this[_0x486c27(0x117)](Math[_0x486c27(0x139)](_0x5443a5-_0x4b3799,0x0)),_0x1d37a7++;}catch(_0x2adb50){console[_0x486c27(0x17e)](_0x486c27(0x18b)+_0x2adb50[_0x486c27(0x1b2)]);}}if(!_0x3c1ed7)throw new common_1[(_0x486c27(0x164))](_0x486c27(0x188),common_1[_0x486c27(0x15a)][_0x486c27(0x199)]);return _0x3c1ed7;}async[_0x46d30f(0x143)](_0x17c0e9,_0x3faf5d,_0x2806ec){const _0x2fcaed=_0x46d30f,{message_id:_0x36aa36,custom_id:_0x27def4,prompt:_0x325987,orderId:_0x2fa7a3}=_0x3faf5d,_0xedb726=_0x325987[_0x2fcaed(0x172)](0x0,0xc);console['log']('本次放大图片的id:\x20',_0xedb726);const _0x3cf3a9=_0x17c0e9[_0x2fcaed(0x1a9)](_0x37c54c=>{const _0x487c94=_0x2fcaed,{content:_0x38537c}=_0x37c54c;if(!this[_0x487c94(0x1ae)](_0x38537c))return![];const {prompt:_0x5dfa12,order:_0x122365}=this[_0x487c94(0x1ae)](_0x38537c);return _0x5dfa12[_0x487c94(0x166)](_0xedb726)&&_0x3faf5d[_0x487c94(0x187)]===_0x122365&&!_0x2806ec[_0x487c94(0x166)](_0x37c54c['id']);});return _0x3cf3a9;}async['findCurrentVariationImgResult'](_0x4f0e74,_0x413111,_0x1a8a1b){const _0x55068d=_0x46d30f,{message_id:_0xdc82bc,custom_id:_0xfb7678,prompt:_0x225a23,orderId:_0x3008e9}=_0x413111,_0x5d55b7=_0x225a23[_0x55068d(0x172)](0x0,0xc),_0x123258=_0x4f0e74[_0x55068d(0x1a9)](_0x118998=>{const _0x2ef471=_0x55068d,{content:_0x76c469}=_0x118998,_0x34aae7=_0x76c469['match'](/\*\*(.+?)\*\*/),_0x3e1969=_0x34aae7?_0x34aae7[0x1]:'';if(!_0x3e1969)return![];return _0x3e1969[_0x2ef471(0x166)](_0x5d55b7)&&!_0x1a8a1b['includes'](_0x118998['id']);});return _0x123258;}async[_0x46d30f(0x170)](_0x178915,_0x21fa9a,_0x131c43){const _0x36cd7a=_0x46d30f,_0x4b37f8=await this['queryMessageList'](),_0x317bb3=await this[_0x36cd7a(0x13b)](_0x4b37f8,_0x131c43,_0x21fa9a);if(_0x317bb3)return console['log']('有历史信息之间返回:\x20',_0x317bb3),_0x317bb3;const {application_id:_0x3a5f16,guild_id:_0x1c13e6,channel_id:_0x2a9a79,session_id:_0x491421,version:_0x3c2c0d,id:_0x33cf0f,authorization:_0x30eba2,mjProxy:_0x56b047}=await this[_0x36cd7a(0x14c)](),_0x11a120={'type':0x2,'application_id':_0x3a5f16,'guild_id':_0x1c13e6,'channel_id':_0x2a9a79,'session_id':_0x491421,'data':{'version':_0x3c2c0d,'id':_0x33cf0f,'name':_0x36cd7a(0x159),'type':0x1,'options':[{'type':0x3,'name':_0x36cd7a(0x104),'value':_0x178915}],'attachments':[]}};try{const _0x2d266e=_0x56b047==0x1?'http://172.247.48.137:8000/mj/draw':_0x36cd7a(0x176),_0x395048={'authorization':_0x30eba2},_0x25b882=await axios_1[_0x36cd7a(0x169)]['post'](_0x2d266e,_0x11a120,{'headers':_0x395048});return console[_0x36cd7a(0x120)](_0x36cd7a(0x155),_0x25b882[_0x36cd7a(0x178)]),![];}catch(_0x364f25){console[_0x36cd7a(0x120)](_0x36cd7a(0x136),_0x364f25);throw new common_1[(_0x36cd7a(0x164))](_0x36cd7a(0x18f),common_1[_0x36cd7a(0x15a)][_0x36cd7a(0x199)]);}}async[_0x46d30f(0x10f)](_0xa8b805,_0x3cb8db,_0x2fb8a8){const _0x5098d6=_0x46d30f;console['log']('开始查询绘画结果轮询');const _0x24dd0d=Date[_0x5098d6(0x174)]();try{const _0x3fd10c=0xd,_0x1735b4=0x2ee0,_0x22c040=0x1388,_0x135a2f=0x3c*0x3e8;let _0xacba49=0x0,_0x467a87=![],_0xa73903=null;while(!_0xa73903&&_0xacba49<_0x3fd10c){console[_0x5098d6(0x120)]('第\x20'+(_0xacba49+0x1)+_0x5098d6(0x19b));Date[_0x5098d6(0x174)]()-_0x24dd0d>=_0x135a2f&&(_0x467a87=!![]);await this[_0x5098d6(0x117)](_0x467a87?_0x22c040:_0x1735b4);const _0x1a9998=await this[_0x5098d6(0x14e)]();_0xa73903=await this[_0x5098d6(0x13b)](_0x1a9998,_0x2fb8a8,_0x3cb8db),_0xacba49++;}if(!_0xa73903)throw new common_1[(_0x5098d6(0x164))](_0x5098d6(0x196),common_1[_0x5098d6(0x15a)][_0x5098d6(0x199)]);const _0x3441ee=Date[_0x5098d6(0x174)]();return console[_0x5098d6(0x120)]('本次绘图耗时:\x20'+Math[_0x5098d6(0x1b5)]((_0x3441ee-_0x24dd0d)/0x3e8)+'\x20S'),_0xa73903;}catch(_0x560d9a){console['error'](_0x560d9a[_0x5098d6(0x1b2)]);throw new common_1[(_0x5098d6(0x164))](_0x5098d6(0x165),common_1[_0x5098d6(0x15a)][_0x5098d6(0x10b)]);}}async[_0x46d30f(0x13b)](_0x2b3860,_0x4e8947,_0x16fce2){const _0x369ae1=_0x46d30f;if(!_0x2b3860||!_0x2b3860[_0x369ae1(0x197)])return;console[_0x369ae1(0x120)]('本次比对的随机ID:\x20',_0x4e8947);const _0x411b44=_0x2b3860[_0x369ae1(0x1a9)](_0x1fe9bf=>{const _0x5f37cd=_0x369ae1,{attachments:attachments=[],content:_0x2ebd57,edited_timestamp:_0x554315}=_0x1fe9bf;return _0x2ebd57['includes'](_0x4e8947)&&attachments[_0x5f37cd(0x197)]>0x0&&!_0x554315&&!_0x16fce2[_0x5f37cd(0x166)](_0x1fe9bf['id']);});return _0x411b44||null;}async[_0x46d30f(0x14e)](){const _0x5b755c=_0x46d30f;try{const {application_id:_0x359a06,guild_id:_0x185035,channel_id:_0x3aed96,session_id:_0x3f5685,version:_0x59ce01,id:_0x30fa63,authorization:_0x445bf0,mjProxy:_0x2c0c01}=await this['getMjDefaultParams'](),_0x529389=_0x2c0c01==0x1?'http://172.247.48.137:8000/mj/list?channel_id='+_0x3aed96:_0x5b755c(0x1b6)+_0x3aed96+_0x5b755c(0x161),_0x25e8ef={'authorization':_0x445bf0},_0x760bda=await axios_1[_0x5b755c(0x169)][_0x5b755c(0x135)](_0x529389,{'headers':_0x25e8ef});return _0x760bda[_0x5b755c(0x178)];}catch(_0x1340b3){console[_0x5b755c(0x120)](_0x5b755c(0x186),_0x1340b3);throw new common_1[(_0x5b755c(0x164))](_0x5b755c(0x124),common_1[_0x5b755c(0x15a)]['BAD_REQUEST']);}}async[_0x46d30f(0x117)](_0x4ab1b0){return new Promise(_0x4881f6=>setTimeout(_0x4881f6,_0x4ab1b0));}[_0x46d30f(0x1ae)](_0x2ea15d){const _0x2982e2=_0x46d30f,_0x24431c=_0x2ea15d[_0x2982e2(0x12b)](/\*\*(.+?)\*\*/),_0x5b740e=_0x2ea15d[_0x2982e2(0x12b)](/- Image #(\d+)/);if(!_0x24431c||!_0x5b740e)return null;const _0xb4e421=_0x24431c[0x1],_0x1a8b95=parseInt(_0x5b740e[0x1]);return{'prompt':_0xb4e421,'order':_0x1a8b95};}async[_0x46d30f(0x14c)](){const _0x4a116a=_0x46d30f,_0x43861d=await this[_0x4a116a(0x1a3)][_0x4a116a(0x11d)]([_0x4a116a(0x16e),_0x4a116a(0x115),'mjGuildId',_0x4a116a(0x11c),_0x4a116a(0x15d),_0x4a116a(0x167),_0x4a116a(0x14d),'mjRateLimit',_0x4a116a(0x11a)]),_0x57770d={'application_id':_0x43861d[_0x4a116a(0x115)],'guild_id':_0x43861d[_0x4a116a(0x11e)],'channel_id':_0x43861d['mjChannelId'],'session_id':_0x43861d[_0x4a116a(0x15d)],'version':_0x43861d[_0x4a116a(0x167)],'id':_0x43861d[_0x4a116a(0x16e)],'authorization':_0x43861d[_0x4a116a(0x14d)],'mjRateLimit':_0x43861d['mjRateLimit'],'mjProxy':_0x43861d[_0x4a116a(0x11a)]||0x0};return _0x57770d;}[_0x46d30f(0x185)](_0x332a3c){const _0x2d854e=_0x46d30f,_0x165ebd=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x332a3c[_0x2d854e(0x10a)](_0x165ebd,'');}async['checkAuth'](_0x56dd0c){const _0xc95359=_0x46d30f,_0x1a8474=await this[_0xc95359(0x1a5)][_0xc95359(0x129)]({'where':{'userId':_0x56dd0c['user']['id']}}),{id:_0x3c5367,balance:_0xd69f07}=_0x1a8474;if(!_0xd69f07||(_0x1a8474===null||_0x1a8474===void 0x0?void 0x0:_0x1a8474[_0xc95359(0x180)])<0x1)throw new common_1['HttpException'](_0xc95359(0x1b8),common_1[_0xc95359(0x15a)]['BAD_REQUEST']);}async['checkFree'](_0x8b9376){const _0x48a5f8=_0x46d30f,{id:_0x34be7d,role:_0x2ca063}=_0x8b9376[_0x48a5f8(0x1ac)];!this['freeQueueUsers'][_0x34be7d]?this['freeQueueUsers'][_0x34be7d]=0x1:this[_0x48a5f8(0x13a)][_0x34be7d]=this[_0x48a5f8(0x13a)][_0x34be7d]+0x1,console[_0x48a5f8(0x120)](_0x48a5f8(0x10e)+_0x34be7d+_0x48a5f8(0x19f),this[_0x48a5f8(0x13a)][_0x34be7d]);}async[_0x46d30f(0x19c)](_0x5e5be7){const _0x2e97fc=_0x46d30f,{id:_0x2a4dbb,role:_0x360621}=_0x5e5be7[_0x2e97fc(0x1ac)];if([_0x2e97fc(0x1aa),_0x2e97fc(0x19a)][_0x2e97fc(0x166)](_0x360621))return!![];const {mjRateLimit:_0x5be04}=await this[_0x2e97fc(0x14c)]();if(this[_0x2e97fc(0x190)][_0x2a4dbb]){const _0x52a077=this['rateLimits'][_0x2a4dbb];if(_0x52a077>Date['now']()){console[_0x2e97fc(0x120)](_0x2e97fc(0x171)+_0x2a4dbb+_0x2e97fc(0x1a7));throw new common_1[(_0x2e97fc(0x164))]('由于速率限制、当前普通用户限制为'+_0x5be04+_0x2e97fc(0x10d),common_1[_0x2e97fc(0x15a)][_0x2e97fc(0x199)]);}else this[_0x2e97fc(0x190)][_0x2a4dbb]=Date[_0x2e97fc(0x174)]()+Number(_0x5be04)*0x3e8;}else{const _0x2ff68b=Date[_0x2e97fc(0x174)]();this[_0x2e97fc(0x190)][_0x2a4dbb]=_0x2ff68b+0x3e8*Number(_0x5be04);}}async[_0x46d30f(0x1b3)](_0x3ab315){const _0x1b8692=_0x46d30f;await this['balanceEntity'][_0x1b8692(0x141)]()[_0x1b8692(0x133)](balance_entity_1[_0x1b8692(0x123)])[_0x1b8692(0x12e)]({'balance':()=>_0x1b8692(0x12a)})['where'](_0x1b8692(0x137),{'userId':_0x3ab315[_0x1b8692(0x1ac)]['id']})[_0x1b8692(0x1ab)]();}async[_0x46d30f(0x14b)](){const _0x183572=_0x46d30f;return 0x1;const _0x4deb1a=_0x183572(0x176),_0x47ae29={'authorization':'MTA4OTc0ODU3NjU1NDQ2MzI2Mg.G-hGcs.QEWmJLc7qWrrSXKxxIH9zBi5L4GmHHkGzr7i-4'},_0x4fc7d3={'type':0x3,'guild_id':_0x183572(0x132),'channel_id':_0x183572(0x149),'message_flags':0x0,'message_id':_0x183572(0x1b0),'application_id':_0x183572(0x138),'session_id':_0x183572(0x156),'data':{'component_type':0x2,'custom_id':_0x183572(0x15c)}};try{const _0x512a2b=await axios_1[_0x183572(0x169)]['post'](_0x4deb1a,_0x4fc7d3,{'headers':_0x47ae29});console[_0x183572(0x120)](_0x183572(0x146));}catch(_0x33b289){console[_0x183572(0x120)](_0x183572(0x1a1),_0x33b289);throw new common_1[(_0x183572(0x164))](_0x183572(0x118),common_1['HttpStatus'][_0x183572(0x199)]);}}};MjService=__decorate([(0x0,common_1[_0x46d30f(0x1af)])(),__param(0x0,(0x0,typeorm_2[_0x46d30f(0x157)])(chatLog_entity_1[_0x46d30f(0x173)])),__param(0x1,(0x0,typeorm_2[_0x46d30f(0x157)])(balance_entity_1[_0x46d30f(0x123)])),__metadata(_0x46d30f(0x105),[typeorm_1['Repository'],typeorm_1[_0x46d30f(0x119)],upload_service_1[_0x46d30f(0x1bf)],chatLog_service_1[_0x46d30f(0x179)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1[_0x46d30f(0x193)],badwords_service_1[_0x46d30f(0x1ba)]])],MjService),exports[_0x46d30f(0x122)]=MjService;