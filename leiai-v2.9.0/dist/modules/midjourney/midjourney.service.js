'use strict';const _0x7bf388=_0x48da;function _0x48da(_0x4536e1,_0x14fdd4){const _0x54b1f3=_0x54b1();return _0x48da=function(_0x48dac4,_0x2d8899){_0x48dac4=_0x48dac4-0x1e4;let _0x193426=_0x54b1f3[_0x48dac4];return _0x193426;},_0x48da(_0x4536e1,_0x14fdd4);}(function(_0x5aa25d,_0x3f8542){const _0x59412c=_0x48da,_0x141393=_0x5aa25d();while(!![]){try{const _0x25fc56=-parseInt(_0x59412c(0x239))/0x1+-parseInt(_0x59412c(0x25c))/0x2+-parseInt(_0x59412c(0x29a))/0x3+parseInt(_0x59412c(0x2bd))/0x4*(-parseInt(_0x59412c(0x247))/0x5)+-parseInt(_0x59412c(0x2af))/0x6*(-parseInt(_0x59412c(0x218))/0x7)+parseInt(_0x59412c(0x2c7))/0x8*(parseInt(_0x59412c(0x231))/0x9)+parseInt(_0x59412c(0x293))/0xa*(parseInt(_0x59412c(0x2c4))/0xb);if(_0x25fc56===_0x3f8542)break;else _0x141393['push'](_0x141393['shift']());}catch(_0x5ad5cd){_0x141393['push'](_0x141393['shift']());}}}(_0x54b1,0x952c0));var __decorate=this&&this[_0x7bf388(0x201)]||function(_0x24c586,_0x3eff14,_0x42728d,_0x3d7934){const _0x526cc9=_0x7bf388;var _0x18691a=arguments[_0x526cc9(0x289)],_0x5748c3=_0x18691a<0x3?_0x3eff14:_0x3d7934===null?_0x3d7934=Object[_0x526cc9(0x205)](_0x3eff14,_0x42728d):_0x3d7934,_0x4d2007;if(typeof Reflect===_0x526cc9(0x243)&&typeof Reflect[_0x526cc9(0x27e)]===_0x526cc9(0x2b0))_0x5748c3=Reflect['decorate'](_0x24c586,_0x3eff14,_0x42728d,_0x3d7934);else{for(var _0x4c5c87=_0x24c586[_0x526cc9(0x289)]-0x1;_0x4c5c87>=0x0;_0x4c5c87--)if(_0x4d2007=_0x24c586[_0x4c5c87])_0x5748c3=(_0x18691a<0x3?_0x4d2007(_0x5748c3):_0x18691a>0x3?_0x4d2007(_0x3eff14,_0x42728d,_0x5748c3):_0x4d2007(_0x3eff14,_0x42728d))||_0x5748c3;}return _0x18691a>0x3&&_0x5748c3&&Object['defineProperty'](_0x3eff14,_0x42728d,_0x5748c3),_0x5748c3;},__metadata=this&&this[_0x7bf388(0x1fa)]||function(_0x12ebf2,_0x1cdbb2){const _0x362751=_0x7bf388;if(typeof Reflect===_0x362751(0x243)&&typeof Reflect[_0x362751(0x244)]==='function')return Reflect[_0x362751(0x244)](_0x12ebf2,_0x1cdbb2);},__param=this&&this[_0x7bf388(0x1ee)]||function(_0x356751,_0x53b567){return function(_0x159bd8,_0x24f720){_0x53b567(_0x159bd8,_0x24f720,_0x356751);};};Object['defineProperty'](exports,_0x7bf388(0x275),{'value':!![]}),exports['MidjourneyService']=void 0x0;const user_entity_1=require(_0x7bf388(0x27b)),common_1=require(_0x7bf388(0x2b1)),typeorm_1=require(_0x7bf388(0x2b6)),midjourney_entity_1=require(_0x7bf388(0x20c)),typeorm_2=require(_0x7bf388(0x1e9)),axios_1=require(_0x7bf388(0x2a8)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),midjourney_constant_1=require(_0x7bf388(0x1e6)),upload_service_1=require(_0x7bf388(0x2cc)),badwords_service_1=require('../badwords/badwords.service'),userBalance_service_1=require(_0x7bf388(0x257)),utils_1=require(_0x7bf388(0x28a)),redisCache_service_1=require(_0x7bf388(0x2a1));let MidjourneyService=class MidjourneyService{constructor(_0x6cf596,_0x51331d,_0x5239ed,_0x42c50a,_0x3ac66e,_0x1c36c8,_0x128d00){const _0x1e7dea=_0x7bf388;this[_0x1e7dea(0x2cd)]=_0x6cf596,this['userEntity']=_0x51331d,this[_0x1e7dea(0x21b)]=_0x5239ed,this[_0x1e7dea(0x211)]=_0x42c50a,this[_0x1e7dea(0x2aa)]=_0x3ac66e,this[_0x1e7dea(0x254)]=_0x1c36c8,this['redisCacheService']=_0x128d00,this[_0x1e7dea(0x24a)]=[];}async[_0x7bf388(0x2c6)](_0x15e2a9){return new Promise(_0x202840=>setTimeout(_0x202840,_0x15e2a9));}async[_0x7bf388(0x1f4)](_0x359a54,_0x312f23){const _0x32d670=_0x7bf388,{id:_0x6aee47,action:_0x1458ad}=_0x359a54,_0x41ca8f=await this['midjourneyEntity'][_0x32d670(0x26e)]({'where':{'id':_0x6aee47}});try{await this[_0x32d670(0x203)](_0x6aee47,_0x312f23),await this[_0x32d670(0x29b)](_0x6aee47,midjourney_constant_1['MidjourneyStatusEnum'][_0x32d670(0x28f)]);if(_0x1458ad===midjourney_constant_1[_0x32d670(0x266)][_0x32d670(0x287)]||_0x1458ad===midjourney_constant_1[_0x32d670(0x266)]['GENERATE']){await this[_0x32d670(0x2ab)](_0x41ca8f,_0x359a54);const _0x4df76=await this[_0x32d670(0x2b9)](_0x41ca8f);await this['updateDrawData'](_0x359a54,_0x4df76);}if(_0x1458ad===midjourney_constant_1[_0x32d670(0x266)][_0x32d670(0x1f7)]){const {message_id:_0x4ada90,custom_id:_0x430a60}=_0x41ca8f;await this[_0x32d670(0x269)]({'message_id':_0x4ada90,'custom_id':_0x430a60},_0x359a54),common_1[_0x32d670(0x23a)]['debug']('记录'+_0x6aee47+_0x32d670(0x236),_0x32d670(0x24f));const _0x56eb3a=await this['pollComparisonResultUpscale'](_0x41ca8f);await this[_0x32d670(0x272)](_0x359a54,_0x56eb3a);}if(_0x1458ad===midjourney_constant_1['MidjourneyActionEnum'][_0x32d670(0x2d1)]){const {message_id:_0x3f1fb3,custom_id:_0x1d0b3f}=_0x41ca8f;await this[_0x32d670(0x269)]({'message_id':_0x3f1fb3,'custom_id':_0x1d0b3f},_0x359a54),common_1['Logger'][_0x32d670(0x2ae)]('记录'+_0x6aee47+_0x32d670(0x225),_0x32d670(0x24f));const _0x214dec=await this[_0x32d670(0x235)](_0x41ca8f);await this[_0x32d670(0x272)](_0x359a54,_0x214dec),this[_0x32d670(0x24a)]=this[_0x32d670(0x24a)][_0x32d670(0x297)](_0x555ed5=>_0x555ed5!==_0x41ca8f[_0x32d670(0x20f)]);}if(_0x1458ad===midjourney_constant_1[_0x32d670(0x266)][_0x32d670(0x24d)]){const {message_id:_0x4450a2,custom_id:_0x585abe}=_0x41ca8f;await this['sendReGenerateInteractions']({'message_id':_0x4450a2,'custom_id':_0x585abe},_0x359a54),common_1['Logger'][_0x32d670(0x2ae)]('记录'+_0x6aee47+_0x32d670(0x2a2),'MidjourneyService');const _0x577f4d=await this[_0x32d670(0x20d)](_0x41ca8f);await this['updateDrawData'](_0x359a54,_0x577f4d),this['lockPrompt']=this[_0x32d670(0x24a)][_0x32d670(0x297)](_0x4592c9=>_0x4592c9!==_0x41ca8f[_0x32d670(0x20f)]);}if(_0x1458ad===midjourney_constant_1[_0x32d670(0x266)]['VARY']){const {message_id:_0x46126f,custom_id:_0x156fec}=_0x41ca8f;await this[_0x32d670(0x2a3)]({'message_id':_0x46126f,'custom_id':_0x156fec},_0x359a54),common_1[_0x32d670(0x23a)]['debug']('记录'+_0x6aee47+'已经成功发送单张图片增强指令','MidjourneyService');const _0x2fdb20=await this[_0x32d670(0x256)](_0x41ca8f);await this[_0x32d670(0x272)](_0x359a54,_0x2fdb20),this['lockPrompt']=this['lockPrompt']['filter'](_0x3b9b1f=>_0x3b9b1f!==_0x41ca8f[_0x32d670(0x20f)]);}if(_0x1458ad===midjourney_constant_1[_0x32d670(0x266)]['ZOOM']){const {message_id:_0x414731,custom_id:_0x3f62c1}=_0x41ca8f;await this['sendZoomInteractions']({'message_id':_0x414731,'custom_id':_0x3f62c1},_0x359a54),common_1[_0x32d670(0x23a)]['debug']('记录'+_0x6aee47+_0x32d670(0x25f),_0x32d670(0x24f));const _0x203df1=await this[_0x32d670(0x1e7)](_0x41ca8f);await this['updateDrawData'](_0x359a54,_0x203df1),this[_0x32d670(0x24a)]=this[_0x32d670(0x24a)]['filter'](_0x307ec4=>_0x307ec4!==_0x41ca8f[_0x32d670(0x20f)]);}return!![];}catch(_0x3cb6b8){return this[_0x32d670(0x24a)]=this[_0x32d670(0x24a)][_0x32d670(0x297)](_0x102a5a=>_0x102a5a!==_0x41ca8f[_0x32d670(0x20f)]),await this['drawFailed'](_0x359a54),console[_0x32d670(0x274)]('error:\x20',_0x3cb6b8),!![];}}async[_0x7bf388(0x296)](_0x39df39){const _0xae45d2=_0x7bf388,{prompt:_0x4902dd,imgUrl:imgUrl='',extraParam:extraParam='',action:action=0x1,userId:_0x446378,randomDrawId:_0x12ecb0,orderId:_0x5e400e,custom_id:_0x5bc788,message_id:_0x446cd6}=_0x39df39,_0x3d2b13=imgUrl?imgUrl+'\x20'+_0x4902dd+'\x20'+extraParam:_0x4902dd+'\x20'+extraParam;if(await this['badwordsService'][_0xae45d2(0x2c1)](_0x3d2b13))throw new common_1[(_0xae45d2(0x253))](_0xae45d2(0x27f),common_1[_0xae45d2(0x26b)][_0xae45d2(0x223)]);const _0x449b63={'userId':_0x446378,'extraParam':extraParam,'prompt':_0x4902dd,'imgUrl':imgUrl,'fullPrompt':_0x3d2b13,'randomDrawId':_0x12ecb0,'status':midjourney_constant_1[_0xae45d2(0x2b7)]['WAITING'],'action':action,'orderId':_0x5e400e,'custom_id':_0x5bc788,'message_id':_0x446cd6},_0x354dfb=await this[_0xae45d2(0x2cd)]['save'](_0x449b63);return _0x354dfb;}async[_0x7bf388(0x29b)](_0x4541b9,_0x524f55){const _0x36839c=_0x7bf388;await this[_0x36839c(0x2cd)][_0x36839c(0x252)]({'id':_0x4541b9},{'status':_0x524f55});}async['updateDrawData'](_0x1a1533,_0x18586f){const _0x5076e8=_0x7bf388;try{const {id:_0x3d2c94,content:_0x3a9b98,channel_id:_0x84c8e4,attachments:attachments=[],timestamp:_0x3c3bbd,durationSpent:_0x471307}=_0x18586f,{filename:_0x373e96,url:_0x269781,proxy_url:_0x19dfae,width:_0x3fd2ee,height:_0x36441a,size:_0x329b88}=attachments[0x0];common_1[_0x5076e8(0x23a)]['debug'](_0x5076e8(0x2ba),'MidjourneyService');const _0x55b992=new Date(),_0x585edb=await this[_0x5076e8(0x211)][_0x5076e8(0x278)]({'filename':_0x373e96,'url':_0x269781}),_0x47f57e=new Date();common_1['Logger']['debug']('本次图片上传耗时为'+(_0x47f57e['getTime']()-_0x55b992[_0x5076e8(0x255)]())/0x3e8+'秒','MidjourneyService');const _0x4cfa09=await this[_0x5076e8(0x211)][_0x5076e8(0x280)](),_0x46b62b={'status':midjourney_constant_1[_0x5076e8(0x2b7)][_0x5076e8(0x207)],'message_id':_0x3d2c94,'progress':0x64,'fileInfo':JSON[_0x5076e8(0x1ff)]({'width':_0x3fd2ee,'height':_0x36441a,'size':_0x329b88,'filename':_0x373e96,'cosUrl':_0x585edb,'cosType':_0x4cfa09}),'extend':this[_0x5076e8(0x241)](JSON[_0x5076e8(0x1ff)](_0x18586f)),'durationSpent':_0x471307};await this[_0x5076e8(0x2cd)][_0x5076e8(0x252)]({'id':_0x1a1533['id']},_0x46b62b);}catch(_0x307e8f){console[_0x5076e8(0x274)](_0x5076e8(0x21c),_0x1a1533);}}async['getHistroyMessageIds'](_0x31d79c){const _0xc21351=_0x7bf388,_0x2d94f5=await this[_0xc21351(0x2cd)][_0xc21351(0x1fb)]({'where':{'randomDrawId':_0x31d79c,'status':midjourney_constant_1[_0xc21351(0x2b7)][_0xc21351(0x207)]}});return _0x2d94f5[_0xc21351(0x220)](_0x1b1c40=>_0x1b1c40[_0xc21351(0x21d)]);}async[_0x7bf388(0x2ab)](_0x407de0,_0x5a9e47){const _0x41ea4c=_0x7bf388,{fullPrompt:_0x51c54e,randomDrawId:_0x39d9aa,imgUrl:_0x3f59ff}=_0x407de0,_0x19d76e=_0x3f59ff?'['+_0x39d9aa+']\x20'+_0x3f59ff+'\x20'+_0x51c54e:'['+_0x39d9aa+']\x20'+_0x51c54e;common_1['Logger'][_0x41ea4c(0x2ae)](_0x41ea4c(0x202)+_0x19d76e,_0x41ea4c(0x24f));const {application_id:_0x2f61fe,guild_id:_0x25858e,channel_id:_0xa42739,session_id:_0x590ae3,version:_0x22075c,id:_0x5f1d6b,authorization:_0x4e8087,mjProxy:_0x15c724}=await this[_0x41ea4c(0x2c2)](),_0x2a15af={'type':0x2,'application_id':_0x2f61fe,'guild_id':_0x25858e,'channel_id':_0xa42739,'session_id':_0x590ae3,'data':{'version':_0x22075c,'id':_0x5f1d6b,'name':_0x41ea4c(0x2ce),'type':0x1,'options':[{'type':0x3,'name':_0x41ea4c(0x210),'value':_0x19d76e}],'attachments':[]}};try{const _0x1a1e3a=await this[_0x41ea4c(0x21b)][_0x41ea4c(0x237)](['mjProxyUrl'])||_0x41ea4c(0x20a),_0x188c36=_0x15c724==0x1?_0x1a1e3a+_0x41ea4c(0x21e):_0x41ea4c(0x258),_0x1eaaf2={'authorization':_0x4e8087},_0xc82e9d=await axios_1[_0x41ea4c(0x1f3)][_0x41ea4c(0x2c0)](_0x188c36,_0x2a15af,{'headers':_0x1eaaf2});return![];}catch(_0x5b3244){common_1['Logger'][_0x41ea4c(0x21f)](_0x41ea4c(0x228),'MidjourneyService');throw new common_1[(_0x41ea4c(0x253))](_0x41ea4c(0x219),common_1[_0x41ea4c(0x26b)]['BAD_REQUEST']);}}async['sendSmInteractions'](_0x5ecb0a,_0x4dff7b){const _0x5def42=_0x7bf388,{message_id:_0x5a4d32,custom_id:_0x3aa112}=_0x5ecb0a,{application_id:_0x3f3690,guild_id:_0x15ef51,channel_id:_0x594057,session_id:_0x235b08,version:_0x2945fb,id:_0x6992c2,authorization:_0x342243,mjProxy:_0x179cf1}=await this[_0x5def42(0x2c2)](),_0x4a4eff=await this[_0x5def42(0x21b)][_0x5def42(0x237)](['mjProxyUrl'])||'http://172.247.48.137:8000',_0x486683=_0x179cf1==0x1?_0x4a4eff+_0x5def42(0x21e):_0x5def42(0x258),_0x58a10e={'authorization':_0x342243},_0x21712d={'type':0x3,'guild_id':_0x15ef51,'channel_id':_0x594057,'message_flags':0x0,'message_id':_0x5a4d32,'application_id':_0x3f3690,'session_id':_0x235b08,'data':{'component_type':0x2,'custom_id':_0x3aa112}};try{await axios_1[_0x5def42(0x1f3)][_0x5def42(0x2c0)](_0x486683,_0x21712d,{'headers':_0x58a10e});}catch(_0x385ecd){console['log'](_0x5def42(0x1ec),_0x385ecd),common_1['Logger']['error']('发送放大变幻指令失败',_0x5def42(0x24f));throw new common_1[(_0x5def42(0x253))](_0x5def42(0x2bb),common_1['HttpStatus'][_0x5def42(0x223)]);}}async[_0x7bf388(0x26f)](_0x283dbf,_0x3db665){const _0x5bcd42=_0x7bf388,{message_id:_0x68e4a1,custom_id:_0x380e9f}=_0x283dbf,{application_id:_0x397d6f,guild_id:_0x30eadb,channel_id:_0xa66d87,session_id:_0xf52c95,version:_0x486875,id:_0x15abe2,authorization:_0x101880,mjProxy:_0x36b901}=await this[_0x5bcd42(0x2c2)](),_0x4415db=await this[_0x5bcd42(0x21b)][_0x5bcd42(0x237)]([_0x5bcd42(0x23f)])||_0x5bcd42(0x20a),_0x5afdf0=_0x36b901==0x1?_0x4415db+_0x5bcd42(0x21e):_0x5bcd42(0x258),_0x4a22dc={'authorization':_0x101880},_0x53f35c={'type':0x3,'guild_id':_0x30eadb,'channel_id':_0xa66d87,'message_id':_0x68e4a1,'application_id':_0x397d6f,'session_id':_0xf52c95,'data':{'component_type':0x2,'custom_id':_0x380e9f}};try{await axios_1[_0x5bcd42(0x1f3)][_0x5bcd42(0x2c0)](_0x5afdf0,_0x53f35c,{'headers':_0x4a22dc});}catch(_0x534d5d){console[_0x5bcd42(0x274)](_0x5bcd42(0x264),_0x534d5d),common_1[_0x5bcd42(0x23a)][_0x5bcd42(0x21f)](_0x5bcd42(0x262),_0x5bcd42(0x24f));throw new common_1['HttpException'](_0x5bcd42(0x2bb),common_1['HttpStatus'][_0x5bcd42(0x223)]);}}async['sendVaryInteractions'](_0xe9005d,_0x280065){const _0x48931f=_0x7bf388,{message_id:_0x165851,custom_id:_0x26856e}=_0xe9005d,{application_id:_0x3589eb,guild_id:_0x20269f,channel_id:_0x54c0b3,session_id:_0x271a1a,version:_0x447165,id:_0x4afc07,authorization:_0x5e4c8a,mjProxy:_0x2dd3c3}=await this[_0x48931f(0x2c2)](),_0x4c7351=await this[_0x48931f(0x21b)]['getConfigs']([_0x48931f(0x23f)])||_0x48931f(0x20a),_0x33c1e7=_0x2dd3c3==0x1?_0x4c7351+'/mj/draw':_0x48931f(0x258),_0x357dc5={'authorization':_0x5e4c8a},_0x28c7b8={'type':0x3,'guild_id':_0x20269f,'channel_id':_0x54c0b3,'message_id':_0x165851,'application_id':_0x3589eb,'session_id':_0x271a1a,'data':{'component_type':0x2,'custom_id':_0x26856e}};try{await axios_1[_0x48931f(0x1f3)]['post'](_0x33c1e7,_0x28c7b8,{'headers':_0x357dc5});}catch(_0x293340){console['log']('发送对单张图片增强指令失败:\x20',_0x293340),common_1[_0x48931f(0x23a)][_0x48931f(0x21f)](_0x48931f(0x282),'MidjourneyService');throw new common_1[(_0x48931f(0x253))](_0x48931f(0x295),common_1[_0x48931f(0x26b)][_0x48931f(0x223)]);}}async[_0x7bf388(0x245)](_0x3cfa3b,_0x396a9e){const _0x173b3f=_0x7bf388,{message_id:_0x1fcdb7,custom_id:_0x542c23}=_0x3cfa3b,{application_id:_0xc30ed1,guild_id:_0x24130f,channel_id:_0x503308,session_id:_0x45ed41,version:_0x58a973,id:_0x1f3ac7,authorization:_0x2e20ab,mjProxy:_0x4d2fba}=await this['getMjDefaultParams'](),_0x48b690=await this[_0x173b3f(0x21b)]['getConfigs']([_0x173b3f(0x23f)])||_0x173b3f(0x20a),_0x367ed1=_0x4d2fba==0x1?_0x48b690+_0x173b3f(0x21e):_0x173b3f(0x258),_0x46d69a={'authorization':_0x2e20ab},_0x567e2d={'type':0x3,'guild_id':_0x24130f,'channel_id':_0x503308,'message_id':_0x1fcdb7,'application_id':_0xc30ed1,'session_id':_0x45ed41,'data':{'component_type':0x2,'custom_id':_0x542c23}};try{await axios_1[_0x173b3f(0x1f3)][_0x173b3f(0x2c0)](_0x367ed1,_0x567e2d,{'headers':_0x46d69a});}catch(_0x136424){console[_0x173b3f(0x274)](_0x173b3f(0x27d),_0x136424),common_1[_0x173b3f(0x23a)][_0x173b3f(0x21f)](_0x173b3f(0x282),_0x173b3f(0x24f));throw new common_1[(_0x173b3f(0x253))](_0x173b3f(0x295),common_1[_0x173b3f(0x26b)]['BAD_REQUEST']);}}async[_0x7bf388(0x2b9)](_0x267e26){const _0x3eb60f=_0x7bf388;common_1[_0x3eb60f(0x23a)]['debug'](_0x3eb60f(0x259),_0x3eb60f(0x24f));const _0x12aa53=Date[_0x3eb60f(0x25e)](),_0x3013e8=0x2710,_0x548050=0x7530,_0x11ba0e=await this[_0x3eb60f(0x21b)][_0x3eb60f(0x237)]([_0x3eb60f(0x216)])||0x249f0,_0x19c642=_0x11ba0e;let _0x49da47=0x0,_0x2cb92f=null,_0x3e4f6a=![];try{while(!_0x3e4f6a&&Date['now']()-_0x12aa53<_0x19c642){let _0x59d170;Date[_0x3eb60f(0x25e)]()-_0x12aa53<0x15f90?_0x59d170=_0x3013e8:_0x59d170=_0x548050;await this['sleep'](_0x59d170),common_1[_0x3eb60f(0x23a)]['debug'](_0x3eb60f(0x2d0)+(_0x49da47+0x1)+_0x3eb60f(0x2c3),_0x3eb60f(0x24f)),_0x2cb92f=await this[_0x3eb60f(0x246)](_0x267e26['randomDrawId']);if(_0x2cb92f){const {content:_0x1e12fb}=_0x2cb92f,_0x1d88e3=await this[_0x3eb60f(0x1fe)](_0x1e12fb);common_1['Logger'][_0x3eb60f(0x2ae)]('【绘制图片】第\x20'+(_0x49da47+0x1)+_0x3eb60f(0x23d)+_0x1d88e3+'%',_0x3eb60f(0x24f)),await this[_0x3eb60f(0x2cd)][_0x3eb60f(0x252)]({'id':_0x267e26['id']},{'progress':_0x1d88e3!==null&&_0x1d88e3!==void 0x0?_0x1d88e3:0x64});}_0x3e4f6a=_0x2cb92f&&!_0x2cb92f['edited_timestamp'],_0x49da47++;}if(!_0x2cb92f){await this['updateDrawStatus'](_0x267e26['id'],midjourney_constant_1['MidjourneyStatusEnum'][_0x3eb60f(0x2ca)]);throw new common_1['HttpException'](_0x3eb60f(0x24c),common_1['HttpStatus']['BAD_REQUEST']);}const _0x1b4d3c=Date['now']();return Object[_0x3eb60f(0x204)](Object[_0x3eb60f(0x204)]({},_0x2cb92f),{'durationSpent':Math[_0x3eb60f(0x29f)]((_0x1b4d3c-_0x12aa53)/0x3e8)});}catch(_0xca7c25){console[_0x3eb60f(0x274)]('获取图片列表结果失败:\x20',_0xca7c25);}}async[_0x7bf388(0x267)](_0x3a5edb){const _0x25ed44=_0x7bf388;common_1[_0x25ed44(0x23a)]['debug']('开始查询放大图片信息',_0x25ed44(0x24f));const _0xaed440=Date[_0x25ed44(0x25e)](),{message_id:_0xd44f71,custom_id:_0x3adddf,randomDrawId:_0x58f48e,orderId:_0x2b2e0b}=_0x3a5edb;let _0xfe3ff6=null,_0x860c27=0x0;while(!_0xfe3ff6&&_0x860c27<0xa){common_1['Logger']['debug'](_0x25ed44(0x217)+(_0x860c27+0x1)+'次',_0x25ed44(0x24f)),_0xfe3ff6=await this[_0x25ed44(0x1ea)](_0x58f48e,_0x2b2e0b),await new Promise(_0x271ff4=>setTimeout(_0x271ff4,Math['floor'](Math[_0x25ed44(0x1e4)]()*(0x1388-0xbb8+0x1))+0xbb8)),_0x860c27++;}if(!_0xfe3ff6){await this[_0x25ed44(0x29b)](_0x3a5edb['id'],midjourney_constant_1['MidjourneyStatusEnum']['DRAWTIMEOUT']);throw new common_1[(_0x25ed44(0x253))](_0x25ed44(0x283),common_1[_0x25ed44(0x26b)][_0x25ed44(0x223)]);}const _0x59ac01=Date['now']();return Object['assign'](Object['assign']({},_0xfe3ff6),{'durationSpent':Math['floor']((_0x59ac01-_0xaed440)/0x3e8)});}async[_0x7bf388(0x20d)](_0x283f48){const _0x1ae0bc=_0x7bf388;common_1[_0x1ae0bc(0x23a)]['debug'](_0x1ae0bc(0x214),_0x1ae0bc(0x24f));const _0x198a70=await this[_0x1ae0bc(0x21b)][_0x1ae0bc(0x237)]([_0x1ae0bc(0x216)])||0x249f0,_0x27220f=Date[_0x1ae0bc(0x25e)](),{message_id:_0xfc8fb,custom_id:_0x512a2b,randomDrawId:_0x474709,orderId:_0xc06418}=_0x283f48;let _0x1a4394=null,_0x5333a6=0x0,_0x21c419=0x0;while(!_0x1a4394&&_0x5333a6<_0x198a70){common_1[_0x1ae0bc(0x23a)][_0x1ae0bc(0x2ae)](_0x1ae0bc(0x288)+(_0x21c419+0x1)+'次','MidjourneyService'),_0x1a4394=await this['findCurrentReGenerateImgResult'](_0x474709,_0xfc8fb);const _0x468e0d=Math[_0x1ae0bc(0x29f)](Math[_0x1ae0bc(0x1e4)]()*(0x1388-0xbb8+0x1))+0x1f40;console[_0x1ae0bc(0x274)]('睡眠'+_0x468e0d+'秒'),await new Promise(_0x1cdf52=>setTimeout(_0x1cdf52,_0x468e0d)),_0x5333a6+=_0x468e0d,_0x21c419++;}if(!_0x1a4394){await this[_0x1ae0bc(0x29b)](_0x283f48['id'],midjourney_constant_1[_0x1ae0bc(0x2b7)]['DRAWTIMEOUT']);throw new common_1[(_0x1ae0bc(0x253))](_0x1ae0bc(0x2cb),common_1[_0x1ae0bc(0x26b)][_0x1ae0bc(0x223)]);}const _0x15e63a=Date[_0x1ae0bc(0x25e)]();return Object[_0x1ae0bc(0x204)](Object['assign']({},_0x1a4394),{'durationSpent':Math[_0x1ae0bc(0x29f)]((_0x15e63a-_0x27220f)/0x3e8)});}async[_0x7bf388(0x256)](_0x1fe83f){const _0x406741=_0x7bf388;common_1[_0x406741(0x23a)][_0x406741(0x2ae)](_0x406741(0x271),_0x406741(0x24f));const _0x5c0414=await this[_0x406741(0x21b)]['getConfigs']([_0x406741(0x216)])||0x249f0,_0x92a838=Date['now'](),{message_id:_0x1c84a5,custom_id:_0x3a25e3,randomDrawId:_0x39182c,orderId:_0x5badaf}=_0x1fe83f;let _0x572943=null,_0x7bbfbc=0x0,_0x260a31=0x0;while(!_0x572943&&_0x7bbfbc<_0x5c0414){common_1['Logger'][_0x406741(0x2ae)](_0x406741(0x1f0)+(_0x260a31+0x1)+'次','MidjourneyService'),_0x572943=await this[_0x406741(0x2a6)](_0x39182c,_0x1c84a5);const _0xfeec67=Math[_0x406741(0x29f)](Math['random']()*(0x1388-0xbb8+0x1))+0x1f40;await new Promise(_0x3f45e9=>setTimeout(_0x3f45e9,_0xfeec67)),_0x7bbfbc+=_0xfeec67,_0x260a31++;}if(!_0x572943){await this[_0x406741(0x29b)](_0x1fe83f['id'],midjourney_constant_1[_0x406741(0x2b7)][_0x406741(0x2ca)]);throw new common_1[(_0x406741(0x253))]('单张图片增强超时，请稍后再试！',common_1[_0x406741(0x26b)][_0x406741(0x223)]);}const _0x2a00db=Date[_0x406741(0x25e)]();return Object[_0x406741(0x204)](Object['assign']({},_0x572943),{'durationSpent':Math[_0x406741(0x29f)]((_0x2a00db-_0x92a838)/0x3e8)});}async[_0x7bf388(0x1e7)](_0x2dd81c){const _0x24591e=_0x7bf388;common_1[_0x24591e(0x23a)][_0x24591e(0x2ae)](_0x24591e(0x1e5),_0x24591e(0x24f));const _0x163821=await this[_0x24591e(0x21b)][_0x24591e(0x237)]([_0x24591e(0x216)])||0x249f0,_0x306793=Date[_0x24591e(0x25e)](),{message_id:_0xe45f27,custom_id:_0x51f72a,randomDrawId:_0xb8ca89,orderId:_0x4137b9}=_0x2dd81c;let _0x1ef07f=null,_0x366473=0x0,_0x2af002=0x0;while(!_0x1ef07f&&_0x366473<_0x163821){common_1[_0x24591e(0x23a)][_0x24591e(0x2ae)]('开始单张图片缩放第'+(_0x2af002+0x1)+'次',_0x24591e(0x24f)),_0x1ef07f=await this[_0x24591e(0x2bc)](_0xb8ca89,_0xe45f27);const _0x35f9f8=Math[_0x24591e(0x29f)](Math['random']()*(0x1388-0xbb8+0x1))+0x1f40;await new Promise(_0x19b3fd=>setTimeout(_0x19b3fd,_0x35f9f8)),_0x366473+=_0x35f9f8,_0x2af002++;}if(!_0x1ef07f){await this[_0x24591e(0x29b)](_0x2dd81c['id'],midjourney_constant_1[_0x24591e(0x2b7)][_0x24591e(0x2ca)]);throw new common_1[(_0x24591e(0x253))](_0x24591e(0x24e),common_1['HttpStatus']['BAD_REQUEST']);}const _0x157dba=Date[_0x24591e(0x25e)]();return Object[_0x24591e(0x204)](Object[_0x24591e(0x204)]({},_0x1ef07f),{'durationSpent':Math['floor']((_0x157dba-_0x306793)/0x3e8)});}async[_0x7bf388(0x235)](_0x37cb8a){const _0x332825=_0x7bf388;common_1[_0x332825(0x23a)][_0x332825(0x2ae)](_0x332825(0x215),_0x332825(0x24f));let _0x297883=null;const _0x2d57ef=Date['now']();while(!_0x297883){common_1[_0x332825(0x23a)]['debug']('变换图片获取中------>',_0x332825(0x24f)),_0x297883=await this[_0x332825(0x284)](_0x37cb8a['randomDrawId']);const _0x487ece=0x2710;await this[_0x332825(0x2c6)](_0x487ece);const _0x21c7ff=Date[_0x332825(0x25e)](),_0x57cb2a=Math[_0x332825(0x29f)](_0x21c7ff-_0x2d57ef),_0x2c2f51=await this['globalConfigService'][_0x332825(0x237)]([_0x332825(0x216)])||0x249f0,_0x30ae39=_0x2c2f51;if(_0x57cb2a>=_0x30ae39){await this[_0x332825(0x29b)](_0x37cb8a['id'],midjourney_constant_1['MidjourneyStatusEnum']['DRAWTIMEOUT']);throw new common_1[(_0x332825(0x253))](_0x332825(0x234),common_1['HttpStatus'][_0x332825(0x223)]);}}return Object[_0x332825(0x204)](Object[_0x332825(0x204)]({},_0x297883),{'durationSpent':Math[_0x332825(0x29f)](Date['now']()-_0x2d57ef)});}async['findCurrentEnlargeImgResult'](_0x1f9afe,_0x32a723){const _0x56b3bb=_0x7bf388,_0x2dca9f=await this[_0x56b3bb(0x2cf)](),_0x475347=await this[_0x56b3bb(0x268)](_0x1f9afe),_0x5e77e1=_0x2dca9f[_0x56b3bb(0x1fb)](_0x1169c8=>{const _0x34aea2=_0x56b3bb,{content:_0x4522fd}=_0x1169c8;if(!this['extractContent'](_0x4522fd))return![];const {prompt:_0x363806,order:_0x25711f}=this[_0x34aea2(0x2a5)](_0x4522fd);return _0x4522fd[_0x34aea2(0x227)](_0x1f9afe)&&_0x32a723===_0x25711f&&!_0x475347['includes'](_0x1169c8['id']);});return _0x5e77e1;}async[_0x7bf388(0x284)](_0x217ee5){const _0x1898c1=_0x7bf388,_0x150cc2=await this['getMessageList'](),_0x1c40f7=await this[_0x1898c1(0x268)](_0x217ee5),_0x5d18ac=_0x150cc2[_0x1898c1(0x1fb)](_0x3bf0d1=>{const _0x1b629c=_0x1898c1,{content:_0x534a4b}=_0x3bf0d1;return _0x534a4b[_0x1b629c(0x227)](_0x217ee5)&&!_0x1c40f7[_0x1b629c(0x227)](_0x3bf0d1['id'])&&this['isVariationsImage'](_0x534a4b);});if(_0x5d18ac){if(this['lockPrompt'][_0x1898c1(0x227)](_0x217ee5))return common_1[_0x1898c1(0x23a)][_0x1898c1(0x2ae)]('【变体图片】当前图片已经被锁定，等待同任务完成',_0x1898c1(0x24f)),null;else this[_0x1898c1(0x24a)][_0x1898c1(0x249)](_0x217ee5);}return _0x5d18ac;}async[_0x7bf388(0x26a)](_0x100e18,_0x2d9ec3){const _0x2ab1bc=_0x7bf388,_0x4c47df=await this[_0x2ab1bc(0x2cf)](),_0x4e587d=await this[_0x2ab1bc(0x268)](_0x100e18),_0x11fb91=_0x4c47df[_0x2ab1bc(0x1fb)](_0x48d59d=>{const _0x3c61de=_0x2ab1bc,{content:_0x2487e3}=_0x48d59d;return _0x2487e3['includes'](_0x100e18)&&!_0x4e587d['includes'](_0x48d59d['id'])&&_0x48d59d['id']!==_0x2d9ec3&&this[_0x3c61de(0x209)](_0x2487e3);});if(_0x11fb91){if(this[_0x2ab1bc(0x24a)][_0x2ab1bc(0x227)](_0x100e18))return common_1[_0x2ab1bc(0x23a)][_0x2ab1bc(0x2ae)](_0x2ab1bc(0x1f6),_0x2ab1bc(0x24f)),null;else this[_0x2ab1bc(0x24a)][_0x2ab1bc(0x249)](_0x100e18);}return _0x11fb91;}async['findCurrentZoomImgResult'](_0x1bb32b,_0x135369){const _0x5dd86a=_0x7bf388,_0x13694f=await this['getMessageList'](),_0xd65dce=await this[_0x5dd86a(0x268)](_0x1bb32b),_0x3c0811=_0x13694f[_0x5dd86a(0x1fb)](_0xeba630=>{const _0x4ee185=_0x5dd86a,{content:_0x11f175}=_0xeba630;return _0x11f175['includes'](_0x1bb32b)&&!_0xd65dce[_0x4ee185(0x227)](_0xeba630['id'])&&_0xeba630['id']!==_0x135369&&this[_0x4ee185(0x229)](_0x11f175);});if(_0x3c0811){if(this[_0x5dd86a(0x24a)][_0x5dd86a(0x227)](_0x1bb32b))return common_1[_0x5dd86a(0x23a)][_0x5dd86a(0x2ae)]('【重新生成图片】当前图片已经被锁定，等待同任务完成',_0x5dd86a(0x24f)),null;else this['lockPrompt']['push'](_0x1bb32b);}return _0x3c0811;}async[_0x7bf388(0x2a6)](_0x40aa79,_0x27e105){const _0x25bebd=_0x7bf388,_0x179f91=await this['getMessageList'](),_0x28c43b=await this[_0x25bebd(0x268)](_0x40aa79),_0x5706ed=_0x179f91[_0x25bebd(0x1fb)](_0xfb025a=>{const _0x4460ec=_0x25bebd,{content:_0x1ce2e8}=_0xfb025a;return _0x1ce2e8[_0x4460ec(0x227)](_0x40aa79)&&!_0x28c43b[_0x4460ec(0x227)](_0xfb025a['id'])&&_0xfb025a['id']!==_0x27e105&&this[_0x4460ec(0x2a0)](_0x1ce2e8);});if(_0x5706ed){if(this['lockPrompt'][_0x25bebd(0x227)](_0x40aa79))return common_1[_0x25bebd(0x23a)][_0x25bebd(0x2ae)]('【单张图片增强】当前图片已经被锁定，等待同任务完成',_0x25bebd(0x24f)),null;else this[_0x25bebd(0x24a)]['push'](_0x40aa79);}return _0x5706ed;}['extractContent'](_0x47eb0a){const _0x43e8fd=_0x7bf388,_0x1cd9ef=_0x47eb0a[_0x43e8fd(0x23c)](/\*\*(.+?)\*\*/),_0x25c726=_0x47eb0a[_0x43e8fd(0x23c)](/- Image #(\d+)/);if(!_0x1cd9ef||!_0x25c726)return null;const _0x42853a=_0x1cd9ef[0x1],_0x76d280=parseInt(_0x25c726[0x1]);return{'prompt':_0x42853a,'order':_0x76d280};}async[_0x7bf388(0x246)](_0x2f24d4){const _0x38c2fa=_0x7bf388,_0xf16cfb=await this[_0x38c2fa(0x268)](_0x2f24d4),_0x2de9b9=await this['getMessageList']();if(!_0x2de9b9||!_0x2de9b9[_0x38c2fa(0x289)])return;const _0x576a7e=_0x2de9b9[_0x38c2fa(0x1fb)](_0x595846=>{const _0x8d2cd3=_0x38c2fa,{attachments:attachments=[],content:_0x15a710,edited_timestamp:_0x691c03}=_0x595846;return _0x15a710[_0x8d2cd3(0x227)](_0x2f24d4)&&attachments['length']>0x0&&!_0xf16cfb[_0x8d2cd3(0x227)](_0x595846===null||_0x595846===void 0x0?void 0x0:_0x595846['id']);});return _0x576a7e||null;}[_0x7bf388(0x285)](_0x5b3176){const _0x2ac1fb=_0x7bf388,_0x46c6f7=/- Variations/;return _0x46c6f7[_0x2ac1fb(0x221)](_0x5b3176);}[_0x7bf388(0x23b)](_0x236744){const _0x103b3c=/Image #\d+/;return _0x103b3c['test'](_0x236744);}[_0x7bf388(0x209)](_0x1af3a3){const _0x4db4f0=_0x7bf388;return!this['isVariationsImage'](_0x1af3a3)&&!this[_0x4db4f0(0x23b)](_0x1af3a3);}[_0x7bf388(0x2a0)](_0x3f459f){const _0x2e177e=_0x7bf388,_0x2d4f98=/- Variations \(.*?\)/;return _0x2d4f98[_0x2e177e(0x221)](_0x3f459f);}[_0x7bf388(0x229)](_0xf77ccf){const _0x25b777=_0x7bf388,_0x250dcc=/- Zoom Out/;return _0x250dcc[_0x25b777(0x221)](_0xf77ccf);}async[_0x7bf388(0x2c2)](){const _0x50d76e=_0x7bf388,_0x35b70c=await this['globalConfigService'][_0x50d76e(0x237)]([_0x50d76e(0x240),'mjApplicationId',_0x50d76e(0x29e),_0x50d76e(0x270),_0x50d76e(0x2a7),'mjVersion',_0x50d76e(0x1fc),_0x50d76e(0x1ef),_0x50d76e(0x2b8)]),_0x20878a={'application_id':_0x35b70c[_0x50d76e(0x281)],'guild_id':_0x35b70c['mjGuildId'],'channel_id':_0x35b70c['mjChannelId'],'session_id':_0x35b70c[_0x50d76e(0x2a7)],'version':_0x35b70c[_0x50d76e(0x286)],'id':_0x35b70c[_0x50d76e(0x240)],'authorization':_0x35b70c[_0x50d76e(0x1fc)],'mjRateLimit':_0x35b70c['mjRateLimit'],'mjProxy':_0x35b70c['mjProxy']||0x0};return _0x20878a;}async[_0x7bf388(0x2cf)](){const _0x5e9408=_0x7bf388;try{const {application_id:_0x188611,guild_id:_0x383225,channel_id:_0x379246,session_id:_0x47a6eb,version:_0x5567c1,id:_0xb03721,authorization:_0xd08f48,mjProxy:_0x547d68}=await this['getMjDefaultParams'](),_0x4ed085=await this[_0x5e9408(0x21b)][_0x5e9408(0x237)]([_0x5e9408(0x23f)])||_0x5e9408(0x20a),_0x100b59=_0x547d68==0x1?_0x4ed085+_0x5e9408(0x260)+_0x379246:_0x5e9408(0x1fd)+_0x379246+_0x5e9408(0x230),_0x386ccf={'authorization':_0xd08f48},_0x29a64a=await axios_1[_0x5e9408(0x1f3)][_0x5e9408(0x276)](_0x100b59,{'headers':_0x386ccf});return _0x29a64a[_0x5e9408(0x299)];}catch(_0x2d52df){return common_1[_0x5e9408(0x23a)][_0x5e9408(0x21f)](_0x5e9408(0x29d),_0x2d52df,_0x5e9408(0x24f)),[];}}['parseProgress'](_0x6a41){const _0x321ff5=_0x7bf388,_0x3a7f11=/\((\d+)%\)/,_0x430298=_0x6a41[_0x321ff5(0x23c)](_0x3a7f11);return _0x430298?parseInt(_0x430298[0x1],0xa):null;}[_0x7bf388(0x241)](_0x59fd87){const _0x34b8bd=_0x7bf388,_0x5c1acf=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x59fd87[_0x34b8bd(0x242)](_0x5c1acf,'');}async['bindJobId'](_0x456426,_0x4034d5){const _0x2ff120=_0x7bf388;await this[_0x2ff120(0x2cd)]['update']({'id':_0x456426},{'jobId':_0x4034d5});}async[_0x7bf388(0x22c)](_0x597998,_0x7ffc4){const _0x5d2f80=_0x7bf388;try{const {page:page=0x1,size:size=0x1e}=_0x7ffc4,[_0x8df149,_0x453fbb]=await this['midjourneyEntity'][_0x5d2f80(0x20e)]({'where':{'userId':_0x597998['user']['id'],'isDelete':0x0},'order':{'id':_0x5d2f80(0x292)},'take':size,'skip':(page-0x1)*size});_0x8df149['forEach'](_0x578caf=>{const _0x560a90=_0x5d2f80;var _0x3a7261,_0x3ff7b4;const {extend:_0x191e83}=_0x578caf;_0x578caf[_0x560a90(0x277)]=this['formatFileInfo'](_0x578caf[_0x560a90(0x277)]),_0x578caf[_0x560a90(0x2b4)]=((_0x3ff7b4=(_0x3a7261=JSON[_0x560a90(0x23e)](_0x191e83))===null||_0x3a7261===void 0x0?void 0x0:_0x3a7261['components'][0x0])===null||_0x3ff7b4===void 0x0?void 0x0:_0x3ff7b4[_0x560a90(0x2a4)][_0x560a90(0x289)])===0x5;});const _0x538e0a=await this['midjourneyEntity'][_0x5d2f80(0x2c9)]({'where':{'isDelete':0x0,'status':(0x0,typeorm_2['In'])([0x1,0x2])}}),_0x96cfdb={'rows':(0x0,utils_1[_0x5d2f80(0x2c8)])(_0x8df149),'count':_0x453fbb,'countQueue':_0x538e0a};return _0x96cfdb;}catch(_0x5e0e91){throw new common_1['HttpException'](_0x5d2f80(0x222),common_1[_0x5d2f80(0x26b)][_0x5d2f80(0x223)]);}}['formatFileInfo'](_0x453ce3){const _0x5ca376=_0x7bf388;if(!_0x453ce3)return{};const _0x2555c8=JSON[_0x5ca376(0x23e)](_0x453ce3),{url:_0x59d421,filename:_0x305c39,size:_0x5d556a,cosUrl:_0x281150,width:_0x587224,height:_0x2e0146}=_0x2555c8,_0x5782fd=0x136,_0x48bec1=_0x281150[_0x5ca376(0x227)](_0x5ca376(0x206))?_0x5ca376(0x28b):_0x281150[_0x5ca376(0x227)](_0x5ca376(0x2a9))?_0x5ca376(0x251):_0x5ca376(0x22e);let _0xa5d54d,_0x413b45;if(_0x48bec1===_0x5ca376(0x28b)){const _0xed9a42=_0x587224/_0x2e0146,_0xac793f=Math[_0x5ca376(0x22d)](_0x5782fd/_0xed9a42);_0x413b45=_0x281150+('?imageView2/1/w/'+_0x5782fd+'/h/'+_0xac793f+_0x5ca376(0x24b));}if(_0x48bec1===_0x5ca376(0x251)){const _0x22ec4b=_0x2e0146/_0x587224,_0x2928ac=Math['round'](_0x5782fd/_0x22ec4b);_0x413b45=_0x281150+(_0x5ca376(0x20b)+_0x2928ac);}return _0x48bec1==='chevereto'&&(_0x413b45=_0x281150[_0x5ca376(0x242)](/\.png$/,_0x5ca376(0x208))),_0x2555c8[_0x5ca376(0x26d)]=_0x413b45,_0x2555c8;}async[_0x7bf388(0x200)](_0x2d6afb,_0x364a67,_0x1c310c){const _0x10b3b8=_0x7bf388,_0x2f3af0=await this[_0x10b3b8(0x2cd)][_0x10b3b8(0x26e)]({'where':{'id':_0x364a67}});if(!_0x2f3af0)throw new common_1[(_0x10b3b8(0x253))]('当前绘画信息不存在！',common_1[_0x10b3b8(0x26b)][_0x10b3b8(0x223)]);const {extend:_0x15d254,message_id:_0x36f6d2,prompt:_0x132a11,imgUrl:_0x337c75,extraParam:_0x46bc15,randomDrawId:_0x14dd69}=_0x2f3af0,_0x4e7752=JSON['parse'](_0x15d254),{components:components=[]}=_0x4e7752;if(!components['length'])throw new common_1['HttpException'](_0x10b3b8(0x1ed),common_1[_0x10b3b8(0x26b)][_0x10b3b8(0x223)]);let _0x5ce205={};_0x2d6afb===midjourney_constant_1[_0x10b3b8(0x266)]['UPSCALE']&&(_0x5ce205=components[0x0][_0x10b3b8(0x2a4)][_0x1c310c-0x1]);_0x2d6afb===midjourney_constant_1[_0x10b3b8(0x266)]['VARIATION']&&(_0x5ce205=components[0x1]['components'][_0x1c310c-0x1]);_0x2d6afb===midjourney_constant_1[_0x10b3b8(0x266)][_0x10b3b8(0x24d)]&&(_0x5ce205=components[0x0]['components'][_0x1c310c-0x1]);_0x2d6afb===midjourney_constant_1[_0x10b3b8(0x266)][_0x10b3b8(0x1f2)]&&(_0x5ce205=components[0x0][_0x10b3b8(0x2a4)][_0x1c310c-0x1]);_0x2d6afb===midjourney_constant_1[_0x10b3b8(0x266)][_0x10b3b8(0x1e8)]&&(_0x5ce205=components[0x1]['components'][_0x1c310c-0x1]);const {custom_id:_0x18bbf5}=_0x5ce205;return{'custom_id':_0x18bbf5,'message_id':_0x36f6d2,'prompt':_0x132a11,'imgUrl':_0x337c75,'extraParam':_0x46bc15,'randomDrawId':_0x14dd69};}async[_0x7bf388(0x2bf)](_0x1db8a5){const _0x18e871=_0x7bf388,_0x38ad16=await this[_0x18e871(0x2cd)]['count']({'where':{'custom_id':_0x1db8a5,'status':midjourney_constant_1[_0x18e871(0x2b7)][_0x18e871(0x207)]}});if(_0x38ad16>0x0)throw new common_1[(_0x18e871(0x253))](_0x18e871(0x25a),common_1[_0x18e871(0x26b)][_0x18e871(0x223)]);}async[_0x7bf388(0x25b)](_0x16bd06,_0x34c8d3){const _0x1c7e80=_0x7bf388,_0x14fe30=await this[_0x1c7e80(0x2cd)][_0x1c7e80(0x26e)]({'where':{'id':_0x16bd06,'userId':_0x34c8d3['user']['id'],'isDelete':0x0}});if(!_0x14fe30)throw new common_1[(_0x1c7e80(0x253))](_0x1c7e80(0x28d),common_1[_0x1c7e80(0x26b)][_0x1c7e80(0x223)]);if(_0x14fe30['status']===0x2)throw new common_1[(_0x1c7e80(0x253))](_0x1c7e80(0x232),common_1['HttpStatus'][_0x1c7e80(0x223)]);const _0x206a85=await this['midjourneyEntity'][_0x1c7e80(0x252)]({'id':_0x16bd06},{'isDelete':0x1});if(_0x206a85[_0x1c7e80(0x273)]>0x0)return _0x1c7e80(0x2c5);else throw new common_1[(_0x1c7e80(0x253))](_0x1c7e80(0x250),common_1[_0x1c7e80(0x26b)]['BAD_REQUEST']);}async[_0x7bf388(0x248)](_0x4f50d4){const _0x3fab7b=_0x7bf388,{role:_0x5487e0,id:_0x4e00a9}=_0x4f50d4[_0x3fab7b(0x1f9)];if([_0x3fab7b(0x25d),_0x3fab7b(0x2ac)][_0x3fab7b(0x227)](_0x5487e0))return;const _0x5ac34d=await this[_0x3fab7b(0x2cd)][_0x3fab7b(0x2c9)]({'where':{'userId':_0x4e00a9,'isDelete':0x0,'status':(0x0,typeorm_2['In'])([0x1,0x2])}});if(_0x5ac34d>=0x2)throw new common_1['HttpException']('当前管理员限制单用户同时最多能执行两个任务！',common_1[_0x3fab7b(0x26b)][_0x3fab7b(0x223)]);}async[_0x7bf388(0x22b)](_0x192ed5){const _0x1c3458=_0x7bf388,{id:_0x148b8f,userId:_0x2ffd54,action:_0x50bf58}=_0x192ed5,_0xa6d9fb=_0x50bf58===0x2?0x1:0x4;await this[_0x1c3458(0x254)][_0x1c3458(0x28c)](_0x2ffd54,_0xa6d9fb),await this['midjourneyEntity'][_0x1c3458(0x252)]({'id':_0x148b8f},{'status':0x4});}async[_0x7bf388(0x290)](_0x5dd53c){const _0x29b50c=_0x7bf388,{page:page=0x1,size:size=0x14,rec:_0x4626e8,userId:_0x2ec6d8,status:_0x573c33}=_0x5dd53c;if(Number(size)===0x3e7){const _0x40d131=await this['redisCacheService']['get']({'key':_0x29b50c(0x233)});if(_0x40d131)return JSON[_0x29b50c(0x23e)](_0x40d131);}const _0x415eb0={'isDelete':0x0};_0x4626e8&&Object[_0x29b50c(0x204)](_0x415eb0,{'rec':_0x4626e8}),_0x2ec6d8&&Object[_0x29b50c(0x204)](_0x415eb0,{'userId':_0x2ec6d8}),_0x573c33&&Object['assign'](_0x415eb0,{'status':_0x573c33});const [_0x1fee08,_0x49b1d2]=await this[_0x29b50c(0x2cd)][_0x29b50c(0x20e)]({'where':_0x415eb0,'order':{'id':_0x29b50c(0x292)},'take':size,'skip':(page-0x1)*size,'select':[_0x29b50c(0x277),_0x29b50c(0x22a),_0x29b50c(0x210),_0x29b50c(0x2b5),'id',_0x29b50c(0x22a),_0x29b50c(0x261),_0x29b50c(0x2be)]});_0x1fee08[_0x29b50c(0x27c)](_0x3e9def=>{const _0x4101df=_0x29b50c;var _0x328671,_0x446b4d;const {extend:_0x57bd7b}=_0x3e9def;_0x3e9def[_0x4101df(0x277)]=this[_0x4101df(0x2b3)](_0x3e9def[_0x4101df(0x277)]),_0x3e9def[_0x4101df(0x2b4)]=((_0x446b4d=(_0x328671=JSON['parse'](_0x57bd7b))===null||_0x328671===void 0x0?void 0x0:_0x328671['components'][0x0])===null||_0x446b4d===void 0x0?void 0x0:_0x446b4d[_0x4101df(0x2a4)]['length'])===0x5;});if(Number(size)===0x3e7){const _0x797d8={'rows':_0x1fee08[_0x29b50c(0x220)](_0x1a4943=>{const {fileInfo:_0x7470bc,prompt:_0x334328,createdAt:_0x110393,id:_0xd4631a,fullPrompt:_0x58109a,rec:_0x5da2f2}=_0x1a4943;return{'fileInfo':_0x7470bc,'prompt':_0x334328,'createdAt':_0x110393,'id':_0xd4631a,'fullPrompt':_0x58109a,'rec':_0x5da2f2};}),'count':_0x49b1d2};return await this[_0x29b50c(0x28e)]['set']({'key':_0x29b50c(0x233),'val':JSON['stringify'](_0x797d8)},0x3c*0x5),_0x797d8;}const _0x44df87={'rows':_0x1fee08,'count':_0x49b1d2};return _0x44df87;}async['getAdminDrawList'](_0x58121e,_0x33f565){const _0x5e1228=_0x7bf388,{page:page=0x1,size:size=0xa,rec:_0x792a73,userId:_0x4e2cb2,status:_0x11d8d2}=_0x33f565,_0x4475b6={'isDelete':0x0};_0x792a73&&Object[_0x5e1228(0x204)](_0x4475b6,{'rec':_0x792a73}),_0x4e2cb2&&Object[_0x5e1228(0x204)](_0x4475b6,{'userId':_0x4e2cb2}),_0x11d8d2&&Object[_0x5e1228(0x204)](_0x4475b6,{'status':_0x11d8d2});const [_0xfe4614,_0x56ad33]=await this[_0x5e1228(0x2cd)][_0x5e1228(0x20e)]({'where':_0x4475b6,'order':{'id':_0x5e1228(0x292)},'take':size,'skip':(page-0x1)*size}),_0x3e8379=_0xfe4614[_0x5e1228(0x220)](_0x22cfeb=>_0x22cfeb[_0x5e1228(0x27a)]),_0x562a0b=await this[_0x5e1228(0x279)][_0x5e1228(0x1fb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x3e8379)},'select':['id',_0x5e1228(0x1f1),_0x5e1228(0x1eb),_0x5e1228(0x213)]});return _0xfe4614[_0x5e1228(0x27c)](_0x57d418=>{const _0xd05185=_0x5e1228;_0x57d418['userInfo']=_0x562a0b[_0xd05185(0x1fb)](_0x4f97de=>_0x4f97de['id']===_0x57d418['userId']);}),_0xfe4614[_0x5e1228(0x27c)](_0x92dc8d=>{const _0x24cd44=_0x5e1228;var _0x53a64e,_0x1f0713;const {extend:_0xaadb90}=_0x92dc8d;_0x92dc8d[_0x24cd44(0x277)]=this[_0x24cd44(0x2b3)](_0x92dc8d[_0x24cd44(0x277)]),_0x92dc8d[_0x24cd44(0x2b4)]=((_0x1f0713=(_0x53a64e=JSON[_0x24cd44(0x23e)](_0xaadb90))===null||_0x53a64e===void 0x0?void 0x0:_0x53a64e[_0x24cd44(0x2a4)][0x0])===null||_0x1f0713===void 0x0?void 0x0:_0x1f0713['components'][_0x24cd44(0x289)])===0x5;}),_0x58121e['user'][_0x5e1228(0x294)]!==_0x5e1228(0x25d)&&_0xfe4614[_0x5e1228(0x27c)](_0x59bcd2=>{const _0xffd9c9=_0x5e1228;_0x59bcd2[_0xffd9c9(0x2b2)][_0xffd9c9(0x213)]=_0x59bcd2[_0xffd9c9(0x2b2)][_0xffd9c9(0x213)][_0xffd9c9(0x242)](/(.{2}).+(.{2}@.+)/,_0xffd9c9(0x238));}),{'rows':_0xfe4614,'count':_0x56ad33};}async[_0x7bf388(0x212)](_0x18ce5c){const _0xaac5f3=_0x7bf388,{id:_0x8d643f}=_0x18ce5c,_0x53cc19=await this[_0xaac5f3(0x2cd)][_0xaac5f3(0x26e)]({'where':{'id':_0x8d643f,'status':0x3,'isDelete':0x0}});if(!_0x53cc19)throw new common_1[(_0xaac5f3(0x253))](_0xaac5f3(0x28d),common_1['HttpStatus'][_0xaac5f3(0x223)]);const {rec:_0x16949c}=_0x53cc19,_0x215eff=await this[_0xaac5f3(0x2cd)]['update']({'id':_0x8d643f},{'rec':_0x16949c===0x1?0x0:0x1});if(_0x215eff[_0xaac5f3(0x273)]>0x0)return await this[_0xaac5f3(0x28e)][_0xaac5f3(0x22f)]({'key':'midjourney:getList'}),'操作成功！';}async['cleanQueue'](){const _0x16d7bf=_0x7bf388;try{await this[_0x16d7bf(0x2cd)][_0x16d7bf(0x252)]({'status':0x2},{'status':0x4});}catch(_0x3a327a){console['log'](_0x16d7bf(0x291),_0x3a327a);}}async[_0x7bf388(0x263)](_0x3c0933,_0x2cde3f){const _0x41ab50=_0x7bf388,{id:_0x1f5227}=_0x2cde3f;if(!_0x1f5227)throw new common_1[(_0x41ab50(0x253))](_0x41ab50(0x29c),common_1[_0x41ab50(0x26b)]['BAD_REQUEST']);const _0x8bb2fd=await this['midjourneyEntity']['delete']({'id':_0x1f5227});if(_0x8bb2fd[_0x41ab50(0x273)]>0x0)return _0x41ab50(0x1f5);else throw new common_1[(_0x41ab50(0x253))]('删除记录失败！',common_1[_0x41ab50(0x26b)][_0x41ab50(0x223)]);}};function _0x54b1(){const _0x1a4190=['已经成功发送单张图片缩放指令','/mj/list?channel_id=','fullPrompt','发送放大变幻指令失败','delLog','发送重新生成指令失败:\x20','Repository','MidjourneyActionEnum','pollComparisonResultUpscale','getHistroyMessageIds','sendSmInteractions','findCurrentReGenerateImgResult','HttpStatus','GlobalConfigService','thumbImg','findOne','sendReGenerateInteractions','mjChannelId','开始查询单张图片增强的图片信息','updateDrawData','affected','log','__esModule','get','fileInfo','uploadFileFromUrl','userEntity','userId','./../user/user.entity','forEach','发送对单张图片增强指令失败:\x20','decorate','您的绘画描述词中含有不合规信息、请检查后重新提交！','getUploadType','mjApplicationId','发送单张图片增强指令失败','放大图片超时，请稍后再试！','findCurrentVariationImgResult','isVariationsImage','mjVersion','DRAW','开始比对重新绘制图片第','length','../../common/utils','tencent','refundMjBalance','当前图片不存在！','redisCacheService','DRAWING','getList','TODO->error:\x20','DESC','85720WggWSr','role','对图片单张增强失败...','addDrawQueue','filter','BadwordsService','data','2097858TwMEhv','updateDrawStatus','非法操作！','查询绘制结果失败:\x20getMessageList','mjGuildId','floor','isVaryImage','../redisCache/redisCache.service','已经成功发送了重新生成图片指令','sendVaryInteractions','components','extractContent','findCurrentVaryImgResult','mjSessionId','axios','oss','badwordsService','sendDrawCommand','admin','RedisCacheService','debug','186URPuZO','function','@nestjs/common','userInfo','formatFileInfo','isGroup','createdAt','@nestjs/typeorm','MidjourneyStatusEnum','mjProxy','pollComparisonResultDraw','------>\x20开始上传图片！！！','对图片放大变幻失败...','findCurrentZoomImgResult','67272AdPERG','rec','checkIsUpscale','post','checkBadWords','getMjDefaultParams','\x20次开始查询','2233HDqHaS','删除成功！','sleep','430328ADJkRg','formatCreateOrUpdateDate','count','DRAWTIMEOUT','重新绘制图片超时，请稍后再试！','../upload/upload.service','midjourneyEntity','imagine','getMessageList','【绘制图片】第\x20','VARIATION','random','开始查询单张图片缩放的图片信息','../../common/constants/midjourney.constant','pollComparisonResultZoom','ZOOM','typeorm','findCurrentEnlargeImgResult','avatar','发送放大变幻指令失败:\x20','当前图片没有绘画信息、无法放大!','__param','mjRateLimit','开始单张图片增强第','username','VARY','default','draw','删除记录成功！','【重新生成图片】当前图片已经被锁定，等待同任务完成','UPSCALE','UploadService','user','__metadata','find','mjAuthorization','https://discord.com/api/v9/channels/','parseProgress','stringify','getDrawActionDetail','__decorate','本次绘图指令为','bindJobId','assign','getOwnPropertyDescriptor','cos','DRAWED','.md.png','isReGenerateImage','http://172.247.48.137:8000','?x-oss-process=image/resize,w_','./midjourney.entity','pollComparisonResultReGenerate','findAndCount','randomDrawId','prompt','uploadService','recDraw','email','开始查询重复绘制的图片信息','开始轮询单张变换图片结果','mjTimeoutMs','开始比对放大图片第','209153XbFIEt','发送绘图指令失败、请联系管理员检测绘画配置！','InjectRepository','globalConfigService','TODO->存储图片失败','message_id','/mj/draw','error','map','test','获取我得绘制列表失败','BAD_REQUEST','MidjourneyEntity','已经成功发送了图片变化指令','UserEntity','includes','发送绘画指令失败','isZoomImage','extend','drawFailed','getDrawList','round','chevereto','del','/messages?limit=50','18IhUDvf','绘制中的图片任务、禁止删除！','midjourney:getList','变换当前图片超时！','pollComparisonResultVariation','已经成功发送了图片放大指令','getConfigs','$1****$2','564632fvoLNQ','Logger','isSingleImage','match','\x20次、\x20当前绘画进度为','parse','mjProxyUrl','mjId','removeEmoji','replace','object','metadata','sendZoomInteractions','findCurrentPromptResult','15fzATIR','checkLimit','push','lockPrompt','/q/55','绘画超时，请稍后再试！','REGENERATE','单张图片缩放超时，请稍后再试！','MidjourneyService','删除失败！','ali','update','HttpException','userBalanceService','getTime','pollComparisonResultVary','../userBalance/userBalance.service','https://discord.com/api/v9/interactions','开始查询绘画结果','当前图片已经放大过了！','deleteDraw','1697134lbcVQS','super','now'];_0x54b1=function(){return _0x1a4190;};return _0x54b1();}MidjourneyService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x7bf388(0x21a)])(midjourney_entity_1[_0x7bf388(0x224)])),__param(0x1,(0x0,typeorm_1[_0x7bf388(0x21a)])(user_entity_1[_0x7bf388(0x226)])),__metadata('design:paramtypes',[typeorm_2['Repository'],typeorm_2[_0x7bf388(0x265)],globalConfig_service_1[_0x7bf388(0x26c)],upload_service_1[_0x7bf388(0x1f8)],badwords_service_1[_0x7bf388(0x298)],userBalance_service_1['UserBalanceService'],redisCache_service_1[_0x7bf388(0x2ad)]])],MidjourneyService),exports[_0x7bf388(0x24f)]=MidjourneyService;